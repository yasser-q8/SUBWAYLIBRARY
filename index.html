<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مكتبة صب واي</title>
    <style>
        /* نظام الألوان */
        :root {
            --primary-orange: #FF9800;
            --neon-green: #39FF14;
            --light-blue: #E3F2FD;
            --dark-blue: #1976D2;
            --dark-gray: #333;
            --light-gray: #f5f5f5;
            --white: #FFFFFF;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--light-blue);
            color: var(--dark-gray);
            height: 100vh;
            overflow: hidden;
        }

        /* شاشة الدخول */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--dark-blue) 100%);
        }

        .login-box {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 400px;
            padding: 40px;
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            object-fit: contain;
        }

        .login-title {
            color: var(--dark-blue);
            margin-bottom: 30px;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-title img {
            width: 90px;
            height: 90px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-gray);
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            border-color: var(--primary-orange);
            outline: none;
        }

        .login-btn {
            background-color: var(--primary-orange);
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-btn:hover {
            background-color: #e68900;
        }

        /* الشاشة الرئيسية */
        .main-container {
            display: none;
            height: 100vh;
        }

        .header {
            background-color: var(--dark-blue);
            color: white;
            padding: 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 75px;
        }

        .store-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .store-logo {
            width: 56px;
            height: 56px;
            object-fit: contain;
        }

        .store-name {
            font-size: 33px;
            font-weight: bold;
            color: var(--neon-green);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
        }

        .content-container {
            display: flex;
            height: calc(100vh - 75px);
        }

        /* القائمة الجانبية */
        .sidebar {
            width: 200px;
            background-color: white;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--dark-blue);
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid var(--primary-orange);
            padding-bottom: 8px;
            font-size: 16px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark-gray);
            font-size: 14px;
        }

        .menu-item:hover {
            background-color: var(--light-blue);
            color: var(--dark-blue);
        }

        .menu-item.active {
            background-color: var(--primary-orange);
            color: white;
        }

        .menu-item i {
            margin-left: 8px;
            font-size: 16px;
        }

        /* محتوى الشاشات */
        .content-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--light-gray);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* شاشة البيع - تصميم مضغوط */
        .pos-container {
            display: flex;
            gap: 12px;
            height: 100%;
        }

        .categories-panel {
            width: 180px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .categories-header {
            margin-bottom: 12px;
        }

        .category-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .category-btn {
            display: block;
            width: 100%;
            padding: 10px 6px;
            margin-bottom: 6px;
            background-color: var(--light-blue);
            border: 2px solid var(--dark-blue);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 16px;
            line-height: 1.2;
        }

        .category-btn:hover {
            background-color: var(--dark-blue);
            color: white;
        }

        .category-btn.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .products-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .products-grid {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 5px;
        }

        .product-card {
            background: var(--light-gray);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-orange);
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-blue);
            font-size: 13px;
            line-height: 1.3;
            height: 34px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-price {
            color: var(--success);
            font-weight: bold;
            font-size: 14px;
            margin: 5px 0;
        }

        .product-stock {
            color: var(--dark-gray);
            font-size: 11px;
            margin-bottom: 8px;
        }

        .cart-panel {
            width: 340px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
            max-height: 200px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 6px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }

        .cart-item:hover {
            background-color: var(--light-gray);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .cart-item-price {
            color: var(--success);
            font-weight: bold;
            font-size: 12px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cart-total-section {
            background-color: var(--light-blue);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .discount-input {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            align-items: center;
        }

        .discount-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .discount-type {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .discount-btn {
            flex: 1;
            padding: 6px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .discount-btn.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .cart-total {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            color: var(--dark-blue);
            padding-top: 6px;
            border-top: 2px solid var(--dark-blue);
        }

        .payment-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .payment-method {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }

        .payment-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 13px;
        }

        .payment-btn.active {
            border-color: var(--primary-orange);
            background-color: var(--primary-orange);
            color: white;
        }

        .payment-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 13px;
        }

        /* عناصر عامة */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-primary {
            background-color: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e68900;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: black;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* المودالات */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 550px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 6px;
        }

        .modal-title {
            color: var(--dark-blue);
            font-size: 18px;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--danger);
        }

        /* فاتورة المبيعات */
        .receipt {
            font-family: 'Courier New', monospace;
            line-height: 1.4;
            text-align: center;
        }

        .receipt-header {
            margin-bottom: 12px;
        }

        .receipt-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 6px;
            display: block;
        }

        .receipt-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark-blue);
            margin-bottom: 4px;
        }

        .receipt-details {
            margin-bottom: 12px;
            text-align: right;
            background-color: var(--light-gray);
            padding: 10px;
            border-radius: 4px;
        }

        .receipt-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .receipt-items th {
            background-color: var(--dark-blue);
            color: white;
            padding: 6px;
            border-bottom: 2px solid var(--primary-orange);
            font-size: 12px;
        }

        .receipt-items td {
            padding: 6px;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
        }

        .receipt-totals {
            text-align: right;
            background-color: var(--light-blue);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .receipt-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px dashed var(--dark-gray);
            text-align: center;
            font-size: 12px;
        }

        /* شاشة المشتريات */
        .purchases-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .section-title {
            font-size: 18px;
            color: var(--dark-blue);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .tab {
            padding: 8px 15px;
            background: var(--light-gray);
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }

        .tab.active {
            background: var(--dark-blue);
            color: white;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--dark-gray);
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 150px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px;
            text-align: right;
            font-size: 13px;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .data-table tr:hover {
            background-color: var(--light-blue);
        }

        .actions-cell {
            display: flex;
            gap: 5px;
        }

        .form-modal {
            max-width: 700px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group.small {
            min-width: 100px;
            flex: 0.5;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
            color: var(--dark-gray);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-orange);
            outline: none;
        }

        .suppliers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .supplier-card {
            background: var(--light-gray);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.3s;
        }

        .supplier-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-orange);
        }

        .supplier-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--dark-blue);
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .supplier-info {
            font-size: 13px;
            margin-bottom: 5px;
        }

        .supplier-info strong {
            color: var(--dark-gray);
        }

        /* البحث الديناميكي */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .search-result-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .search-result-item:hover {
            background-color: var(--light-blue);
        }

        /* معلومات المنتج التلقائية */
        .product-info {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            font-size: 11px;
            color: var(--dark-gray);
        }

        .product-info span {
            padding: 3px 6px;
            background: var(--light-gray);
            border-radius: 3px;
        }

        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 1200px) {
            .pos-container {
                flex-direction: column;
            }
            
            .categories-panel,
            .products-panel,
            .cart-panel {
                width: 100%;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }
        }

        /* طباعة */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .modal-content {
                box-shadow: none;
                width: 100%;
                max-width: 100%;
            }
            
            .receipt-logo {
                width: 40px !important;
                height: 40px !important;
            }
        }

        /* أزرار الكمية */
        .quantity-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .quantity-btn.decrease {
            background-color: var(--danger);
            color: white;
        }

        .quantity-btn.increase {
            background-color: var(--success);
            color: white;
        }

        .item-quantity {
            margin: 0 5px;
            font-weight: bold;
            min-width: 16px;
            text-align: center;
            font-size: 13px;
        }

        /* عرض نصي */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-left {
            text-align: left;
        }

        .mt-5 {
            margin-top: 5px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-5 {
            margin-bottom: 5px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .p-5 {
            padding: 5px;
        }

        .p-10 {
            padding: 10px;
        }

        /* حالة المنتج */
        .out-of-stock {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .out-of-stock:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .out-of-stock-message {
            color: var(--danger);
            font-size: 11px;
            margin-top: 5px;
        }
        
        /* مودال اختيار عدد الصفحات للتصوير */
        .pages-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .pages-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pages-input-group label {
            font-weight: bold;
            min-width: 100px;
        }
        
        .pages-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        /* أزرار إضافة المنتج في صف واحد */
        .product-input-row {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }

        .product-search {
            flex: 2;
            min-width: 200px;
        }

        .product-quantity-input {
            flex: 0.7;
            min-width: 80px;
        }

        .product-cost-input {
            flex: 0.7;
            min-width: 80px;
        }

        .product-price-input {
            flex: 0.7;
            min-width: 80px;
        }

        .product-unit-select {
            flex: 0.8;
            min-width: 90px;
        }

        .product-add-btn {
            flex: 0.3;
            min-width: 40px;
        }

        /* زر حذف معطّل */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- شاشة الدخول -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">
                <img src="https://i.postimg.cc/bY9mYjD7/Subway-library-logo.png" alt="شعار مكتبة صب واي" onerror="this.onerror=null; this.src='https://via.placeholder.com/90x90?text=LOGO'">
                مكتبة صب واي
            </h1>
            <div class="input-group">
                <label for="username">اسم المستخدم</label>
                <input type="text" id="username" placeholder="Enter username" autocomplete="off" dir="ltr" style="text-align: left;">
            </div>
            <div class="input-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button class="login-btn" id="loginBtn">دخول</button>
        </div>
    </div>

    <!-- الشاشة الرئيسية -->
    <div class="main-container" id="mainScreen">
        <!-- الهيدر -->
        <div class="header">
            <div class="store-info">
                <img src="https://i.postimg.cc/bY9mYjD7/Subway-library-logo.png" alt="شعار مكتبة صب واي" class="store-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/56x56?text=LOGO'">
                <div class="store-name">مكتبة صب واي</div>
            </div>
            <div class="user-info">
                <span id="currentUserName" style="font-size: 16px;">مستخدم</span>
                <button class="logout-btn" id="logoutBtn">تسجيل خروج</button>
            </div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="content-container">
            <!-- القائمة الجانبية -->
            <div class="sidebar" id="sidebar">
                <h3>القائمة الرئيسية</h3>
                <div class="menu-item active" data-screen="pos">
                    <i class="fas fa-cash-register"></i>
                    <span>شاشة البيع (POS)</span>
                </div>
                <div class="menu-item" data-screen="purchases">
                    <i class="fas fa-shopping-cart"></i>
                    <span>المشتريات</span>
                </div>
                <div class="menu-item" data-screen="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>التقارير</span>
                </div>
                <div class="menu-item" data-screen="inventory">
                    <i class="fas fa-boxes"></i>
                    <span>إدارة المخزون</span>
                </div>
                <div class="menu-item" data-screen="settings">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </div>
            </div>

            <!-- منطقة المحتوى -->
            <div class="content-area">
                <!-- شاشة البيع -->
                <div class="screen active" id="posScreen">
                    <h2 class="screen-title">شاشة البيع (POS)</h2>
                    <div class="pos-container">
                        <!-- فئات المنتجات -->
                        <div class="categories-panel">
                            <div class="categories-header">
                                <h3 style="font-size: 16px;">الفئات</h3>
                            </div>
                            <div class="category-scroll">
                                <button class="category-btn active" data-category="pens">
                                    <i class="fas fa-pen"></i> أقلام
                                </button>
                                <button class="category-btn" data-category="notebooks">
                                    <i class="fas fa-book"></i> دفاتر
                                </button>
                                <button class="category-btn" data-category="office">
                                    <i class="fas fa-briefcase"></i> أدوات مكتبية
                                </button>
                                <button class="category-btn" data-category="envelopes">
                                    <i class="fas fa-envelope"></i> أظرف
                                </button>
                                <button class="category-btn" data-category="papers">
                                    <i class="fas fa-file"></i> أوراق
                                </button>
                                <button class="category-btn" data-category="printing">
                                    <i class="fas fa-print"></i> خدمات التصوير
                                </button>
                                <button class="category-btn" data-category="other">
                                    <i class="fas fa-box"></i> أخرى
                                </button>
                            </div>
                        </div>

                        <!-- المنتجات -->
                        <div class="products-panel">
                            <div class="products-header">
                                <h3 id="currentCategoryTitle" style="font-size: 16px;">أقلام</h3>
                                <div class="cart-summary">
                                    <span>العناصر: <span id="totalItems">0</span></span>
                                </div>
                            </div>
                            <div class="products-grid" id="productGrid">
                                <!-- المنتجات تظهر هنا -->
                            </div>
                        </div>

                        <!-- سلة المشتريات -->
                        <div class="cart-panel">
                            <div class="cart-header">
                                <h3 style="font-size: 16px;">سلة المشتريات</h3>
                                <button class="btn btn-danger btn-sm" id="clearCartBtn">
                                    <i class="fas fa-trash"></i> تفريغ
                                </button>
                            </div>
                            
                            <div class="cart-items" id="cartItems">
                                <!-- عناصر السلة تظهر هنا -->
                                <div class="text-center p-10" id="emptyCartMessage">
                                    <i class="fas fa-shopping-cart fa-lg" style="color: #ddd; margin-bottom: 8px;"></i>
                                    <p style="font-size: 13px;">السلة فارغة</p>
                                    <p style="color: #777; font-size: 11px;">قم بإضافة منتجات من القائمة</p>
                                </div>
                            </div>
                            
                            <div class="cart-total-section">
                                <div class="discount-type">
                                    <button class="discount-btn" data-type="percentage">نسبة %</button>
                                    <button class="discount-btn active" data-type="fixed">مبلغ ثابت</button>
                                </div>
                                <div class="discount-input">
                                    <input type="number" id="discountInput" placeholder="قيمة الخصم" min="0">
                                    <button class="btn btn-warning" id="applyDiscountBtn" style="padding: 6px 10px; font-size: 12px;">تطبيق</button>
                                </div>
                                
                                <div class="cart-summary">
                                    <span>الإجمالي:</span>
                                    <span id="subtotal">0.00 جنيه</span>
                                </div>
                                <div class="cart-summary">
                                    <span>الخصم:</span>
                                    <span id="discountAmount">0.00 جنيه</span>
                                </div>
                                <div class="cart-summary" style="font-weight: bold; font-size: 14px;">
                                    <span>الإجمالي النهائي:</span>
                                    <span id="totalAmount" style="color: var(--success);">0.00 جنيه</span>
                                </div>
                            </div>

                            <div class="payment-section">
                                <div class="payment-method">
                                    <button class="payment-btn active" data-method="cash">
                                        <i class="fas fa-money-bill-wave"></i> نقدي
                                    </button>
                                    <button class="payment-btn" data-method="card">
                                        <i class="fas fa-credit-card"></i> فيزا
                                    </button>
                                </div>
                                
                                <div class="payment-actions">
                                    <button class="action-btn btn-success" id="completeSaleBtn">
                                        <i class="fas fa-check-circle"></i> إتمام البيع
                                    </button>
                                    <button class="action-btn btn-info" id="closeShiftBtn">
                                        <i class="fas fa-lock"></i> إغلاق الشيفت
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- شاشة المشتريات -->
                <div class="screen" id="purchasesScreen">
                    <h2 class="screen-title">المشتريات</h2>
                    <div class="purchases-container">
                        <div class="section-header">
                            <h3 class="section-title">إدارة المشتريات</h3>
                            <button class="btn btn-primary" id="addPurchaseBtn">
                                <i class="fas fa-plus"></i> إضافة شراء جديد
                            </button>
                        </div>

                        <!-- ألسنة التبويب -->
                        <div class="tabs">
                            <button class="tab active" data-tab="purchases-list">قائمة المشتريات</button>
                            <button class="tab" data-tab="suppliers">الموردين</button>
                        </div>

                        <!-- قسم قائمة المشتريات -->
                        <div id="purchases-list-content" class="tab-content">
                            <div class="filters">
                                <div class="filter-group">
                                    <label>من تاريخ</label>
                                    <input type="date" id="filterFromDate">
                                </div>
                                <div class="filter-group">
                                    <label>إلى تاريخ</label>
                                    <input type="date" id="filterToDate">
                                </div>
                                <div class="filter-group">
                                    <label>المورد</label>
                                    <select id="filterSupplier">
                                        <option value="">جميع الموردين</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>حالة الدفع</label>
                                    <select id="filterPaymentStatus">
                                        <option value="">جميع الحالات</option>
                                        <option value="paid">مدفوع</option>
                                        <option value="pending">معلق</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="filterBtn">
                                        <i class="fas fa-filter"></i> تصفية
                                    </button>
                                    <button class="btn btn-secondary" id="resetFilterBtn">
                                        <i class="fas fa-redo"></i> إعادة تعيين
                                    </button>
                                </div>
                            </div>

                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>رقم الفاتورة</th>
                                            <th>التاريخ</th>
                                            <th>المورد</th>
                                            <th>عدد الأصناف</th>
                                            <th>إجمالي الشراء</th>
                                            <th>حالة الدفع</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchasesTableBody">
                                        <!-- البيانات تظهر هنا -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- قسم الموردين -->
                        <div id="suppliers-content" class="tab-content" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">إدارة الموردين</h3>
                                <button class="btn btn-primary" id="addSupplierBtn">
                                    <i class="fas fa-plus"></i> إضافة مورد جديد
                                </button>
                            </div>

                            <div class="filters">
                                <div class="filter-group">
                                    <label>البحث عن مورد</label>
                                    <input type="text" id="searchSupplier" placeholder="ابحث بالاسم أو الهاتف">
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="searchSupplierBtn">
                                        <i class="fas fa-search"></i> بحث
                                    </button>
                                </div>
                            </div>

                            <div class="suppliers-grid" id="suppliersGrid">
                                <!-- الموردين يظهرون هنا -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- باقي الشاشات (مختصرة) -->
                <div class="screen" id="reportsScreen">
                    <h2 class="screen-title">التقارير</h2>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 14px;">شاشة التقارير - تحت التطوير</p>
                    </div>
                </div>
                
                <div class="screen" id="inventoryScreen">
                    <h2 class="screen-title">إدارة المخزون</h2>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 14px;">شاشة المخزون - تحت التطوير</p>
                    </div>
                </div>
                
                <div class="screen" id="settingsScreen">
                    <h2 class="screen-title">الإعدادات</h2>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 14px;">شاشة الإعدادات - تحت التطوير</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إغلاق الشيفت -->
    <div class="modal" id="closeShiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إغلاق الشيفت</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="closeShiftContent">
                <div class="receipt">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/bY9mYjD7/Subway-library-logo.png" alt="شعار المكتبة" class="receipt-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=LOGO'">
                        <div class="receipt-title">مكتبة صب واي</div>
                        <div style="margin-bottom: 12px; font-size: 14px;">تقرير إغلاق الشيفت</div>
                    </div>
                    
                    <div class="receipt-details">
                        <div><strong>التاريخ:</strong> <span id="shiftDate">22-12-2025</span></div>
                        <div><strong>الوقت:</strong> <span id="shiftTime">10:30:15</span></div>
                        <div><strong>المستخدم:</strong> <span id="shiftUser">ياسر</span></div>
                        <div><strong>وقت فتح الشيفت:</strong> <span id="shiftOpenTime">09:00:00</span></div>
                    </div>
                    
                    <h4 style="text-align: right; margin-bottom: 6px; font-size: 15px;">الأصناف المباعة:</h4>
                    <table class="receipt-items" id="shiftItemsTable">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody id="shiftItemsBody">
                            <!-- العناصر تظهر هنا -->
                        </tbody>
                    </table>
                    
                    <div class="receipt-totals">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>إجمالي المبيعات النقدية:</span>
                            <span id="shiftCashTotal">0.00 جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>إجمالي المبيعات بالفيزا:</span>
                            <span id="shiftCardTotal">0.00 جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: bold; font-size: 14px;">
                            <span>إجمالي المبيعات:</span>
                            <span id="shiftTotalSales">0.00 جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                            <span>عدد الأصناف المباعة:</span>
                            <span id="shiftItemsCount">0</span>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p style="font-size: 12px;">تم إنشاء التقرير بواسطة نظام إدارة مكتبة صب واي</p>
                        <p style="font-size: 10px; color: #777;">جميع الحقوق محفوظة © 2025</p>
                    </div>
                </div>
                
                <div style="margin-top: 12px; text-align: center;">
                    <button class="btn btn-primary" id="printShiftReportBtn" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button class="btn btn-success" id="saveShiftReportBtn" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-save"></i> حفظ التقرير
                    </button>
                    <button class="btn btn-danger" id="cancelCloseShiftBtn" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إتمام البيع -->
    <div class="modal" id="completeSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">فاتورة البيع</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="receiptContent">
                <!-- محتوى الفاتورة يظهر هنا -->
            </div>
            <div style="display: flex; gap: 6px; margin-top: 12px;">
                <button class="btn btn-success" id="saveReceiptBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-save"></i> حفظ الفاتورة
                </button>
                <button class="btn btn-primary" id="saveAndPrintBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-print"></i> حفظ وطباعة
                </button>
                <button class="btn btn-danger" id="cancelSaleBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- مودال اختيار عدد الصفحات للتصوير -->
    <div class="modal" id="printingPagesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">اختيار عدد الصفحات</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <div class="pages-input">
                    <div class="pages-input-group">
                        <label>عدد الصفحات:</label>
                        <input type="number" id="printingPagesCount" min="1" value="1" placeholder="أدخل عدد الصفحات">
                    </div>
                    <div class="pages-input-group">
                        <label>نوع التصوير:</label>
                        <select id="printingTypeSelect">
                            <option value="27">تصوير أبيض/أسود (0.5 جنيه للصفحة)</option>
                            <option value="28">تصوير ملون (2 جنيه للصفحة)</option>
                            <option value="29">تصوير طالب أبيض/أسود (0.3 جنيه للصفحة)</option>
                            <option value="30">تصوير طالب ملون (1.5 جنيه للصفحة)</option>
                        </select>
                    </div>
                    <div class="pages-input-group">
                        <label>السعر الإجمالي:</label>
                        <input type="text" id="printingTotalPrice" readonly>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="confirmPrintingBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-check"></i> تأكيد الإضافة
                    </button>
                    <button class="btn btn-danger" id="cancelPrintingBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال فاتورة الشراء -->
    <div class="modal" id="purchaseReceiptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">فاتورة الشراء</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="purchaseReceiptContent">
                <!-- محتوى فاتورة الشراء يظهر هنا -->
            </div>
            <div style="display: flex; gap: 6px; margin-top: 12px;">
                <button class="btn btn-primary" id="printPurchaseReceiptBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
                <button class="btn btn-danger" id="closePurchaseReceiptBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- مودال إضافة/تعديل شراء -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="purchaseModalTitle">إضافة شراء جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="purchaseFormContent">
                <div class="form-row">
                    <div class="form-group">
                        <label>رقم فاتورة المورد (اختياري)</label>
                        <input type="text" id="purchaseInvoiceNumber" placeholder="رقم فاتورة المورد">
                    </div>
                    <div class="form-group">
                        <label>التاريخ *</label>
                        <input type="date" id="purchaseDate" value="<?php echo date('Y-m-d'); ?>">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>المورد *</label>
                        <select id="purchaseSupplier">
                            <option value="">اختر المورد</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>طريقة الدفع</label>
                        <select id="purchasePaymentMethod">
                            <option value="cash">نقدي</option>
                            <option value="credit">آجل</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <input type="text" id="purchaseNotes" placeholder="ملاحظات إضافية">
                    </div>
                </div>
                
                <div style="margin: 20px 0; border-top: 2px solid var(--light-gray); padding-top: 15px;">
                    <h4 style="margin-bottom: 15px; color: var(--dark-blue);">الأصناف</h4>
                    
                    <!-- صف إضافة منتج -->
                    <div class="product-input-row">
                        <div class="product-search">
                            <div class="search-container">
                                <input type="text" id="productSearchInput" placeholder="ابحث عن المنتج..." autocomplete="off">
                                <div class="search-results" id="productSearchResults"></div>
                            </div>
                            <div class="product-info" id="productInfo" style="display: none;">
                                <span id="currentStock">المخزون: 0</span>
                                <span id="lastCost">آخر سعر شراء: 0.00</span>
                            </div>
                        </div>
                        
                        <div class="product-quantity-input">
                            <input type="number" id="productQuantity" placeholder="الكمية" min="1" value="1">
                        </div>
                        
                        <div class="product-cost-input">
                            <input type="number" id="productCost" placeholder="سعر الشراء" step="0.01" min="0">
                        </div>
                        
                        <div class="product-price-input">
                            <input type="number" id="productSalePrice" placeholder="سعر البيع" step="0.01" min="0">
                        </div>
                        
                        <div class="product-unit-select">
                            <select id="productUnit">
                                <option value="حبة">حبة</option>
                                <option value="باكت">باكت</option>
                                <option value="كرتون">كرتون</option>
                                <option value="رزمة">رزمة</option>
                                <option value="علبة">علبة</option>
                                <option value="صفحة">صفحة</option>
                            </select>
                        </div>
                        
                        <div class="product-add-btn">
                            <button class="btn btn-primary" id="addProductToPurchaseBtn" style="width: 100%;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="max-height: 200px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية</th>
                                    <th>سعر الشراء</th>
                                    <th>سعر البيع</th>
                                    <th>الوحدة</th>
                                    <th>الإجمالي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsTable">
                                <!-- العناصر المضافة تظهر هنا -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span>إجمالي المشتريات:</span>
                            <span id="purchaseTotal">0.00 جنيه</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="savePurchaseBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ الشراء
                    </button>
                    <button class="btn btn-warning" id="updatePurchaseBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث الشراء
                    </button>
                    <button class="btn btn-danger" id="cancelPurchaseBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إضافة/تعديل مورد -->
    <div class="modal" id="supplierModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="supplierModalTitle">إضافة مورد جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="supplierFormContent">
                <div class="form-row">
                    <div class="form-group">
                        <label>اسم المورد *</label>
                        <input type="text" id="supplierName" placeholder="اسم المورد">
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف *</label>
                        <input type="text" id="supplierPhone" placeholder="رقم الهاتف">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="supplierEmail" placeholder="البريد الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label>الموقع</label>
                        <input type="text" id="supplierLocation" placeholder="الموقع">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>رقم السجل التجاري</label>
                        <input type="text" id="supplierCommercialRegister" placeholder="رقم السجل التجاري">
                    </div>
                    <div class="form-group">
                        <label>الرقم الضريبي</label>
                        <input type="text" id="supplierTaxNumber" placeholder="الرقم الضريبي">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>ملاحظات</label>
                        <textarea id="supplierNotes" placeholder="ملاحظات إضافية" rows="3"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="saveSupplierBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ المورد
                    </button>
                    <button class="btn btn-warning" id="updateSupplierBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث المورد
                    </button>
                    <button class="btn btn-danger" id="cancelSupplierBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // البيانات الافتراضية
        const defaultUsers = [
            { username: "yasser", password: "123", role: "admin", name: "ياسر (مدير)" },
            { username: "user1", password: "123", role: "cashier", name: "مستخدم 1" }
        ];

        // بيانات المنتجات الافتراضية مع إضافة خدمات التصوير
        const defaultProducts = {
            pens: [
                { id: 1, name: "قلم رصاص HB", price: 2.5, cost: 1.5, category: "pens", stock: 100, unit: "حبة" },
                { id: 2, name: "قلم حبر أزرق", price: 5, cost: 3, category: "pens", stock: 50, unit: "حبة" },
                { id: 3, name: "قلم حبر أسود", price: 5, cost: 3, category: "pens", stock: 60, unit: "حبة" },
                { id: 4, name: "أقلام ألوان (12 لون)", price: 25, cost: 15, category: "pens", stock: 30, unit: "علبة" },
                { id: 5, name: "قلم جاف أحمر", price: 3, cost: 1.8, category: "pens", stock: 80, unit: "حبة" },
                { id: 6, name: "قلم جاف أزرق", price: 3, cost: 1.8, category: "pens", stock: 75, unit: "حبة" },
                { id: 7, name: "قلم رصاص 2B", price: 3, cost: 1.8, category: "pens", stock: 90, unit: "حبة" },
                { id: 8, name: "قلم سبورة أبيض", price: 4, cost: 2.5, category: "pens", stock: 40, unit: "حبة" }
            ],
            notebooks: [
                { id: 9, name: "دفتر 80 ورقة", price: 10, cost: 6, category: "notebooks", stock: 40, unit: "حبة" },
                { id: 10, name: "دفتر 100 ورقة", price: 12, cost: 7, category: "notebooks", stock: 35, unit: "حبة" },
                { id: 11, name: "دفتر رسم", price: 15, cost: 9, category: "notebooks", stock: 20, unit: "حبة" },
                { id: 12, name: "دفتر حساب", price: 8, cost: 5, category: "notebooks", stock: 45, unit: "حبة" },
                { id: 13, name: "دفتر كشكول", price: 6, cost: 4, category: "notebooks", stock: 60, unit: "حبة" },
                { id: 14, name: "دفتر مذكرات", price: 20, cost: 12, category: "notebooks", stock: 25, unit: "حبة" }
            ],
            office: [
                { id: 15, name: "مشابك ورق", price: 5, cost: 3, category: "office", stock: 100, unit: "علبة" },
                { id: 16, name: "دباسة صغيرة", price: 25, cost: 15, category: "office", stock: 15, unit: "حبة" },
                { id: 17, name: "مقص مكتب", price: 15, cost: 9, category: "office", stock: 10, unit: "حبة" },
                { id: 18, name: "مبراة", price: 8, cost: 5, category: "office", stock: 25, unit: "حبة" },
                { id: 19, name: "مسطرة 30 سم", price: 5, cost: 3, category: "office", stock: 50, unit: "حبة" }
            ],
            envelopes: [
                { id: 20, name: "أظرف بلاستيك صغيرة", price: 10, cost: 6, category: "envelopes", stock: 80, unit: "كرتون" },
                { id: 21, name: "أظرف ورقية متوسطة", price: 15, cost: 9, category: "envelopes", stock: 60, unit: "كرتون" },
                { id: 22, name: "أظرف بلاستيك كبيرة", price: 12, cost: 7, category: "envelopes", stock: 40, unit: "كرتون" }
            ],
            papers: [
                { id: 23, name: "ورق A4 (500 ورقة)", price: 45, cost: 30, category: "papers", stock: 25, unit: "رزمة" },
                { id: 24, name: "ورق A3 (100 ورقة)", price: 60, cost: 40, category: "papers", stock: 15, unit: "رزمة" },
                { id: 25, name: "ورق ملون A4", price: 30, cost: 20, category: "papers", stock: 20, unit: "رزمة" },
                { id: 26, name: "ورق رسم A4", price: 35, cost: 22, category: "papers", stock: 18, unit: "رزمة" }
            ],
            printing: [
                { id: 27, name: "تصوير أبيض/أسود (صفحة)", price: 0.5, cost: 0.1, category: "printing", stock: 9999, unit: "صفحة", perPage: true },
                { id: 28, name: "تصوير ملون (صفحة)", price: 2, cost: 0.5, category: "printing", stock: 9999, unit: "صفحة", perPage: true },
                { id: 29, name: "تصوير طالب (أبيض/أسود)", price: 0.3, cost: 0.1, category: "printing", stock: 9999, unit: "صفحة", perPage: true },
                { id: 30, name: "تصوير طالب (ملون)", price: 1.5, cost: 0.5, category: "printing", stock: 9999, unit: "صفحة", perPage: true },
                { id: 31, name: "تغليف ورق شفاف", price: 3, cost: 1, category: "printing", stock: 9999, unit: "حبة", perPage: false },
                { id: 32, name: "تغليف حراري", price: 5, cost: 2, category: "printing", stock: 9999, unit: "حبة", perPage: false }
            ],
            other: [
                { id: 33, name: "صمغ مكتب", price: 8, cost: 5, category: "other", stock: 40, unit: "حبة" },
                { id: 34, name: "شريط لاصق", price: 7, cost: 4, category: "other", stock: 30, unit: "حبة" },
                { id: 35, name: "براية", price: 3, cost: 1.5, category: "other", stock: 60, unit: "حبة" },
                { id: 36, name: "ممحاة", price: 2, cost: 1, category: "other", stock: 100, unit: "حبة" },
                { id: 37, name: "دبابيس مكتب", price: 4, cost: 2, category: "other", stock: 70, unit: "علبة" }
            ]
        };

        // بيانات الموردين الافتراضية
        const defaultSuppliers = [
            { 
                id: 1, 
                name: "شركة الأقلام الذهبية", 
                phone: "01012345678", 
                email: "info@goldenpens.com", 
                location: "القاهرة", 
                commercialRegister: "123456789",
                taxNumber: "987654321",
                notes: "مورد رئيسي للأقلام والأدوات المكتبية"
            },
            { 
                id: 2, 
                name: "مصنع الأوراق المصرية", 
                phone: "01198765432", 
                email: "sales@egyptianpapers.com", 
                location: "الجيزة", 
                commercialRegister: "987654321",
                taxNumber: "123456789",
                notes: "توفير جميع أنواع الورق"
            },
            { 
                id: 3, 
                name: "مركز مستلزمات المكتب", 
                phone: "01234567890", 
                email: "info@office-supplies.com", 
                location: "المعادي", 
                commercialRegister: "456789123",
                taxNumber: "321654987",
                notes: "جميع الأدوات المكتبية والأظرف"
            }
        ];

        // بيانات المشتريات الافتراضية
        const defaultPurchases = [
            {
                id: 1,
                invoiceNumber: "INV-SUP-001",
                date: "2025-12-20",
                supplierId: 1,
                supplierName: "شركة الأقلام الذهبية",
                items: [
                    { productId: 1, name: "قلم رصاص HB", quantity: 50, cost: 1.5, salePrice: 2.5, unit: "حبة", total: 75 },
                    { productId: 2, name: "قلم حبر أزرق", quantity: 30, cost: 3, salePrice: 5, unit: "حبة", total: 90 }
                ],
                total: 165,
                paymentMethod: "cash",
                paymentStatus: "paid",
                notes: "طلب عاجل"
            },
            {
                id: 2,
                invoiceNumber: "INV-PAPER-2025-015",
                date: "2025-12-15",
                supplierId: 2,
                supplierName: "مصنع الأوراق المصرية",
                items: [
                    { productId: 23, name: "ورق A4 (500 ورقة)", quantity: 10, cost: 30, salePrice: 45, unit: "رزمة", total: 300 },
                    { productId: 25, name: "ورق ملون A4", quantity: 5, cost: 20, salePrice: 30, unit: "رزمة", total: 100 }
                ],
                total: 400,
                paymentMethod: "credit",
                paymentStatus: "pending",
                notes: "سيتم الدفع نهاية الشهر"
            }
        ];

        // حالة التطبيق
        let currentUser = null;
        let cart = [];
        let discount = { type: 'fixed', value: 0 };
        let paymentMethod = 'cash';
        let currentShift = {
            openTime: new Date(),
            cashTotal: 0,
            cardTotal: 0,
            totalSales: 0,
            itemsSold: []
        };
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter') || '1001');
        let purchaseCounter = parseInt(localStorage.getItem('purchaseCounter') || '3');
        let supplierCounter = parseInt(localStorage.getItem('supplierCounter') || defaultSuppliers.length + 1);
        let currentPurchaseItems = [];
        let currentEditingPurchaseId = null;
        let currentEditingSupplierId = null;
        let currentPrintingProduct = null;
        let selectedProduct = null;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات من localStorage إذا كانت موجودة
            loadDataFromStorage();
            
            // إعداد عناصر واجهة المستخدم
            initUI();
            
            // تحميل المنتجات الأولية
            loadProductsByCategory('pens');
            updateCartDisplay();
            
            // تحميل بيانات المشتريات
            loadPurchases();
            loadSuppliers();
        });

        // تحميل البيانات من localStorage
        function loadDataFromStorage() {
            const storedUsers = localStorage.getItem('storeUsers');
            const storedProducts = localStorage.getItem('storeProducts');
            const storedCart = localStorage.getItem('storeCart');
            const storedShift = localStorage.getItem('storeShift');
            const storedSuppliers = localStorage.getItem('storeSuppliers');
            const storedPurchases = localStorage.getItem('storePurchases');
            
            if (!storedUsers) {
                localStorage.setItem('storeUsers', JSON.stringify(defaultUsers));
            }
            
            if (!storedProducts) {
                localStorage.setItem('storeProducts', JSON.stringify(defaultProducts));
            }
            
            if (!storedSuppliers) {
                localStorage.setItem('storeSuppliers', JSON.stringify(defaultSuppliers));
            }
            
            if (!storedPurchases) {
                localStorage.setItem('storePurchases', JSON.stringify(defaultPurchases));
            }
            
            if (storedCart) {
                cart = JSON.parse(storedCart);
            }
            
            if (storedShift) {
                currentShift = JSON.parse(storedShift);
                currentShift.openTime = new Date(currentShift.openTime);
            }
        }

        // تهيئة واجهة المستخدم
        function initUI() {
            // عناصر شاشة الدخول
            const loginBtn = document.getElementById('loginBtn');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            // عناصر التنقل
            const menuItems = document.querySelectorAll('.menu-item');
            const logoutBtn = document.getElementById('logoutBtn');
            
            // عناصر شاشة البيع
            const categoryBtns = document.querySelectorAll('.category-btn');
            const discountBtns = document.querySelectorAll('.discount-btn');
            const discountInput = document.getElementById('discountInput');
            const applyDiscountBtn = document.getElementById('applyDiscountBtn');
            const paymentBtns = document.querySelectorAll('.payment-btn');
            const completeSaleBtn = document.getElementById('completeSaleBtn');
            const clearCartBtn = document.getElementById('clearCartBtn');
            const closeShiftBtn = document.getElementById('closeShiftBtn');
            
            // عناصر شاشة المشتريات
            const tabs = document.querySelectorAll('.tab');
            const addPurchaseBtn = document.getElementById('addPurchaseBtn');
            const addSupplierBtn = document.getElementById('addSupplierBtn');
            const filterBtn = document.getElementById('filterBtn');
            const resetFilterBtn = document.getElementById('resetFilterBtn');
            const searchSupplierBtn = document.getElementById('searchSupplierBtn');
            
            // عناصر البحث الديناميكي
            const productSearchInput = document.getElementById('productSearchInput');
            const productSearchResults = document.getElementById('productSearchResults');
            
            // عناصر مودال المشتريات
            const purchaseModal = document.getElementById('purchaseModal');
            const addProductToPurchaseBtn = document.getElementById('addProductToPurchaseBtn');
            const savePurchaseBtn = document.getElementById('savePurchaseBtn');
            const updatePurchaseBtn = document.getElementById('updatePurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            
            // عناصر مودال الموردين
            const supplierModal = document.getElementById('supplierModal');
            const saveSupplierBtn = document.getElementById('saveSupplierBtn');
            const updateSupplierBtn = document.getElementById('updateSupplierBtn');
            const cancelSupplierBtn = document.getElementById('cancelSupplierBtn');
            
            // عناصر مودال التصوير
            const printingPagesModal = document.getElementById('printingPagesModal');
            const printingPagesCount = document.getElementById('printingPagesCount');
            const printingTypeSelect = document.getElementById('printingTypeSelect');
            const confirmPrintingBtn = document.getElementById('confirmPrintingBtn');
            const cancelPrintingBtn = document.getElementById('cancelPrintingBtn');
            
            // عناصر المودال الأخرى
            const closeShiftModal = document.getElementById('closeShiftModal');
            const completeSaleModal = document.getElementById('completeSaleModal');
            const purchaseReceiptModal = document.getElementById('purchaseReceiptModal');
            const closeModalBtns = document.querySelectorAll('.close-modal');
            const cancelCloseShiftBtn = document.getElementById('cancelCloseShiftBtn');
            const printShiftReportBtn = document.getElementById('printShiftReportBtn');
            const saveShiftReportBtn = document.getElementById('saveShiftReportBtn');
            const saveReceiptBtn = document.getElementById('saveReceiptBtn');
            const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');
            const cancelSaleBtn = document.getElementById('cancelSaleBtn');
            const printPurchaseReceiptBtn = document.getElementById('printPurchaseReceiptBtn');
            const closePurchaseReceiptBtn = document.getElementById('closePurchaseReceiptBtn');
            
            // أحداث شاشة الدخول
            loginBtn.addEventListener('click', handleLogin);
            
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    passwordInput.focus();
                }
            });
            
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // أحداث التنقل بين الشاشات
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const screenId = this.getAttribute('data-screen');
                    switchScreen(screenId);
                    
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // تسجيل الخروج
            logoutBtn.addEventListener('click', handleLogout);
            
            // أحداث شاشة البيع
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    loadProductsByCategory(category);
                    
                    // تحديث عنوان الفئة
                    const categoryTitles = {
                        pens: 'أقلام',
                        notebooks: 'دفاتر',
                        office: 'أدوات مكتبية',
                        envelopes: 'أظرف',
                        papers: 'أوراق',
                        printing: 'خدمات التصوير',
                        other: 'منتجات أخرى'
                    };
                    document.getElementById('currentCategoryTitle').textContent = categoryTitles[category] || category;
                });
            });
            
            // أحداث الخصم
            discountBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    discountBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    discount.type = this.getAttribute('data-type');
                    applyDiscount();
                });
            });
            
            discountInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyDiscount();
                }
            });
            
            applyDiscountBtn.addEventListener('click', applyDiscount);
            
            // أحداث طريقة الدفع
            paymentBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    paymentBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    paymentMethod = this.getAttribute('data-method');
                });
            });
            
            // أحداث الأزرار الرئيسية
            completeSaleBtn.addEventListener('click', showReceiptModal);
            clearCartBtn.addEventListener('click', clearCart);
            closeShiftBtn.addEventListener('click', showCloseShiftModal);
            
            // أحداث شاشة المشتريات
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    document.getElementById(`${tabId}-content`).style.display = 'block';
                });
            });
            
            addPurchaseBtn.addEventListener('click', () => showPurchaseModal());
            addSupplierBtn.addEventListener('click', () => showSupplierModal());
            filterBtn.addEventListener('click', filterPurchases);
            resetFilterBtn.addEventListener('click', resetPurchasesFilter);
            searchSupplierBtn.addEventListener('click', searchSuppliers);
            
            // أحداث البحث الديناميكي
            productSearchInput.addEventListener('input', searchProducts);
            productSearchInput.addEventListener('focus', function() {
                if (this.value.trim()) {
                    searchProducts();
                }
            });
            
            // إغلاق نتائج البحث عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!productSearchResults.contains(e.target) && e.target !== productSearchInput) {
                    productSearchResults.style.display = 'none';
                }
            });
            
            // أحداث مودال المشتريات
            addProductToPurchaseBtn.addEventListener('click', addProductToPurchase);
            savePurchaseBtn.addEventListener('click', savePurchase);
            updatePurchaseBtn.addEventListener('click', updatePurchase);
            cancelPurchaseBtn.addEventListener('click', () => purchaseModal.style.display = 'none');
            
            // عند اختيار المنتج، تعبئة الحقول تلقائياً
            productSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const firstResult = productSearchResults.querySelector('.search-result-item');
                    if (firstResult) {
                        selectProductFromSearch(parseInt(firstResult.dataset.productId));
                    }
                }
            });
            
            // أحداث مودال الموردين
            saveSupplierBtn.addEventListener('click', saveSupplier);
            updateSupplierBtn.addEventListener('click', updateSupplier);
            cancelSupplierBtn.addEventListener('click', () => supplierModal.style.display = 'none');
            
            // أحداث مودال التصوير
            printingPagesCount.addEventListener('input', updatePrintingPrice);
            printingTypeSelect.addEventListener('change', updatePrintingPrice);
            confirmPrintingBtn.addEventListener('click', confirmPrinting);
            cancelPrintingBtn.addEventListener('click', () => printingPagesModal.style.display = 'none');
            
            // أحداث المودال
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) modal.style.display = 'none';
                });
            });
            
            cancelCloseShiftBtn.addEventListener('click', () => closeShiftModal.style.display = 'none');
            printShiftReportBtn.addEventListener('click', printShiftReport);
            saveShiftReportBtn.addEventListener('click', saveShiftReport);
            saveReceiptBtn.addEventListener('click', saveReceipt);
            saveAndPrintBtn.addEventListener('click', saveAndPrintReceipt);
            cancelSaleBtn.addEventListener('click', () => completeSaleModal.style.display = 'none');
            printPurchaseReceiptBtn.addEventListener('click', printPurchaseReceipt);
            closePurchaseReceiptBtn.addEventListener('click', () => purchaseReceiptModal.style.display = 'none');
            
            // عند النقر خارج المودال
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // تحديث سعر التصوير عند فتح المودال
            updatePrintingPrice();
        }

        // البحث عن المنتجات
        function searchProducts() {
            const searchTerm = document.getElementById('productSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('productSearchResults');
            
            if (!searchTerm) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let allProducts = [];
            
            // جمع جميع المنتجات من جميع الفئات
            for (const category in productsData) {
                allProducts = allProducts.concat(productsData[category]);
            }
            
            // البحث في المنتجات
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">لا توجد نتائج</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let resultsHTML = '';
            filteredProducts.forEach(product => {
                resultsHTML += `
                    <div class="search-result-item" data-product-id="${product.id}">
                        ${product.name} (${product.unit}) - ${product.price.toFixed(2)} جنيه
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';
            
            // إضافة أحداث النقر على النتائج
            const resultItems = resultsContainer.querySelectorAll('.search-result-item');
            resultItems.forEach(item => {
                item.addEventListener('click', function() {
                    const productId = parseInt(this.dataset.productId);
                    selectProductFromSearch(productId);
                });
            });
        }

        // اختيار منتج من نتائج البحث
        function selectProductFromSearch(productId) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (product) {
                selectedProduct = product;
                document.getElementById('productSearchInput').value = product.name;
                document.getElementById('productQuantity').value = 1;
                document.getElementById('productCost').value = product.cost.toFixed(2);
                document.getElementById('productSalePrice').value = product.price.toFixed(2);
                document.getElementById('productUnit').value = product.unit;
                
                // عرض معلومات المنتج
                document.getElementById('productInfo').style.display = 'flex';
                document.getElementById('currentStock').textContent = `المخزون: ${product.stock}`;
                document.getElementById('lastCost').textContent = `آخر سعر شراء: ${product.cost.toFixed(2)}`;
                
                // إخفاء نتائج البحث
                document.getElementById('productSearchResults').style.display = 'none';
                
                // تركيز على حقل الكمية
                document.getElementById('productQuantity').focus();
                document.getElementById('productQuantity').select();
            }
        }

        // تحديث سعر التصوير
        function updatePrintingPrice() {
            const pages = parseInt(document.getElementById('printingPagesCount').value) || 1;
            const productId = parseInt(document.getElementById('printingTypeSelect').value);
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (product) {
                const totalPrice = product.price * pages;
                document.getElementById('printingTotalPrice').value = totalPrice.toFixed(2) + ' جنيه';
            }
        }

        // معالجة الدخول
        function handleLogin() {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('يرجى إدخال اسم المستخدم وكلمة المرور');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const user = users.find(u => 
                u.username.toLowerCase() === username && u.password === password
            );
            
            if (user) {
                currentUser = user;
                showMainScreen();
                updateUIForUserRole();
            } else {
                alert('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // عرض الشاشة الرئيسية
        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.name;
        }

        // تحديث الواجهة حسب دور المستخدم
        function updateUIForUserRole() {
            const menuItems = document.querySelectorAll('.menu-item');
            
            if (currentUser.role === 'cashier') {
                // البائع يرى فقط شاشة البيع
                menuItems.forEach(item => {
                    const screen = item.getAttribute('data-screen');
                    if (screen !== 'pos') {
                        item.style.display = 'none';
                    }
                });
                
                // إذا كان في شاشة غير البيع، انتقل إلى شاشة البيع
                const currentScreen = document.querySelector('.screen.active');
                if (currentScreen && currentScreen.id !== 'posScreen') {
                    switchScreen('pos');
                    menuItems.forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-screen') === 'pos') {
                            item.classList.add('active');
                        }
                    });
                }
            } else if (currentUser.role === 'admin') {
                // المدير يرى جميع الشاشات
                menuItems.forEach(item => {
                    item.style.display = 'flex';
                });
            }
        }

        // تبديل الشاشات
        function switchScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId + 'Screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            if (screenId === 'purchases') {
                loadPurchases();
                loadSuppliers();
            }
        }

        // تحميل المنتجات حسب الفئة
        function loadProductsByCategory(category) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            const products = productsData[category] || [];
            
            if (products.length === 0) {
                productGrid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد منتجات في هذه الفئة</p></div>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = product.stock <= 0 ? 'product-card out-of-stock' : 'product-card';
                
                // إضافة معالج حدث للنقر على الكارت كله
                productCard.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (e.target.tagName !== 'BUTTON') {
                        if (product.perPage) {
                            // خدمات التصوير التي تحتاج اختيار عدد الصفحات
                            currentPrintingProduct = product;
                            document.getElementById('printingPagesCount').value = 1;
                            document.getElementById('printingTypeSelect').value = product.id;
                            updatePrintingPrice();
                            document.getElementById('printingPagesModal').style.display = 'flex';
                        } else {
                            // المنتجات العادية
                            addToCart(product.id);
                        }
                    }
                });
                
                let stockInfo = '';
                if (product.perPage) {
                    stockInfo = '<div class="product-stock">لا حصر</div>';
                } else {
                    stockInfo = `<div class="product-stock">${product.stock} ${product.unit}</div>`;
                }
                
                let clickInfo = '';
                if (product.perPage) {
                    clickInfo = '<div style="font-size: 11px; color: var(--primary-orange); margin-top: 5px;"><i class="fas fa-print"></i> اضغط لاختيار عدد الصفحات</div>';
                } else if (product.stock <= 0) {
                    clickInfo = '<div class="out-of-stock-message"><i class="fas fa-times-circle"></i> غير متوفر</div>';
                } else {
                    clickInfo = '<div style="font-size: 11px; color: var(--primary-orange); margin-top: 5px;"><i class="fas fa-cart-plus"></i> اضغط لإضافة</div>';
                }
                
                productCard.innerHTML = `
                    <div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price.toFixed(2)} جنيه</div>
                        ${stockInfo}
                    </div>
                    ${clickInfo}
                `;
                
                productGrid.appendChild(productCard);
            });
        }

        // تأكيد إضافة التصوير
        function confirmPrinting() {
            const pages = parseInt(document.getElementById('printingPagesCount').value) || 1;
            
            if (pages < 1) {
                alert('يرجى إدخال عدد صفحات صحيح');
                return;
            }
            
            if (currentPrintingProduct) {
                // إضافة المنتج مع الكمية المحددة
                const existingItem = cart.find(item => item.id === currentPrintingProduct.id);
                
                if (existingItem) {
                    // زيادة الكمية الموجودة
                    existingItem.quantity += pages;
                } else {
                    // إضافة منتج جديد للسلة
                    cart.push({
                        ...currentPrintingProduct,
                        quantity: pages,
                        salePrice: currentPrintingProduct.price,
                        name: `${currentPrintingProduct.name} (${pages} صفحة)`
                    });
                }
                
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
                
                // إغلاق المودال
                document.getElementById('printingPagesModal').style.display = 'none';
                currentPrintingProduct = null;
            }
        }

        // إضافة منتج للسلة
        function addToCart(productId) {
            if (this.processing) return;
            this.processing = true;
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (!product) {
                alert('المنتج غير موجود');
                this.processing = false;
                return;
            }
            
            if (product.stock <= 0 && !product.perPage) {
                alert('هذا المنتج غير متوفر في المخزون');
                this.processing = false;
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId && !item.name.includes('('));
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1,
                    salePrice: product.price
                });
            }
            
            updateCartDisplay();
            localStorage.setItem('storeCart', JSON.stringify(cart));
            
            setTimeout(() => {
                this.processing = false;
            }, 100);
        }

        // تحديث عرض السلة
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const emptyCartMessage = document.getElementById('emptyCartMessage');
            const totalItems = document.getElementById('totalItems');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="text-center p-10" id="emptyCartMessage"><i class="fas fa-shopping-cart fa-lg" style="color: #ddd; margin-bottom: 8px;"></i><p style="font-size: 13px;">السلة فارغة</p><p style="color: #777; font-size: 11px;">قم بإضافة منتجات من القائمة</p></div>';
                totalItems.textContent = '0';
                updateTotals();
                return;
            }
            
            if (emptyCartMessage) emptyCartMessage.remove();
            
            let itemsHTML = '';
            let itemCount = 0;
            
            cart.forEach((item, index) => {
                itemCount += item.quantity;
                const itemTotal = item.salePrice * item.quantity;
                
                itemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${item.salePrice.toFixed(2)} × ${item.quantity} = ${itemTotal.toFixed(2)} جنيه</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="quantity-btn decrease" onclick="changeQuantity(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="item-quantity">${item.quantity}</span>
                            <button class="quantity-btn increase" onclick="changeQuantity(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = itemsHTML;
            totalItems.textContent = itemCount;
            updateTotals();
        }

        // تحديث الإجماليات
        function updateTotals() {
            const subtotalElement = document.getElementById('subtotal');
            const discountAmountElement = document.getElementById('discountAmount');
            const totalAmountElement = document.getElementById('totalAmount');
            
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            
            let discountAmount = 0;
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
            } else {
                discountAmount = discount.value;
            }
            
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            const total = subtotal - discountAmount;
            
            subtotalElement.textContent = subtotal.toFixed(2) + ' جنيه';
            discountAmountElement.textContent = discountAmount.toFixed(2) + ' جنيه';
            totalAmountElement.textContent = total.toFixed(2) + ' جنيه';
        }

        // تطبيق الخصم
        function applyDiscount() {
            const discountInput = document.getElementById('discountInput');
            discount.value = parseFloat(discountInput.value) || 0;
            updateTotals();
        }

        // تغيير كمية المنتج
        function changeQuantity(index, change) {
            if (cart[index]) {
                const newQuantity = cart[index].quantity + change;
                
                if (newQuantity <= 0) {
                    cart.splice(index, 1);
                } else {
                    cart[index].quantity = newQuantity;
                }
                
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
            }
        }

        // إزالة منتج من السلة
        function removeFromCart(index) {
            if (cart[index]) {
                cart.splice(index, 1);
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
            }
        }

        // تفريغ السلة
        function clearCart() {
            if (cart.length === 0) {
                alert('السلة فارغة بالفعل');
                return;
            }
            
            if (confirm('هل أنت متأكد من تفريغ السلة؟ سيتم حذف جميع العناصر.')) {
                cart = [];
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
            }
        }

        // عرض فاتورة البيع
        function showReceiptModal() {
            if (cart.length === 0) {
                alert('السلة فارغة، لا يمكن إتمام البيع');
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            let discountAmount = 0;
            
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
            } else {
                discountAmount = discount.value;
            }
            
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            const total = subtotal - discountAmount;
            
            const invoiceNumber = `INV-${new Date().getFullYear()}-${invoiceCounter.toString().padStart(4, '0')}`;
            
            let receiptHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/bY9mYjD7/Subway-library-logo.png" alt="شعار المكتبة" class="receipt-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=LOGO'">
                        <div class="receipt-title">مكتبة صب واي</div>
                        <div>رقم الفاتورة: ${invoiceNumber}</div>
                        <div>التاريخ: ${formatDate(new Date())}</div>
                        <div>الوقت: ${formatTime(new Date())}</div>
                        <div>طريقة الدفع: ${paymentMethod === 'cash' ? 'نقدي' : 'فيزا'}</div>
                    </div>
                    
                    <table class="receipt-items">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            cart.forEach(item => {
                const itemTotal = item.salePrice * item.quantity;
                receiptHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.salePrice.toFixed(2)}</td>
                        <td>${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            receiptHTML += `
                        </tbody>
                    </table>
                    
                    <div class="receipt-totals">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>الإجمالي:</span>
                            <span>${subtotal.toFixed(2)} جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>الخصم:</span>
                            <span>${discountAmount.toFixed(2)} جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; font-weight: bold; border-top: 1px solid #ddd; padding-top: 6px;">
                            <span>المبلغ المستحق:</span>
                            <span>${total.toFixed(2)} جنيه</span>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p>شكراً لزيارتكم مكتبة صب واي</p>
                        <p>رقم الهاتف: 0100-123-4567</p>
                        <p style="font-size: 11px; color: #777;">جميع الحقوق محفوظة © 2025</p>
                    </div>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = receiptHTML;
            document.getElementById('completeSaleModal').style.display = 'flex';
        }

        // حفظ الفاتورة
        function saveReceipt() {
            completeSale(false);
            alert('تم حفظ الفاتورة بنجاح');
        }

        // حفظ وطباعة الفاتورة
        function saveAndPrintReceipt() {
            completeSale(true);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة فاتورة - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 20px; }
                        .receipt { width: 80mm; margin: 0 auto; }
                        .text-center { text-align: center; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 5px; border-bottom: 1px solid #ddd; }
                        .total { font-weight: bold; font-size: 16px; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="text-center">
                            <img src="https://i.postimg.cc/bY9mYjD7/Subway-library-logo.png" alt="شعار المكتبة" class="receipt-logo">
                            <h3>مكتبة صب واي</h3>
                            <p>فاتورة بيع</p>
                        </div>
                        ${document.getElementById('receiptContent').innerHTML}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // إتمام عملية البيع
        function completeSale(shouldPrint = false) {
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            let discountAmount = 0;
            
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
            } else {
                discountAmount = discount.value;
            }
            
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            const total = subtotal - discountAmount;
            
            if (paymentMethod === 'cash') {
                currentShift.cashTotal += total;
            } else {
                currentShift.cardTotal += total;
            }
            
            currentShift.totalSales += total;
            currentShift.itemsSold = [...currentShift.itemsSold, ...cart.map(item => ({
                ...item,
                saleDate: new Date()
            }))];
            
            updateInventoryAfterSale();
            
            localStorage.setItem('storeShift', JSON.stringify(currentShift));
            
            invoiceCounter++;
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            document.getElementById('completeSaleModal').style.display = 'none';
            
            cart = [];
            updateCartDisplay();
            localStorage.setItem('storeCart', JSON.stringify(cart));
            
            discount.value = 0;
            document.getElementById('discountInput').value = '';
            updateTotals();
        }

        // تحديث المخزون بعد البيع
        function updateInventoryAfterSale() {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            cart.forEach(cartItem => {
                for (const category in productsData) {
                    const product = productsData[category].find(p => p.id === cartItem.id);
                    if (product && !product.perPage) {
                        product.stock = Math.max(0, product.stock - cartItem.quantity);
                        // تحديث عدد الحركات
                        if (!product.transactionCount) product.transactionCount = 0;
                        product.transactionCount++;
                        break;
                    }
                }
            });
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
        }

        // عرض مودال إغلاق الشيفت
        function showCloseShiftModal() {
            if (currentUser.role !== 'admin') {
                alert('عفواً، هذه الميزة متاحة فقط للمدير');
                return;
            }
            
            const now = new Date();
            document.getElementById('shiftDate').textContent = formatDate(now);
            document.getElementById('shiftTime').textContent = formatTime(now);
            document.getElementById('shiftUser').textContent = currentUser.name;
            document.getElementById('shiftOpenTime').textContent = formatTime(currentShift.openTime);
            document.getElementById('shiftCashTotal').textContent = currentShift.cashTotal.toFixed(2) + ' جنيه';
            document.getElementById('shiftCardTotal').textContent = currentShift.cardTotal.toFixed(2) + ' جنيه';
            document.getElementById('shiftTotalSales').textContent = currentShift.totalSales.toFixed(2) + ' جنيه';
            document.getElementById('shiftItemsCount').textContent = currentShift.itemsSold.length;
            
            const shiftItemsBody = document.getElementById('shiftItemsBody');
            shiftItemsBody.innerHTML = '';
            
            const itemSummary = {};
            currentShift.itemsSold.forEach(item => {
                if (!itemSummary[item.id]) {
                    itemSummary[item.id] = {
                        name: item.name,
                        quantity: 0,
                        total: 0
                    };
                }
                itemSummary[item.id].quantity += item.quantity;
                itemSummary[item.id].total += item.salePrice * item.quantity;
            });
            
            for (const id in itemSummary) {
                const item = itemSummary[id];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.total.toFixed(2)}</td>
                `;
                shiftItemsBody.appendChild(row);
            }
            
            document.getElementById('closeShiftModal').style.display = 'flex';
        }

        // طباعة تقرير الشيفت
        function printShiftReport() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة تقرير الشيفت - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; padding: 20px; }
                        .receipt { width: 100%; }
                        .text-center { text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { padding: 8px; border: 1px solid #ddd; }
                        .total { font-weight: bold; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('closeShiftContent').innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // حفظ تقرير الشيفت
        function saveShiftReport() {
            alert('تم حفظ تقرير الشيفت بنجاح');
            
            currentShift = {
                openTime: new Date(),
                cashTotal: 0,
                cardTotal: 0,
                totalSales: 0,
                itemsSold: []
            };
            
            localStorage.setItem('storeShift', JSON.stringify(currentShift));
            
            document.getElementById('closeShiftModal').style.display = 'none';
        }

        // تحميل المشتريات
        function loadPurchases() {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const tableBody = document.getElementById('purchasesTableBody');
            
            if (purchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد مشتريات مسجلة</td></tr>';
                return;
            }
            
            let html = '';
            purchases.forEach(purchase => {
                html += `
                    <tr>
                        <td>${purchase.invoiceNumber || 'بدون رقم'}</td>
                        <td>${purchase.date}</td>
                        <td>${purchase.supplierName}</td>
                        <td>${purchase.items.length}</td>
                        <td>${purchase.total.toFixed(2)} جنيه</td>
                        <td>
                            <span class="btn btn-sm ${purchase.paymentStatus === 'paid' ? 'btn-success' : 'btn-warning'}" style="padding: 3px 8px;">
                                ${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewPurchase(${purchase.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editPurchase(${purchase.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePurchase(${purchase.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            updateSupplierFilter();
        }

        // تحميل الموردين
        function loadSuppliers() {
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const grid = document.getElementById('suppliersGrid');
            
            if (suppliers.length === 0) {
                grid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد موردين مسجلين</p></div>';
                return;
            }
            
            let html = '';
            suppliers.forEach(supplier => {
                const canDelete = !hasSupplierTransactions(supplier.id);
                const deleteBtnClass = canDelete ? 'btn-danger' : 'btn-danger btn-disabled';
                const deleteBtnTitle = canDelete ? '' : 'لا يمكن حذف المورد بسبب وجود حركات';
                
                html += `
                    <div class="supplier-card">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-info">
                            <strong>الهاتف:</strong> ${supplier.phone}
                        </div>
                        ${supplier.email ? `<div class="supplier-info"><strong>البريد الإلكتروني:</strong> ${supplier.email}</div>` : ''}
                        ${supplier.location ? `<div class="supplier-info"><strong>الموقع:</strong> ${supplier.location}</div>` : ''}
                        ${supplier.notes ? `<div class="supplier-info"><strong>ملاحظات:</strong> ${supplier.notes}</div>` : ''}
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn btn-warning btn-sm" onclick="editSupplier(${supplier.id})" style="flex: 1;">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn ${deleteBtnClass} btn-sm" onclick="${canDelete ? `deleteSupplier(${supplier.id})` : 'alert(\'لا يمكن حذف المورد بسبب وجود حركات مرتبطة به\')'}" style="flex: 1;" title="${deleteBtnTitle}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            updateSupplierSelect();
        }

        // التحقق من وجود حركات للمورد
        function hasSupplierTransactions(supplierId) {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            return purchases.some(purchase => purchase.supplierId == supplierId);
        }

        // تحديث قائمة الموردين في الفلتر والنموذج
        function updateSupplierFilter() {
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const filterSelect = document.getElementById('filterSupplier');
            const purchaseSelect = document.getElementById('purchaseSupplier');
            
            let filterOptions = '<option value="">جميع الموردين</option>';
            let purchaseOptions = '<option value="">اختر المورد</option>';
            
            suppliers.forEach(supplier => {
                filterOptions += `<option value="${supplier.id}">${supplier.name}</option>`;
                purchaseOptions += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
            
            filterSelect.innerHTML = filterOptions;
            purchaseSelect.innerHTML = purchaseOptions;
        }

        // تصفية المشتريات
        function filterPurchases() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const supplierId = document.getElementById('filterSupplier').value;
            const paymentStatus = document.getElementById('filterPaymentStatus').value;
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            let filteredPurchases = [...purchases];
            
            if (fromDate) {
                filteredPurchases = filteredPurchases.filter(p => p.date >= fromDate);
            }
            
            if (toDate) {
                filteredPurchases = filteredPurchases.filter(p => p.date <= toDate);
            }
            
            if (supplierId) {
                filteredPurchases = filteredPurchases.filter(p => p.supplierId == supplierId);
            }
            
            if (paymentStatus) {
                filteredPurchases = filteredPurchases.filter(p => p.paymentStatus === paymentStatus);
            }
            
            const tableBody = document.getElementById('purchasesTableBody');
            
            if (filteredPurchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد مشتريات تطابق معايير البحث</td></tr>';
                return;
            }
            
            let html = '';
            filteredPurchases.forEach(purchase => {
                html += `
                    <tr>
                        <td>${purchase.invoiceNumber || 'بدون رقم'}</td>
                        <td>${purchase.date}</td>
                        <td>${purchase.supplierName}</td>
                        <td>${purchase.items.length}</td>
                        <td>${purchase.total.toFixed(2)} جنيه</td>
                        <td>
                            <span class="btn btn-sm ${purchase.paymentStatus === 'paid' ? 'btn-success' : 'btn-warning'}" style="padding: 3px 8px;">
                                ${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewPurchase(${purchase.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editPurchase(${purchase.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePurchase(${purchase.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // إعادة تعيين تصفية المشتريات
        function resetPurchasesFilter() {
            document.getElementById('filterFromDate').value = '';
            document.getElementById('filterToDate').value = '';
            document.getElementById('filterSupplier').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            
            loadPurchases();
        }

        // البحث عن موردين
        function searchSuppliers() {
            const searchTerm = document.getElementById('searchSupplier').value.toLowerCase();
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const grid = document.getElementById('suppliersGrid');
            
            if (!searchTerm) {
                loadSuppliers();
                return;
            }
            
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) || 
                supplier.phone.includes(searchTerm)
            );
            
            if (filteredSuppliers.length === 0) {
                grid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد موردين تطابق معايير البحث</p></div>';
                return;
            }
            
            let html = '';
            filteredSuppliers.forEach(supplier => {
                const canDelete = !hasSupplierTransactions(supplier.id);
                const deleteBtnClass = canDelete ? 'btn-danger' : 'btn-danger btn-disabled';
                const deleteBtnTitle = canDelete ? '' : 'لا يمكن حذف المورد بسبب وجود حركات';
                
                html += `
                    <div class="supplier-card">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-info">
                            <strong>الهاتف:</strong> ${supplier.phone}
                        </div>
                        ${supplier.email ? `<div class="supplier-info"><strong>البريد الإلكتروني:</strong> ${supplier.email}</div>` : ''}
                        ${supplier.location ? `<div class="supplier-info"><strong>الموقع:</strong> ${supplier.location}</div>` : ''}
                        ${supplier.notes ? `<div class="supplier-info"><strong>ملاحظات:</strong> ${supplier.notes}</div>` : ''}
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn btn-warning btn-sm" onclick="editSupplier(${supplier.id})" style="flex: 1;">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn ${deleteBtnClass} btn-sm" onclick="${canDelete ? `deleteSupplier(${supplier.id})` : 'alert(\'لا يمكن حذف المورد بسبب وجود حركات مرتبطة به\')'}" style="flex: 1;" title="${deleteBtnTitle}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // عرض مودال إضافة/تعديل شراء
        function showPurchaseModal(purchaseId = null) {
            currentPurchaseItems = [];
            selectedProduct = null;
            const modal = document.getElementById('purchaseModal');
            const title = document.getElementById('purchaseModalTitle');
            const today = new Date().toISOString().split('T')[0];
            
            // إعادة تعيين حقول البحث
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productInfo').style.display = 'none';
            document.getElementById('productQuantity').value = 1;
            document.getElementById('productCost').value = '';
            document.getElementById('productSalePrice').value = '';
            document.getElementById('productUnit').value = 'حبة';
            
            if (purchaseId) {
                // وضع التعديل
                currentEditingPurchaseId = purchaseId;
                title.textContent = 'تعديل بيانات الشراء';
                
                // تحميل بيانات الشراء الحالية
                const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
                const purchase = purchases.find(p => p.id === purchaseId);
                
                if (purchase) {
                    document.getElementById('purchaseInvoiceNumber').value = purchase.invoiceNumber || '';
                    document.getElementById('purchaseDate').value = purchase.date;
                    document.getElementById('purchaseSupplier').value = purchase.supplierId;
                    document.getElementById('purchasePaymentMethod').value = purchase.paymentMethod;
                    document.getElementById('purchaseNotes').value = purchase.notes || '';
                    
                    currentPurchaseItems = [...purchase.items];
                    updatePurchaseItemsTable();
                }
                
                document.getElementById('savePurchaseBtn').style.display = 'none';
                document.getElementById('updatePurchaseBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingPurchaseId = null;
                title.textContent = 'إضافة شراء جديد';
                
                document.getElementById('purchaseInvoiceNumber').value = '';
                document.getElementById('purchaseDate').value = today;
                document.getElementById('purchaseSupplier').value = '';
                document.getElementById('purchasePaymentMethod').value = 'cash';
                document.getElementById('purchaseNotes').value = '';
                
                document.getElementById('purchaseItemsTable').innerHTML = '';
                document.getElementById('purchaseTotal').textContent = '0.00 جنيه';
                
                document.getElementById('savePurchaseBtn').style.display = 'block';
                document.getElementById('updatePurchaseBtn').style.display = 'none';
            }
            
            updateSupplierSelect();
            modal.style.display = 'flex';
            
            // تركيز على حقل البحث
            setTimeout(() => {
                document.getElementById('productSearchInput').focus();
            }, 100);
        }

        // إضافة منتج إلى قائمة مشتريات
        function addProductToPurchase() {
            const quantity = document.getElementById('productQuantity').value;
            const cost = document.getElementById('productCost').value;
            const salePrice = document.getElementById('productSalePrice').value;
            const unit = document.getElementById('productUnit').value;
            
            if (!selectedProduct) {
                alert('يرجى اختيار منتج أولاً');
                document.getElementById('productSearchInput').focus();
                return;
            }
            
            if (!quantity || !cost || !salePrice) {
                alert('يرجى ملء جميع بيانات المنتج');
                return;
            }
            
            const productId = selectedProduct.id;
            const productName = selectedProduct.name;
            const quantityNum = parseInt(quantity);
            const costNum = parseFloat(cost);
            const salePriceNum = parseFloat(salePrice);
            const total = quantityNum * costNum;
            
            // التحقق من عدم إضافة نفس المنتج بنفس السعر (يسمح بإضافة نفس المنتج بأسعار مختلفة)
            const existingItemIndex = currentPurchaseItems.findIndex(item => 
                item.productId === productId && 
                item.cost === costNum && 
                item.salePrice === salePriceNum &&
                item.unit === unit
            );
            
            if (existingItemIndex !== -1) {
                currentPurchaseItems[existingItemIndex].quantity += quantityNum;
                currentPurchaseItems[existingItemIndex].total += total;
            } else {
                currentPurchaseItems.push({
                    productId,
                    name: productName,
                    quantity: quantityNum,
                    cost: costNum,
                    salePrice: salePriceNum,
                    unit,
                    total
                });
            }
            
            updatePurchaseItemsTable();
            
            // إعادة تعيين الحقول
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productInfo').style.display = 'none';
            document.getElementById('productQuantity').value = 1;
            document.getElementById('productCost').value = '';
            document.getElementById('productSalePrice').value = '';
            document.getElementById('productUnit').value = 'حبة';
            selectedProduct = null;
            
            // تركيز على حقل البحث
            document.getElementById('productSearchInput').focus();
        }

        // تحديث جدول عناصر المشتريات
        function updatePurchaseItemsTable() {
            const table = document.getElementById('purchaseItemsTable');
            const totalElement = document.getElementById('purchaseTotal');
            
            if (currentPurchaseItems.length === 0) {
                table.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد عناصر مضافة</td></tr>';
                totalElement.textContent = '0.00 جنيه';
                return;
            }
            
            let html = '';
            let total = 0;
            
            currentPurchaseItems.forEach((item, index) => {
                total += item.total;
                const canDelete = !hasProductTransactions(item.productId);
                const deleteBtnClass = canDelete ? 'btn-danger' : 'btn-danger btn-disabled';
                const deleteBtnTitle = canDelete ? '' : 'لا يمكن حذف المنتج بسبب وجود حركات';
                
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.cost.toFixed(2)}</td>
                        <td>${item.salePrice.toFixed(2)}</td>
                        <td>${item.unit}</td>
                        <td>${item.total.toFixed(2)}</td>
                        <td>
                            <button class="btn ${deleteBtnClass} btn-sm" onclick="${canDelete ? `removePurchaseItem(${index})` : 'alert(\'لا يمكن حذف المنتج بسبب وجود حركات مرتبطة به\')'}" title="${deleteBtnTitle}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
            totalElement.textContent = total.toFixed(2) + ' جنيه';
        }

        // التحقق من وجود حركات للمنتج
        function hasProductTransactions(productId) {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            // التحقق من وجود المنتج في المشتريات
            for (const purchase of purchases) {
                if (purchase.items.some(item => item.productId === productId)) {
                    return true;
                }
            }
            
            // التحقق من وجود حركات بيع للمنتج
            for (const category in productsData) {
                const product = productsData[category].find(p => p.id === productId);
                if (product && product.transactionCount && product.transactionCount > 0) {
                    return true;
                }
            }
            
            return false;
        }

        // حذف عنصر من قائمة المشتريات
        function removePurchaseItem(index) {
            currentPurchaseItems.splice(index, 1);
            updatePurchaseItemsTable();
        }

        // حفظ الشراء
        function savePurchase() {
            const invoiceNumber = document.getElementById('purchaseInvoiceNumber').value.trim();
            const date = document.getElementById('purchaseDate').value;
            const supplierId = document.getElementById('purchaseSupplier').value;
            const paymentMethod = document.getElementById('purchasePaymentMethod').value;
            const notes = document.getElementById('purchaseNotes').value.trim();
            
            if (!date || !supplierId || currentPurchaseItems.length === 0) {
                alert('يرجى ملء جميع الحقول المطلوبة وإضافة منتجات على الأقل');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplier = suppliers.find(s => s.id == supplierId);
            
            if (!supplier) {
                alert('المورد المحدد غير موجود');
                return;
            }
            
            const purchase = {
                id: purchaseCounter,
                invoiceNumber: invoiceNumber || null,
                date,
                supplierId: parseInt(supplierId),
                supplierName: supplier.name,
                items: [...currentPurchaseItems],
                total: currentPurchaseItems.reduce((sum, item) => sum + item.total, 0),
                paymentMethod,
                paymentStatus: paymentMethod === 'cash' ? 'paid' : 'pending',
                notes: notes || null
            };
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            purchases.push(purchase);
            
            updateInventoryAfterPurchase(purchase);
            
            localStorage.setItem('storePurchases', JSON.stringify(purchases));
            purchaseCounter++;
            localStorage.setItem('purchaseCounter', purchaseCounter.toString());
            
            alert('تم حفظ الشراء بنجاح');
            document.getElementById('purchaseModal').style.display = 'none';
            loadPurchases();
        }

        // تحديث الشراء
        function updatePurchase() {
            if (!currentEditingPurchaseId) {
                alert('لا يوجد شراء للتحديث');
                return;
            }
            
            const invoiceNumber = document.getElementById('purchaseInvoiceNumber').value.trim();
            const date = document.getElementById('purchaseDate').value;
            const supplierId = document.getElementById('purchaseSupplier').value;
            const paymentMethod = document.getElementById('purchasePaymentMethod').value;
            const notes = document.getElementById('purchaseNotes').value.trim();
            
            if (!date || !supplierId || currentPurchaseItems.length === 0) {
                alert('يرجى ملء جميع الحقول المطلوبة وإضافة منتجات على الأقل');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplier = suppliers.find(s => s.id == supplierId);
            
            if (!supplier) {
                alert('المورد المحدد غير موجود');
                return;
            }
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const purchaseIndex = purchases.findIndex(p => p.id === currentEditingPurchaseId);
            
            if (purchaseIndex === -1) {
                alert('الشراء غير موجود');
                return;
            }
            
            // استعادة المخزون القديم أولاً
            restoreInventoryBeforeUpdate(purchases[purchaseIndex]);
            
            // تحديث بيانات الشراء
            purchases[purchaseIndex] = {
                ...purchases[purchaseIndex],
                invoiceNumber: invoiceNumber || null,
                date,
                supplierId: parseInt(supplierId),
                supplierName: supplier.name,
                items: [...currentPurchaseItems],
                total: currentPurchaseItems.reduce((sum, item) => sum + item.total, 0),
                paymentMethod,
                paymentStatus: paymentMethod === 'cash' ? 'paid' : 'pending',
                notes: notes || null
            };
            
            // تحديث المخزون الجديد
            updateInventoryAfterPurchase(purchases[purchaseIndex]);
            
            localStorage.setItem('storePurchases', JSON.stringify(purchases));
            
            alert('تم تحديث الشراء بنجاح');
            document.getElementById('purchaseModal').style.display = 'none';
            loadPurchases();
        }

        // استعادة المخزون قبل التحديث
        function restoreInventoryBeforeUpdate(purchase) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            purchase.items.forEach(item => {
                for (const category in productsData) {
                    const product = productsData[category].find(p => p.id === item.productId);
                    if (product && !product.perPage) {
                        product.stock = Math.max(0, product.stock - item.quantity);
                        break;
                    }
                }
            });
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
        }

        // تحديث المخزون بعد الشراء
        function updateInventoryAfterPurchase(purchase) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            purchase.items.forEach(item => {
                let productFound = false;
                
                for (const category in productsData) {
                    const product = productsData[category].find(p => p.id === item.productId);
                    if (product) {
                        product.stock += item.quantity;
                        if (item.cost > 0) product.cost = item.cost;
                        if (item.salePrice > 0) product.price = item.salePrice;
                        if (item.unit) product.unit = item.unit;
                        // تحديث عدد الحركات
                        if (!product.transactionCount) product.transactionCount = 0;
                        product.transactionCount++;
                        productFound = true;
                        break;
                    }
                }
                
                if (!productFound) {
                    const newProduct = {
                        id: item.productId,
                        name: item.name,
                        price: item.salePrice,
                        cost: item.cost,
                        category: 'other',
                        stock: item.quantity,
                        unit: item.unit,
                        transactionCount: 1
                    };
                    
                    if (!productsData.other) productsData.other = [];
                    productsData.other.push(newProduct);
                }
            });
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
        }

        // عرض مودال إضافة/تعديل مورد
        function showSupplierModal(supplierId = null) {
            const modal = document.getElementById('supplierModal');
            const title = document.getElementById('supplierModalTitle');
            
            if (supplierId) {
                // وضع التعديل
                currentEditingSupplierId = supplierId;
                title.textContent = 'تعديل بيانات المورد';
                
                const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
                const supplier = suppliers.find(s => s.id === supplierId);
                
                if (supplier) {
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('supplierPhone').value = supplier.phone;
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierLocation').value = supplier.location || '';
                    document.getElementById('supplierCommercialRegister').value = supplier.commercialRegister || '';
                    document.getElementById('supplierTaxNumber').value = supplier.taxNumber || '';
                    document.getElementById('supplierNotes').value = supplier.notes || '';
                }
                
                document.getElementById('saveSupplierBtn').style.display = 'none';
                document.getElementById('updateSupplierBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingSupplierId = null;
                title.textContent = 'إضافة مورد جديد';
                
                document.getElementById('supplierName').value = '';
                document.getElementById('supplierPhone').value = '';
                document.getElementById('supplierEmail').value = '';
                document.getElementById('supplierLocation').value = '';
                document.getElementById('supplierCommercialRegister').value = '';
                document.getElementById('supplierTaxNumber').value = '';
                document.getElementById('supplierNotes').value = '';
                
                document.getElementById('saveSupplierBtn').style.display = 'block';
                document.getElementById('updateSupplierBtn').style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // حفظ المورد
        function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const location = document.getElementById('supplierLocation').value.trim();
            const commercialRegister = document.getElementById('supplierCommercialRegister').value.trim();
            const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();
            
            if (!name || !phone) {
                alert('يرجى إدخال اسم المورد ورقم الهاتف');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const newSupplier = {
                id: supplierCounter,
                name,
                phone,
                email: email || null,
                location: location || null,
                commercialRegister: commercialRegister || null,
                taxNumber: taxNumber || null,
                notes: notes || null
            };
            
            suppliers.push(newSupplier);
            localStorage.setItem('storeSuppliers', JSON.stringify(suppliers));
            supplierCounter++;
            localStorage.setItem('supplierCounter', supplierCounter.toString());
            
            alert('تم حفظ المورد بنجاح');
            document.getElementById('supplierModal').style.display = 'none';
            loadSuppliers();
            updateSupplierSelect();
        }

        // تحديث المورد
        function updateSupplier() {
            if (!currentEditingSupplierId) {
                alert('لا يوجد مورد للتحديث');
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const location = document.getElementById('supplierLocation').value.trim();
            const commercialRegister = document.getElementById('supplierCommercialRegister').value.trim();
            const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();
            
            if (!name || !phone) {
                alert('يرجى إدخال اسم المورد ورقم الهاتف');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplierIndex = suppliers.findIndex(s => s.id === currentEditingSupplierId);
            
            if (supplierIndex === -1) {
                alert('المورد غير موجود');
                return;
            }
            
            suppliers[supplierIndex] = {
                ...suppliers[supplierIndex],
                name,
                phone,
                email: email || null,
                location: location || null,
                commercialRegister: commercialRegister || null,
                taxNumber: taxNumber || null,
                notes: notes || null
            };
            
            localStorage.setItem('storeSuppliers', JSON.stringify(suppliers));
            
            alert('تم تحديث المورد بنجاح');
            document.getElementById('supplierModal').style.display = 'none';
            loadSuppliers();
            updateSupplierSelect();
        }

        // عرض فاتورة الشراء
        function viewPurchase(purchaseId) {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const purchase = purchases.find(p => p.id === purchaseId);
            
            if (!purchase) {
                alert('الشراء غير موجود');
                return;
            }
            
            const receiptHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/bY9mYjD7/Subway-library-logo.png" alt="شعار المكتبة" class="receipt-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=LOGO'">
                        <div class="receipt-title">مكتبة صب واي</div>
                        <div>فاتورة شراء</div>
                        <div>رقم الفاتورة: ${purchase.invoiceNumber || 'بدون رقم'}</div>
                        <div>التاريخ: ${purchase.date}</div>
                        <div>المورد: ${purchase.supplierName}</div>
                        <div>طريقة الدفع: ${purchase.paymentMethod === 'cash' ? 'نقدي' : 'آجل'}</div>
                        <div>حالة الدفع: ${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}</div>
                    </div>
                    
                    <table class="receipt-items">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>سعر الشراء</th>
                                <th>سعر البيع</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${purchase.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity} ${item.unit}</td>
                                    <td>${item.cost.toFixed(2)}</td>
                                    <td>${item.salePrice.toFixed(2)}</td>
                                    <td>${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="receipt-totals">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>إجمالي المشتريات:</span>
                            <span>${purchase.total.toFixed(2)} جنيه</span>
                        </div>
                        ${purchase.notes ? `
                            <div style="margin-top: 10px; padding: 10px; background-color: var(--light-gray); border-radius: 4px;">
                                <strong>ملاحظات:</strong> ${purchase.notes}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="receipt-footer">
                        <p>فاتورة شراء - نظام إدارة مكتبة صب واي</p>
                        <p style="font-size: 11px; color: #777;">تم الإنشاء: ${formatDate(new Date())} ${formatTime(new Date())}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('purchaseReceiptContent').innerHTML = receiptHTML;
            document.getElementById('purchaseReceiptModal').style.display = 'flex';
        }

        // طباعة فاتورة الشراء
        function printPurchaseReceipt() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة فاتورة شراء - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 20px; }
                        .receipt { width: 80mm; margin: 0 auto; }
                        .text-center { text-align: center; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 5px; border-bottom: 1px solid #ddd; }
                        .total { font-weight: bold; font-size: 16px; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('purchaseReceiptContent').innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // تعديل شراء
        function editPurchase(purchaseId) {
            showPurchaseModal(purchaseId);
        }

        // حذف شراء
        function deletePurchase(purchaseId) {
            if (!confirm('هل أنت متأكد من حذف هذا الشراء؟')) {
                return;
            }
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const purchaseIndex = purchases.findIndex(p => p.id === purchaseId);
            
            if (purchaseIndex === -1) {
                alert('الشراء غير موجود');
                return;
            }
            
            // استعادة المخزون
            restoreInventoryBeforeUpdate(purchases[purchaseIndex]);
            
            purchases.splice(purchaseIndex, 1);
            localStorage.setItem('storePurchases', JSON.stringify(purchases));
            
            alert('تم حذف الشراء بنجاح');
            loadPurchases();
        }

        // تعديل مورد
        function editSupplier(supplierId) {
            showSupplierModal(supplierId);
        }

        // حذف مورد
        function deleteSupplier(supplierId) {
            if (!confirm('هل أنت متأكد من حذف هذا المورد؟')) {
                return;
            }
            
            if (hasSupplierTransactions(supplierId)) {
                alert('لا يمكن حذف المورد بسبب وجود حركات مرتبطة به');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplierIndex = suppliers.findIndex(s => s.id === supplierId);
            
            if (supplierIndex === -1) {
                alert('المورد غير موجود');
                return;
            }
            
            suppliers.splice(supplierIndex, 1);
            localStorage.setItem('storeSuppliers', JSON.stringify(suppliers));
            
            alert('تم حذف المورد بنجاح');
            loadSuppliers();
            updateSupplierSelect();
        }

        // معالجة تسجيل الخروج
        function handleLogout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                currentUser = null;
                cart = [];
                
                document.getElementById('mainScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
                
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.style.display = 'flex';
                    item.classList.remove('active');
                });
                
                menuItems[0].classList.add('active');
            }
        }

        // تنسيق التاريخ
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // تنسيق الوقت
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // تحديث قائمة الموردين في select
        function updateSupplierSelect() {
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const purchaseSelect = document.getElementById('purchaseSupplier');
            
            let options = '<option value="">اختر المورد</option>';
            
            suppliers.forEach(supplier => {
                options += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
            
            purchaseSelect.innerHTML = options;
        }

        // جعل الدوال متاحة عالمياً
        window.addToCart = addToCart;
        window.changeQuantity = changeQuantity;
        window.removeFromCart = removeFromCart;
        window.viewPurchase = viewPurchase;
        window.editPurchase = editPurchase;
        window.deletePurchase = deletePurchase;
        window.editSupplier = editSupplier;
        window.deleteSupplier = deleteSupplier;
        window.removePurchaseItem = removePurchaseItem;
    </script>
</body>
</html>
