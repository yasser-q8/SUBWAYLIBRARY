<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مكتبة صب واي</title>
    <style>
        /* نظام الألوان */
        :root {
            --primary-orange: #FF9800;
            --neon-green: #39FF14;
            --light-blue: #E3F2FD;
            --dark-blue: #1976D2;
            --dark-gray: #333;
            --light-gray: #f5f5f5;
            --white: #FFFFFF;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--light-blue);
            color: var(--dark-gray);
            height: 100vh;
            overflow: hidden;
        }

        /* شاشة الدخول */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--dark-blue) 100%);
        }

        .login-box {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            width: 400px;
            padding: 40px;
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            object-fit: contain;
        }

        .login-title {
            color: var(--dark-blue);
            margin-bottom: 30px;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-title img {
            width: 90px;
            height: 90px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-gray);
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            border-color: var(--primary-orange);
            outline: none;
        }

        .login-btn {
            background-color: var(--primary-orange);
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-btn:hover {
            background-color: #e68900;
        }

        /* الشاشة الرئيسية */
        .main-container {
            display: none;
            height: 100vh;
        }

        .header {
            background-color: var(--dark-blue);
            color: white;
            padding: 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 75px;
        }

        .store-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .store-logo {
            width: 56px;
            height: 56px;
            object-fit: contain;
        }

        .store-name {
            font-size: 33px;
            font-weight: bold;
            color: var(--neon-green);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
        }

        .content-container {
            display: flex;
            height: calc(100vh - 75px);
        }

        /* القائمة الجانبية */
        .sidebar {
            width: 200px;
            background-color: white;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--dark-blue);
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid var(--primary-orange);
            padding-bottom: 8px;
            font-size: 16px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark-gray);
            font-size: 14px;
        }

        .menu-item:hover {
            background-color: var(--light-blue);
            color: var(--dark-blue);
        }

        .menu-item.active {
            background-color: var(--primary-orange);
            color: white;
        }

        .menu-item i {
            margin-left: 8px;
            font-size: 16px;
        }

        /* محتوى الشاشات */
        .content-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--light-gray);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* شاشة البيع - تصميم مضغوط */
        .pos-container {
            display: flex;
            gap: 12px;
            height: 100%;
        }

        .categories-panel {
            width: 180px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .categories-header {
            margin-bottom: 12px;
        }

        .category-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .category-btn {
            display: block;
            width: 100%;
            padding: 10px 6px;
            margin-bottom: 6px;
            background-color: var(--light-blue);
            border: 2px solid var(--dark-blue);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 16px;
            line-height: 1.2;
        }

        .category-btn:hover {
            background-color: var(--dark-blue);
            color: white;
        }

        .category-btn.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .products-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .products-grid {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 5px;
        }

        .product-card {
            background: var(--light-gray);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-orange);
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-blue);
            font-size: 13px;
            line-height: 1.3;
            height: 34px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-price {
            color: var(--success);
            font-weight: bold;
            font-size: 14px;
            margin: 5px 0;
        }

        .product-stock {
            color: var(--dark-gray);
            font-size: 11px;
            margin-bottom: 8px;
        }

        .cart-panel {
            width: 340px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
            max-height: 200px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 6px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }

        .cart-item:hover {
            background-color: var(--light-gray);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .cart-item-price {
            color: var(--success);
            font-weight: bold;
            font-size: 12px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cart-total-section {
            background-color: var(--light-blue);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .discount-input {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            align-items: center;
        }

        .discount-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .discount-type {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .discount-btn {
            flex: 1;
            padding: 6px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .discount-btn.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .cart-total {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            color: var(--dark-blue);
            padding-top: 6px;
            border-top: 2px solid var(--dark-blue);
        }

        .payment-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .payment-method {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }

        .payment-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 13px;
        }

        .payment-btn.active {
            border-color: var(--primary-orange);
            background-color: var(--primary-orange);
            color: white;
        }

        .payment-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 13px;
        }

        /* عناصر عامة */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        .btn-primary {
            background-color: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e68900;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: black;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* المودالات */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 550px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 6px;
        }

        .modal-title {
            color: var(--dark-blue);
            font-size: 18px;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--danger);
        }

        /* فاتورة المبيعات */
        .receipt {
            font-family: 'Courier New', monospace;
            line-height: 1.4;
            text-align: center;
        }

        .receipt-header {
            margin-bottom: 12px;
        }

        .receipt-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 6px;
            display: block;
        }

        .receipt-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark-blue);
            margin-bottom: 4px;
        }

        .receipt-details {
            margin-bottom: 12px;
            text-align: right;
            background-color: var(--light-gray);
            padding: 10px;
            border-radius: 4px;
        }

        .receipt-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .receipt-items th {
            background-color: var(--dark-blue);
            color: white;
            padding: 6px;
            border-bottom: 2px solid var(--primary-orange);
            font-size: 12px;
        }

        .receipt-items td {
            padding: 6px;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
        }

        .receipt-totals {
            text-align: right;
            background-color: var(--light-blue);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .receipt-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px dashed var(--dark-gray);
            text-align: center;
            font-size: 12px;
        }

        /* شاشة المشتريات */
        .purchases-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .section-title {
            font-size: 18px;
            color: var(--dark-blue);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .tab {
            padding: 8px 15px;
            background: var(--light-gray);
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }

        .tab.active {
            background: var(--dark-blue);
            color: white;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--dark-gray);
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 150px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px;
            text-align: right;
            font-size: 13px;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .data-table tr:hover {
            background-color: var(--light-blue);
        }

        .actions-cell {
            display: flex;
            gap: 5px;
        }

        .form-modal {
            max-width: 700px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group.small {
            min-width: 100px;
            flex: 0.5;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
            color: var(--dark-gray);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-orange);
            outline: none;
        }

        .suppliers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .supplier-card {
            background: var(--light-gray);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.3s;
        }

        .supplier-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-orange);
        }

        .supplier-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--dark-blue);
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .supplier-info {
            font-size: 13px;
            margin-bottom: 5px;
        }

        .supplier-info strong {
            color: var(--dark-gray);
        }

        /* البحث الديناميكي */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .search-result-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .search-result-item:hover {
            background-color: var(--light-blue);
        }

        /* معلومات المنتج التلقائية */
        .product-info {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            font-size: 11px;
            color: var(--dark-gray);
        }

        .product-info span {
            padding: 3px 6px;
            background: var(--light-gray);
            border-radius: 3px;
        }

        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 1200px) {
            .pos-container {
                flex-direction: column;
            }
            
            .categories-panel,
            .products-panel,
            .cart-panel {
                width: 100%;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }
        }

        /* طباعة */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .modal-content {
                box-shadow: none;
                width: 100%;
                max-width: 100%;
            }
            
            .receipt-logo {
                width: 40px !important;
                height: 40px !important;
            }
        }

        /* أزرار الكمية */
        .quantity-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .quantity-btn.decrease {
            background-color: var(--danger);
            color: white;
        }

        .quantity-btn.increase {
            background-color: var(--success);
            color: white;
        }

        .item-quantity {
            margin: 0 5px;
            font-weight: bold;
            min-width: 16px;
            text-align: center;
            font-size: 13px;
        }

        /* عرض نصي */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-left {
            text-align: left;
        }

        .mt-5 {
            margin-top: 5px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-5 {
            margin-bottom: 5px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .p-5 {
            padding: 5px;
        }

        .p-10 {
            padding: 10px;
        }

        /* حالة المنتج */
        .out-of-stock {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .out-of-stock:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .out-of-stock-message {
            color: var(--danger);
            font-size: 11px;
            margin-top: 5px;
        }
        
        /* مودال اختيار عدد الصفحات للتصوير */
        .pages-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .pages-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pages-input-group label {
            font-weight: bold;
            min-width: 100px;
        }
        
        .pages-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        /* أزرار إضافة المنتج في صف واحد */
        .product-input-row {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }

        .product-search {
            flex: 2;
            min-width: 200px;
        }

        .product-quantity-input {
            flex: 0.7;
            min-width: 80px;
        }

        .product-cost-input {
            flex: 0.7;
            min-width: 80px;
        }

        .product-price-input {
            flex: 0.7;
            min-width: 80px;
        }

        .product-unit-select {
            flex: 0.8;
            min-width: 90px;
        }

        .product-add-btn {
            flex: 0.3;
            min-width: 40px;
        }

        /* زر حذف معطّل */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* توقيع المطور */
        .signature-card {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80,#2196F3);
            color: white;
            padding: 15px 8px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .signature-card:hover { transform: scale(1.05); box-shadow: 0 12px 35px rgba(0,0,0,0.4); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80,#2196F3);
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }
        @keyframes borderGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .signature-card .name { font-size: 1.3rem; font-weight: 700; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .signature-card .title { font-size: 0.9rem; opacity: 0.9; font-weight: 500; }
        @media (max-width: 768px) { .signature-card { position: relative; bottom: auto; right: auto; margin: 20px auto 0; width: fit-content; animation: none; } .signature-card:hover { transform: none; } }
        
        /* تصميم شاشات الإدارة */
        .admin-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .admin-title {
            font-size: 20px;
            color: var(--dark-blue);
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 5px;
        }

        .admin-tab {
            padding: 10px 20px;
            background: var(--light-gray);
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }

        .admin-tab:hover {
            background: var(--light-blue);
        }

        .admin-tab.active {
            background: var(--dark-blue);
            color: white;
        }

        .admin-card {
            background: var(--light-gray);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-card-title {
            font-size: 18px;
            color: var(--dark-blue);
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .setting-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--dark-gray);
            display: block;
        }

        .setting-description {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background-color: var(--dark-blue);
            color: white;
            padding: 12px;
            text-align: right;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .role-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .role-admin { background-color: var(--danger); color: white; }
        .role-supervisor { background-color: var(--warning); color: black; }
        .role-cashier { background-color: var(--info); color: white; }

        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .category-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item:hover {
            border-color: var(--primary-orange);
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }

        .backup-section {
            background: linear-gradient(135deg, var(--light-blue) 0%, #BBDEFB 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .backup-info {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 13px;
        }

        .backup-info ul {
            margin-right: 20px;
            margin-top: 10px;
        }

        .backup-info li {
            margin-bottom: 5px;
        }

        .print-settings {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .print-setting-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        /* خدمة التصوير السريعة */
        .quick-print-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .quick-print-btn {
            background: var(--light-blue);
            border: 2px solid var(--dark-blue);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .quick-print-btn:hover {
            background: var(--dark-blue);
            color: white;
        }

        .student-discount-settings {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .price-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
        }

        .price-card-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark-blue);
        }

        .price-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--success);
            margin: 10px 0;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- شاشة الدخول -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">
                <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار مكتبة صب واي" onerror="this.onerror=null; this.src='https://via.placeholder.com/90x90?text=LOGO'">
                مكتبة صب واي
            </h1>
            <div class="input-group">
                <label for="username">اسم المستخدم</label>
                <input type="text" id="username" placeholder="Enter username" autocomplete="off" dir="ltr" style="text-align: left;">
            </div>
            <div class="input-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button class="login-btn" id="loginBtn">دخول</button>
        </div>
    </div>

    <!-- الشاشة الرئيسية -->
    <div class="main-container" id="mainScreen">
        <!-- الهيدر -->
        <div class="header">
            <div class="store-info">
                <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار مكتبة صب واي" class="store-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/56x56?text=LOGO'">
                <div class="store-name">مكتبة صب واي</div>
            </div>
            <div class="user-info">
                <span id="currentUserName" style="font-size: 16px;">مستخدم</span>
                <button class="logout-btn" id="logoutBtn">تسجيل خروج</button>
            </div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="content-container">
            <!-- القائمة الجانبية -->
            <div class="sidebar" id="sidebar">
                <h3>القائمة الرئيسية</h3>
                <div class="menu-item active" data-screen="pos">
                    <i class="fas fa-cash-register"></i>
                    <span>شاشة البيع (POS)</span>
                </div>
                <div class="menu-item" data-screen="purchases">
                    <i class="fas fa-shopping-cart"></i>
                    <span>المشتريات</span>
                </div>
                <div class="menu-item" data-screen="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>التقارير</span>
                </div>
                <div class="menu-item" data-screen="inventory">
                    <i class="fas fa-boxes"></i>
                    <span>إدارة المخزون</span>
                </div>
                <div class="menu-item" data-screen="settings">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </div>
            </div>

            <!-- منطقة المحتوى -->
            <div class="content-area">
                <!-- شاشة البيع -->
                <div class="screen active" id="posScreen">
                    <h2 class="screen-title">شاشة البيع (POS)</h2>
                    <div class="pos-container">
                        <!-- فئات المنتجات -->
                        <div class="categories-panel">
                            <div class="categories-header">
                                <h3 style="font-size: 16px;">الفئات</h3>
                            </div>
                            <div class="category-scroll">
                                <button class="category-btn active" data-category="pens">
                                    <i class="fas fa-pen"></i> أقلام
                                </button>
                                <button class="category-btn" data-category="notebooks">
                                    <i class="fas fa-book"></i> دفاتر
                                </button>
                                <button class="category-btn" data-category="office">
                                    <i class="fas fa-briefcase"></i> أدوات مكتبية
                                </button>
                                <button class="category-btn" data-category="envelopes">
                                    <i class="fas fa-envelope"></i> أظرف
                                </button>
                                <button class="category-btn" data-category="papers">
                                    <i class="fas fa-file"></i> أوراق
                                </button>
                                <button class="category-btn" data-category="printing">
                                    <i class="fas fa-print"></i> خدمات التصوير
                                </button>
                                <button class="category-btn" data-category="other">
                                    <i class="fas fa-box"></i> أخرى
                                </button>
                            </div>
                        </div>

                        <!-- المنتجات -->
                        <div class="products-panel">
                            <div class="products-header">
                                <h3 id="currentCategoryTitle" style="font-size: 16px;">أقلام</h3>
                                <div class="cart-summary">
                                    <span>العناصر: <span id="totalItems">0</span></span>
                                </div>
                            </div>
                            <div class="products-grid" id="productGrid">
                                <!-- المنتجات تظهر هنا -->
                            </div>
                        </div>

                        <!-- سلة المشتريات -->
                        <div class="cart-panel">
                            <div class="cart-header">
                                <h3 style="font-size: 16px;">سلة المشتريات</h3>
                                <button class="btn btn-danger btn-sm" id="clearCartBtn">
                                    <i class="fas fa-trash"></i> تفريغ
                                </button>
                            </div>
                            
                            <div class="cart-items" id="cartItems">
                                <!-- عناصر السلة تظهر هنا -->
                                <div class="text-center p-10" id="emptyCartMessage">
                                    <i class="fas fa-shopping-cart fa-lg" style="color: #ddd; margin-bottom: 8px;"></i>
                                    <p style="font-size: 13px;">السلة فارغة</p>
                                    <p style="color: #777; font-size: 11px;">قم بإضافة منتجات من القائمة</p>
                                </div>
                            </div>
                            
                            <div class="cart-total-section">
                                <div class="discount-type">
                                    <button class="discount-btn" data-type="percentage">نسبة %</button>
                                    <button class="discount-btn active" data-type="fixed">مبلغ ثابت</button>
                                </div>
                                <div class="discount-input">
                                    <input type="number" id="discountInput" placeholder="قيمة الخصم" min="0">
                                    <button class="btn btn-warning" id="applyDiscountBtn" style="padding: 6px 10px; font-size: 12px;">تطبيق</button>
                                </div>
                                
                                <div class="cart-summary">
                                    <span>الإجمالي:</span>
                                    <span id="subtotal">0.00 جنيه</span>
                                </div>
                                <div class="cart-summary">
                                    <span>الخصم:</span>
                                    <span id="discountAmount">0.00 جنيه</span>
                                </div>
                                <div class="cart-summary" style="font-weight: bold; font-size: 14px;">
                                    <span>الإجمالي النهائي:</span>
                                    <span id="totalAmount" style="color: var(--success);">0.00 جنيه</span>
                                </div>
                            </div>

                            <div class="payment-section">
                                <div class="payment-method">
                                    <button class="payment-btn active" data-method="cash">
                                        <i class="fas fa-money-bill-wave"></i> نقدي
                                    </button>
                                    <button class="payment-btn" data-method="card">
                                        <i class="fas fa-credit-card"></i> فيزا
                                    </button>
                                </div>
                                
                                <div class="payment-actions">
                                    <button class="action-btn btn-success" id="completeSaleBtn">
                                        <i class="fas fa-check-circle"></i> إتمام البيع
                                    </button>
                                    <button class="action-btn btn-info" id="closeShiftBtn">
                                        <i class="fas fa-lock"></i> إغلاق الشيفت
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- شاشة المشتريات -->
                <div class="screen" id="purchasesScreen">
                    <h2 class="screen-title">المشتريات</h2>
                    <div class="purchases-container">
                        <div class="section-header">
                            <h3 class="section-title">إدارة المشتريات</h3>
                            <button class="btn btn-primary" id="addPurchaseBtn">
                                <i class="fas fa-plus"></i> إضافة شراء جديد
                            </button>
                        </div>

                        <!-- ألسنة التبويب -->
                        <div class="tabs">
                            <button class="tab active" data-tab="purchases-list">قائمة المشتريات</button>
                            <button class="tab" data-tab="suppliers">الموردين</button>
                        </div>

                        <!-- قسم قائمة المشتريات -->
                        <div id="purchases-list-content" class="tab-content">
                            <div class="filters">
                                <div class="filter-group">
                                    <label>من تاريخ</label>
                                    <input type="date" id="filterFromDate">
                                </div>
                                <div class="filter-group">
                                    <label>إلى تاريخ</label>
                                    <input type="date" id="filterToDate">
                                </div>
                                <div class="filter-group">
                                    <label>المورد</label>
                                    <select id="filterSupplier">
                                        <option value="">جميع الموردين</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>حالة الدفع</label>
                                    <select id="filterPaymentStatus">
                                        <option value="">جميع الحالات</option>
                                        <option value="paid">مدفوع</option>
                                        <option value="pending">معلق</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="filterBtn">
                                        <i class="fas fa-filter"></i> تصفية
                                    </button>
                                    <button class="btn btn-secondary" id="resetFilterBtn">
                                        <i class="fas fa-redo"></i> إعادة تعيين
                                    </button>
                                </div>
                            </div>

                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>رقم الفاتورة</th>
                                            <th>التاريخ</th>
                                            <th>المورد</th>
                                            <th>عدد الأصناف</th>
                                            <th>إجمالي الشراء</th>
                                            <th>حالة الدفع</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchasesTableBody">
                                        <!-- البيانات تظهر هنا -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- قسم الموردين -->
                        <div id="suppliers-content" class="tab-content" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">إدارة الموردين</h3>
                                <button class="btn btn-primary" id="addSupplierBtn">
                                    <i class="fas fa-plus"></i> إضافة مورد جديد
                                </button>
                            </div>

                            <div class="filters">
                                <div class="filter-group">
                                    <label>البحث عن مورد</label>
                                    <input type="text" id="searchSupplier" placeholder="ابحث بالاسم أو الهاتف">
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="searchSupplierBtn">
                                        <i class="fas fa-search"></i> بحث
                                    </button>
                                </div>
                            </div>

                            <div class="suppliers-grid" id="suppliersGrid">
                                <!-- الموردين يظهرون هنا -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- شاشة التقارير -->
                <div class="screen" id="reportsScreen">
                    <h2 class="screen-title">التقارير</h2>
                    <div class="admin-container">
                        <div class="admin-tabs">
                            <button class="admin-tab active" data-report="sales">تقارير المبيعات</button>
                            <button class="admin-tab" data-report="purchases">تقارير المشتريات</button>
                            <button class="admin-tab" data-report="inventory">تقارير المخزون</button>
                            <button class="admin-tab" data-report="shifts">تقارير الشيفتات</button>
                        </div>
                        
                        <div id="salesReportContent" class="tab-content">
                            <div class="filters">
                                <div class="filter-group">
                                    <label>من تاريخ</label>
                                    <input type="date" id="salesFromDate">
                                </div>
                                <div class="filter-group">
                                    <label>إلى تاريخ</label>
                                    <input type="date" id="salesToDate">
                                </div>
                                <div class="filter-group">
                                    <label>طريقة الدفع</label>
                                    <select id="salesPaymentMethod">
                                        <option value="">جميع الطرق</option>
                                        <option value="cash">نقدي</option>
                                        <option value="card">فيزا</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="generateSalesReportBtn">
                                        <i class="fas fa-chart-line"></i> توليد التقرير
                                    </button>
                                    <button class="btn btn-success" id="exportSalesBtn">
                                        <i class="fas fa-file-excel"></i> تصدير Excel
                                    </button>
                                </div>
                            </div>
                            
                            <div class="admin-card">
                                <div class="admin-card-title">إحصائيات المبيعات</div>
                                <div id="salesStats" class="text-center p-10">
                                    <p style="font-size: 14px;">قم بتوليد التقرير لعرض الإحصائيات</p>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>رقم الفاتورة</th>
                                            <th>التاريخ</th>
                                            <th>طريقة الدفع</th>
                                            <th>عدد الأصناف</th>
                                            <th>الإجمالي</th>
                                            <th>الخصم</th>
                                            <th>الصافي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesReportTable">
                                        <!-- بيانات تقرير المبيعات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="purchasesReportContent" class="tab-content" style="display: none;">
                            <div class="filters">
                                <div class="filter-group">
                                    <label>من تاريخ</label>
                                    <input type="date" id="purchasesReportFromDate">
                                </div>
                                <div class="filter-group">
                                    <label>إلى تاريخ</label>
                                    <input type="date" id="purchasesReportToDate">
                                </div>
                                <div class="filter-group">
                                    <label>المورد</label>
                                    <select id="purchasesReportSupplier">
                                        <option value="">جميع الموردين</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="generatePurchasesReportBtn">
                                        <i class="fas fa-chart-bar"></i> توليد التقرير
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>رقم الفاتورة</th>
                                            <th>التاريخ</th>
                                            <th>المورد</th>
                                            <th>عدد الأصناف</th>
                                            <th>الإجمالي</th>
                                            <th>حالة الدفع</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchasesReportTable">
                                        <!-- بيانات تقرير المشتريات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="inventoryReportContent" class="tab-content" style="display: none;">
                            <div class="filters">
                                <div class="filter-group">
                                    <label>الفئة</label>
                                    <select id="inventoryCategoryFilter">
                                        <option value="">جميع الفئات</option>
                                        <option value="pens">أقلام</option>
                                        <option value="notebooks">دفاتر</option>
                                        <option value="office">أدوات مكتبية</option>
                                        <option value="envelopes">أظرف</option>
                                        <option value="papers">أوراق</option>
                                        <option value="printing">خدمات التصوير</option>
                                        <option value="other">أخرى</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>حالة المخزون</label>
                                    <select id="inventoryStatusFilter">
                                        <option value="">الكل</option>
                                        <option value="low">منخفض (أقل من 10)</option>
                                        <option value="out">نفذ من المخزون</option>
                                        <option value="normal">طبيعي</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="generateInventoryReportBtn">
                                        <i class="fas fa-boxes"></i> توليد التقرير
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>اسم المنتج</th>
                                            <th>الفئة</th>
                                            <th>المخزون الحالي</th>
                                            <th>سعر الشراء</th>
                                            <th>سعر البيع</th>
                                            <th>قيمة المخزون</th>
                                            <th>آخر حركة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryReportTable">
                                        <!-- بيانات تقرير المخزون -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="shiftsReportContent" class="tab-content" style="display: none;">
                            <div class="filters">
                                <div class="filter-group">
                                    <label>من تاريخ</label>
                                    <input type="date" id="shiftsFromDate">
                                </div>
                                <div class="filter-group">
                                    <label>إلى تاريخ</label>
                                    <input type="date" id="shiftsToDate">
                                </div>
                                <div class="filter-group">
                                    <label>المستخدم</label>
                                    <select id="shiftsUserFilter">
                                        <option value="">جميع المستخدمين</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="generateShiftsReportBtn">
                                        <i class="fas fa-calendar-alt"></i> توليد التقرير
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>رقم الشيفت</th>
                                            <th>التاريخ</th>
                                            <th>المستخدم</th>
                                            <th>وقت الفتح</th>
                                            <th>وقت الإغلاق</th>
                                            <th>المبيعات النقدية</th>
                                            <th>المبيعات بالفيزا</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shiftsReportTable">
                                        <!-- بيانات تقرير الشيفتات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- شاشة المخزون -->
                <div class="screen" id="inventoryScreen">
                    <h2 class="screen-title">إدارة المخزون</h2>
                    <div class="admin-container">
                        <div class="admin-tabs">
                            <button class="admin-tab active" data-inventory="products">المنتجات</button>
                            <button class="admin-tab" data-inventory="categories">الفئات</button>
                            <button class="admin-tab" data-inventory="adjustments">تعديلات المخزون</button>
                            <button class="admin-tab" data-inventory="low-stock">منتجات منخفضة المخزون</button>
                        </div>
                        
                        <div id="productsInventoryContent" class="tab-content">
                            <div class="section-header">
                                <h3 class="section-title">إدارة المنتجات</h3>
                                <button class="btn btn-primary" id="addProductBtn">
                                    <i class="fas fa-plus"></i> إضافة منتج جديد
                                </button>
                            </div>
                            
                            <div class="filters">
                                <div class="filter-group">
                                    <label>البحث في المنتجات</label>
                                    <input type="text" id="productSearchFilter" placeholder="ابحث باسم المنتج">
                                </div>
                                <div class="filter-group">
                                    <label>الفئة</label>
                                    <select id="productCategoryFilter">
                                        <option value="">جميع الفئات</option>
                                        <option value="pens">أقلام</option>
                                        <option value="notebooks">دفاتر</option>
                                        <option value="office">أدوات مكتبية</option>
                                        <option value="envelopes">أظرف</option>
                                        <option value="papers">أوراق</option>
                                        <option value="printing">خدمات التصوير</option>
                                        <option value="other">أخرى</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="searchProductsBtn">
                                        <i class="fas fa-search"></i> بحث
                                    </button>
                                    <button class="btn btn-secondary" id="resetProductsFilterBtn">
                                        <i class="fas fa-redo"></i> إعادة تعيين
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>اسم المنتج</th>
                                            <th>الفئة</th>
                                            <th>المخزون</th>
                                            <th>سعر الشراء</th>
                                            <th>سعر البيع</th>
                                            <th>الوحدة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryProductsTable">
                                        <!-- جدول المنتجات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="categoriesInventoryContent" class="tab-content" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">إدارة الفئات</h3>
                                <button class="btn btn-primary" id="addCategoryBtn">
                                    <i class="fas fa-plus"></i> إضافة فئة جديدة
                                </button>
                            </div>
                            
                            <div class="category-list" id="categoriesList">
                                <!-- قائمة الفئات -->
                            </div>
                        </div>
                        
                        <div id="adjustmentsInventoryContent" class="tab-content" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">تعديلات المخزون</h3>
                                <button class="btn btn-primary" id="addAdjustmentBtn">
                                    <i class="fas fa-plus"></i> إضافة تعديل
                                </button>
                            </div>
                            
                            <div class="filters">
                                <div class="filter-group">
                                    <label>من تاريخ</label>
                                    <input type="date" id="adjustmentFromDate">
                                </div>
                                <div class="filter-group">
                                    <label>إلى تاريخ</label>
                                    <input type="date" id="adjustmentToDate">
                                </div>
                                <div class="filter-group">
                                    <label>نوع التعديل</label>
                                    <select id="adjustmentTypeFilter">
                                        <option value="">جميع الأنواع</option>
                                        <option value="add">إضافة</option>
                                        <option value="remove">خصم</option>
                                        <option value="correction">تصحيح</option>
                                    </select>
                                </div>
                                <div style="align-self: flex-end;">
                                    <button class="btn btn-primary" id="filterAdjustmentsBtn">
                                        <i class="fas fa-filter"></i> تصفية
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>اسم المنتج</th>
                                            <th>نوع التعديل</th>
                                            <th>الكمية السابقة</th>
                                            <th>الكمية الجديدة</th>
                                            <th>الفرق</th>
                                            <th>سبب التعديل</th>
                                            <th>المستخدم</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adjustmentsTable">
                                        <!-- جدول التعديلات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="lowStockInventoryContent" class="tab-content" style="display: none;">
                            <div class="admin-card">
                                <div class="admin-card-title">منتجات منخفضة المخزون</div>
                                <div class="text-center p-10" id="lowStockWarning">
                                    <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--warning); margin-bottom: 10px;"></i>
                                    <p>المنتجات التالية تحتاج إلى إعادة طلب</p>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>اسم المنتج</th>
                                                <th>الفئة</th>
                                                <th>المخزون الحالي</th>
                                                <th>حد إعادة الطلب</th>
                                                <th>الفرق</th>
                                                <th>آخر سعر شراء</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lowStockTable">
                                            <!-- جدول المنتجات المنخفضة -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- شاشة الإعدادات -->
                <div class="screen" id="settingsScreen">
                    <h2 class="screen-title">الإعدادات</h2>
                    <div class="admin-container">
                        <div class="admin-tabs">
                            <button class="admin-tab active" data-settings="users">إدارة المستخدمين</button>
                            <button class="admin-tab" data-settings="print-services">خدمات التصوير</button>
                            <button class="admin-tab" data-settings="pricing">إعدادات الأسعار</button>
                            <button class="admin-tab" data-settings="printing">إعدادات الطباعة</button>
                            <button class="admin-tab" data-settings="backup">النسخ الاحتياطي</button>
                            <button class="admin-tab" data-settings="system">إعدادات النظام</button>
                        </div>
                        
                        <div id="usersSettingsContent" class="tab-content">
                            <div class="section-header">
                                <h3 class="section-title">إدارة المستخدمين</h3>
                                <button class="btn btn-primary" id="addUserBtn">
                                    <i class="fas fa-user-plus"></i> إضافة مستخدم جديد
                                </button>
                            </div>
                            
                            <div class="table-container">
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>اسم المستخدم</th>
                                            <th>الاسم الكامل</th>
                                            <th>الدور</th>
                                            <th>حالة الحساب</th>
                                            <th>تاريخ الإنشاء</th>
                                            <th>آخر دخول</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTable">
                                        <!-- جدول المستخدمين -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="printServicesSettingsContent" class="tab-content" style="display: none;">
                            <div class="admin-card">
                                <div class="admin-card-title">خدمات التصوير</div>
                                
                                <div class="price-grid">
                                    <div class="price-card">
                                        <div class="price-card-title">تصوير أبيض/أسود</div>
                                        <div class="price-value" id="bwPrice">0.50 جنيه</div>
                                        <div class="setting-description">سعر التصوير العادي للصفحة الواحدة</div>
                                        <button class="btn btn-primary btn-sm mt-10" onclick="editPrice('bw')">
                                            <i class="fas fa-edit"></i> تعديل السعر
                                        </button>
                                    </div>
                                    
                                    <div class="price-card">
                                        <div class="price-card-title">تصوير ملون</div>
                                        <div class="price-value" id="colorPrice">2.00 جنيه</div>
                                        <div class="setting-description">سعر التصوير الملون للصفحة الواحدة</div>
                                        <button class="btn btn-primary btn-sm mt-10" onclick="editPrice('color')">
                                            <i class="fas fa-edit"></i> تعديل السعر
                                        </button>
                                    </div>
                                    
                                    <div class="price-card">
                                        <div class="price-card-title">تغليف ورق شفاف</div>
                                        <div class="price-value" id="laminationPrice">3.00 جنيه</div>
                                        <div class="setting-description">سعر التغليف للورقة الواحدة</div>
                                        <button class="btn btn-primary btn-sm mt-10" onclick="editPrice('lamination')">
                                            <i class="fas fa-edit"></i> تعديل السعر
                                        </button>
                                    </div>
                                    
                                    <div class="price-card">
                                        <div class="price-card-title">تغليف حراري</div>
                                        <div class="price-value" id="thermalPrice">5.00 جنيه</div>
                                        <div class="setting-description">سعر التغليف الحراري للورقة</div>
                                        <button class="btn btn-primary btn-sm mt-10" onclick="editPrice('thermal')">
                                            <i class="fas fa-edit"></i> تعديل السعر
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="student-discount-settings mt-20">
                                    <h4 style="margin-bottom: 15px; color: var(--dark-blue);">خصومات الطلبة</h4>
                                    
                                    <div class="setting-item">
                                        <label class="setting-label">نسبة خصم الطلبة</label>
                                        <input type="number" id="studentDiscountPercent" class="form-control" value="40" min="0" max="100" style="width: 100px;">
                                        <div class="setting-description">نسبة الخصم التي يحصل عليها الطلبة على خدمات التصوير</div>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label class="setting-label">تفعيل خصم الطلبة تلقائياً</label>
                                        <select id="autoStudentDiscount" class="form-control" style="width: 150px;">
                                            <option value="yes">نعم</option>
                                            <option value="no">لا</option>
                                        </select>
                                        <div class="setting-description">عند تفعيله، سيتم تطبيق خصم الطلبة تلقائياً عند اختيار خدمة تصوير طالب</div>
                                    </div>
                                    
                                    <button class="btn btn-success mt-10" id="savePrintSettingsBtn">
                                        <i class="fas fa-save"></i> حفظ الإعدادات
                                    </button>
                                </div>
                            </div>
                            
                            <div class="admin-card mt-20">
                                <div class="admin-card-title">خدمة التصوير السريعة</div>
                                <p style="margin-bottom: 15px; font-size: 14px;">أزرار سريعة لإضافة خدمات التصوير مباشرة إلى سلة المشتريات</p>
                                
                                <div class="quick-print-buttons">
                                    <button class="quick-print-btn" data-service="bw">
                                        <i class="fas fa-print"></i> تصوير أبيض/أسود
                                    </button>
                                    <button class="quick-print-btn" data-service="color">
                                        <i class="fas fa-print" style="color: #FF4081;"></i> تصوير ملون
                                    </button>
                                    <button class="quick-print-btn" data-service="student-bw">
                                        <i class="fas fa-user-graduate"></i> طالب أبيض/أسود
                                    </button>
                                    <button class="quick-print-btn" data-service="student-color">
                                        <i class="fas fa-user-graduate" style="color: #FF4081;"></i> طالب ملون
                                    </button>
                                    <button class="quick-print-btn" data-service="lamination">
                                        <i class="fas fa-file-contract"></i> تغليف شفاف
                                    </button>
                                    <button class="quick-print-btn" data-service="thermal">
                                        <i class="fas fa-fire"></i> تغليف حراري
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="pricingSettingsContent" class="tab-content" style="display: none;">
                            <div class="admin-card">
                                <div class="admin-card-title">إعدادات الأسعار العامة</div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">هامش الربح الافتراضي (%)</label>
                                    <input type="number" id="defaultProfitMargin" class="form-control" value="50" min="0" max="500" style="width: 100px;">
                                    <div class="setting-description">هامش الربح الافتراضي الذي يضاف إلى سعر الشراء لتحديد سعر البيع</div>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تحديث أسعار البيع تلقائياً</label>
                                    <select id="autoUpdatePrices" class="form-control" style="width: 150px;">
                                        <option value="yes">نعم</option>
                                        <option value="no">لا</option>
                                    </select>
                                    <div class="setting-description">عند تفعيله، سيتم تحديث أسعار البيع تلقائياً عند تغيير سعر الشراء</div>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تقريب الأسعار إلى أقرب</label>
                                    <select id="priceRounding" class="form-control" style="width: 150px;">
                                        <option value="0.05">5 قروش</option>
                                        <option value="0.10">10 قروش</option>
                                        <option value="0.25">25 قرش</option>
                                        <option value="0.50">50 قرش</option>
                                        <option value="1">1 جنيه</option>
                                        <option value="none">بدون تقريب</option>
                                    </select>
                                    <div class="setting-description">تقريب أسعار البيع لتكون أكثر جاذبية للعملاء</div>
                                </div>
                                
                                <button class="btn btn-success mt-10" id="savePricingSettingsBtn">
                                    <i class="fas fa-save"></i> حفظ الإعدادات
                                </button>
                            </div>
                        </div>
                        
                        <div id="printingSettingsContent" class="tab-content" style="display: none;">
                            <div class="admin-card">
                                <div class="admin-card-title">إعدادات الطباعة والفواتير</div>
                                
                                <div class="print-settings">
                                    <div class="print-setting-item">
                                        <label class="setting-label">اسم المتجر في الفاتورة</label>
                                        <input type="text" id="storeNamePrint" class="form-control" value="مكتبة صب واي" style="width: 100%;">
                                    </div>
                                    
                                    <div class="print-setting-item">
                                        <label class="setting-label">عنوان المتجر</label>
                                        <input type="text" id="storeAddress" class="form-control" value="شارع المكتبات، وسط البلد" style="width: 100%;">
                                    </div>
                                    
                                    <div class="print-setting-item">
                                        <label class="setting-label">هاتف المتجر</label>
                                        <input type="text" id="storePhone" class="form-control" value="0100-123-4567" style="width: 100%;">
                                    </div>
                                    
                                    <div class="print-setting-item">
                                        <label class="setting-label">تذييل الفاتورة</label>
                                        <textarea id="receiptFooter" class="form-control" rows="3" style="width: 100%;">شكراً لزيارتكم مكتبة صب واي - نرجو زيارتنا مرة أخرى</textarea>
                                    </div>
                                    
                                    <div class="print-setting-item">
                                        <label class="setting-label">حجم الورق</label>
                                        <select id="paperSize" class="form-control" style="width: 100%;">
                                            <option value="58mm">58 ملم (فاتورة صغيرة)</option>
                                            <option value="80mm">80 ملم (فاتورة متوسطة)</option>
                                            <option value="A4">A4 (فاتورة كبيرة)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="print-setting-item">
                                        <label class="setting-label">الطباعة التلقائية</label>
                                        <select id="autoPrint" class="form-control" style="width: 100%;">
                                            <option value="no">لا</option>
                                            <option value="yes">نعم، طباعة فاتورة بعد كل بيع</option>
                                            <option value="ask">السؤال قبل الطباعة</option>
                                        </select>
                                    </div>
                                    
                                    <div class="print-setting-item">
                                        <label class="setting-label">عدد نسخ الفاتورة</label>
                                        <input type="number" id="receiptCopies" class="form-control" value="1" min="1" max="3" style="width: 100px;">
                                    </div>
                                </div>
                                
                                <button class="btn btn-success mt-20" id="savePrintingSettingsBtn">
                                    <i class="fas fa-save"></i> حفظ إعدادات الطباعة
                                </button>
                                
                                <button class="btn btn-primary mt-10" id="testPrintBtn">
                                    <i class="fas fa-print"></i> طباعة تجريبية
                                </button>
                            </div>
                        </div>
                        
                        <div id="backupSettingsContent" class="tab-content" style="display: none;">
                            <div class="backup-section">
                                <h3 style="margin-bottom: 15px; color: var(--dark-blue);">النسخ الاحتياطي واستعادة البيانات</h3>
                                
                                <div class="backup-actions">
                                    <button class="btn btn-primary" id="createBackupBtn">
                                        <i class="fas fa-download"></i> إنشاء نسخة احتياطية الآن
                                    </button>
                                    <button class="btn btn-success" id="restoreBackupBtn">
                                        <i class="fas fa-upload"></i> استعادة من نسخة احتياطية
                                    </button>
                                    <button class="btn btn-info" id="autoBackupSettingsBtn">
                                        <i class="fas fa-cog"></i> إعدادات النسخ التلقائي
                                    </button>
                                </div>
                                
                                <div class="backup-info">
                                    <p><strong>معلومات النسخ الاحتياطي:</strong></p>
                                    <ul>
                                        <li>آخر نسخة احتياطية: <span id="lastBackupDate">لم يتم إنشاء نسخة بعد</span></li>
                                        <li>حجم النسخة الاحتياطية: <span id="backupSize">0 كيلوبايت</span></li>
                                        <li>عدد النسخ المحفوظة: <span id="backupCount">0</span></li>
                                        <li>النسخ التلقائي: <span id="autoBackupStatus">غير مفعل</span></li>
                                    </ul>
                                </div>
                                
                                <div class="table-container mt-20">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>اسم الملف</th>
                                                <th>التاريخ</th>
                                                <th>الحجم</th>
                                                <th>نوع البيانات</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="backupFilesTable">
                                            <!-- قائمة ملفات النسخ الاحتياطية -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div id="systemSettingsContent" class="tab-content" style="display: none;">
                            <div class="admin-card">
                                <div class="admin-card-title">إعدادات النظام العامة</div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">اسم النظام</label>
                                    <input type="text" id="systemName" class="form-control" value="نظام إدارة مكتبة صب واي" style="width: 100%;">
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">العملة الافتراضية</label>
                                    <select id="defaultCurrency" class="form-control" style="width: 150px;">
                                        <option value="EGP">جنيه مصري (ج.م)</option>
                                        <option value="USD">دولار أمريكي ($)</option>
                                        <option value="SAR">ريال سعودي (ر.س)</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تنسيق التاريخ</label>
                                    <select id="dateFormat" class="form-control" style="width: 150px;">
                                        <option value="dd/mm/yyyy">يوم/شهر/سنة</option>
                                        <option value="mm/dd/yyyy">شهر/يوم/سنة</option>
                                        <option value="yyyy-mm-dd">سنة-شهر-يوم</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">اللغة الافتراضية</label>
                                    <select id="defaultLanguage" class="form-control" style="width: 150px;">
                                        <option value="ar">العربية</option>
                                        <option value="en">الإنجليزية</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">وقت إغلاق الشيفت التلقائي</label>
                                    <select id="autoShiftClose" class="form-control" style="width: 200px;">
                                        <option value="never">لا تغلق تلقائياً</option>
                                        <option value="midnight">منتصف الليل</option>
                                        <option value="6pm">6 مساءً</option>
                                        <option value="custom">وقت مخصص</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">التنبيه عند انخفاض المخزون</label>
                                    <select id="lowStockAlert" class="form-control" style="width: 150px;">
                                        <option value="yes">نعم</option>
                                        <option value="no">لا</option>
                                    </select>
                                    <div class="setting-description">عند تفعيله، سيتم إظهار تنبيه عند وصول أي منتج إلى الحد الأدنى للمخزون</div>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">حد إعادة الطلب الافتراضي</label>
                                    <input type="number" id="defaultReorderLevel" class="form-control" value="10" min="1" style="width: 100px;">
                                    <div class="setting-description">الحد الأدنى للمخزون الذي عند الوصول إليه يتم إظهار المنتج في قائمة "منخفضة المخزون"</div>
                                </div>
                                
                                <button class="btn btn-success mt-20" id="saveSystemSettingsBtn">
                                    <i class="fas fa-save"></i> حفظ إعدادات النظام
                                </button>
                                
                                <button class="btn btn-danger mt-10" id="resetSystemBtn">
                                    <i class="fas fa-redo"></i> إعادة تعيين النظام
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إغلاق الشيفت -->
    <div class="modal" id="closeShiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إغلاق الشيفت</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="closeShiftContent">
                <div class="receipt">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار المكتبة" class="receipt-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=LOGO'">
                        <div class="receipt-title">مكتبة صب واي</div>
                        <div style="margin-bottom: 12px; font-size: 14px;">تقرير إغلاق الشيفت</div>
                    </div>
                    
                    <div class="receipt-details">
                        <div><strong>التاريخ:</strong> <span id="shiftDate">22-12-2025</span></div>
                        <div><strong>الوقت:</strong> <span id="shiftTime">10:30:15</span></div>
                        <div><strong>المستخدم:</strong> <span id="shiftUser">ياسر</span></div>
                        <div><strong>وقت فتح الشيفت:</strong> <span id="shiftOpenTime">09:00:00</span></div>
                    </div>
                    
                    <h4 style="text-align: right; margin-bottom: 6px; font-size: 15px;">الأصناف المباعة:</h4>
                    <table class="receipt-items" id="shiftItemsTable">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody id="shiftItemsBody">
                            <!-- العناصر تظهر هنا -->
                        </tbody>
                    </table>
                    
                    <div class="receipt-totals">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>إجمالي المبيعات النقدية:</span>
                            <span id="shiftCashTotal">0.00 جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>إجمالي المبيعات بالفيزا:</span>
                            <span id="shiftCardTotal">0.00 جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: bold; font-size: 14px;">
                            <span>إجمالي المبيعات:</span>
                            <span id="shiftTotalSales">0.00 جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                            <span>عدد الأصناف المباعة:</span>
                            <span id="shiftItemsCount">0</span>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p style="font-size: 12px;">تم إنشاء التقرير بواسطة نظام إدارة مكتبة صب واي</p>
                        <p style="font-size: 10px; color: #777;">جميع الحقوق محفوظة © 2025</p>
                    </div>
                </div>
                
                <div style="margin-top: 12px; text-align: center;">
                    <button class="btn btn-primary" id="printShiftReportBtn" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button class="btn btn-success" id="saveShiftReportBtn" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-save"></i> حفظ التقرير
                    </button>
                    <button class="btn btn-danger" id="cancelCloseShiftBtn" style="padding: 8px 12px; font-size: 13px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إتمام البيع -->
    <div class="modal" id="completeSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">فاتورة البيع</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="receiptContent">
                <!-- محتوى الفاتورة يظهر هنا -->
            </div>
            <div style="display: flex; gap: 6px; margin-top: 12px;">
                <button class="btn btn-success" id="saveReceiptBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-save"></i> حفظ الفاتورة
                </button>
                <button class="btn btn-primary" id="saveAndPrintBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-print"></i> حفظ وطباعة
                </button>
                <button class="btn btn-danger" id="cancelSaleBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- مودال اختيار عدد الصفحات للتصوير -->
    <div class="modal" id="printingPagesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">اختيار عدد الصفحات</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <div class="pages-input">
                    <div class="pages-input-group">
                        <label>عدد الصفحات:</label>
                        <input type="number" id="printingPagesCount" min="1" value="1" placeholder="أدخل عدد الصفحات">
                    </div>
                    <div class="pages-input-group">
                        <label>نوع التصوير:</label>
                        <select id="printingTypeSelect">
                            <option value="27">تصوير أبيض/أسود (0.5 جنيه للصفحة)</option>
                            <option value="28">تصوير ملون (2 جنيه للصفحة)</option>
                            <option value="29">تصوير طالب أبيض/أسود (0.3 جنيه للصفحة)</option>
                            <option value="30">تصوير طالب ملون (1.5 جنيه للصفحة)</option>
                        </select>
                    </div>
                    <div class="pages-input-group">
                        <label>السعر الإجمالي:</label>
                        <input type="text" id="printingTotalPrice" readonly>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="confirmPrintingBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-check"></i> تأكيد الإضافة
                    </button>
                    <button class="btn btn-danger" id="cancelPrintingBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال فاتورة الشراء -->
    <div class="modal" id="purchaseReceiptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">فاتورة الشراء</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="purchaseReceiptContent">
                <!-- محتوى فاتورة الشراء يظهر هنا -->
            </div>
            <div style="display: flex; gap: 6px; margin-top: 12px;">
                <button class="btn btn-primary" id="printPurchaseReceiptBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
                                <button class="btn btn-danger" id="closePurchaseReceiptBtn" style="flex: 1; padding: 10px; font-size: 13px;">
                                    <i class="fas fa-times"></i> إغلاق
                                </button>
                            </div>
                        </div>
                    </div>

    <!-- مودال إضافة/تعديل شراء -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="purchaseModalTitle">إضافة شراء جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="purchaseFormContent">
                <div class="form-row">
                    <div class="form-group">
                        <label>رقم فاتورة المورد (اختياري)</label>
                        <input type="text" id="purchaseInvoiceNumber" placeholder="رقم فاتورة المورد">
                    </div>
                    <div class="form-group">
                        <label>التاريخ *</label>
                        <input type="date" id="purchaseDate" value="<?php echo date('Y-m-d'); ?>">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>المورد *</label>
                        <select id="purchaseSupplier">
                            <option value="">اختر المورد</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>طريقة الدفع</label>
                        <select id="purchasePaymentMethod">
                            <option value="cash">نقدي</option>
                            <option value="credit">آجل</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <input type="text" id="purchaseNotes" placeholder="ملاحظات إضافية">
                    </div>
                </div>
                
                <div style="margin: 20px 0; border-top: 2px solid var(--light-gray); padding-top: 15px;">
                    <h4 style="margin-bottom: 15px; color: var(--dark-blue);">الأصناف</h4>
                    
                    <!-- صف إضافة منتج -->
                    <div class="product-input-row">
                        <div class="product-search">
                            <div class="search-container">
                                <input type="text" id="productSearchInput" placeholder="ابحث عن المنتج..." autocomplete="off">
                                <div class="search-results" id="productSearchResults"></div>
                            </div>
                            <div class="product-info" id="productInfo" style="display: none;">
                                <span id="currentStock">المخزون: 0</span>
                                <span id="lastCost">آخر سعر شراء: 0.00</span>
                            </div>
                        </div>
                        
                        <div class="product-quantity-input">
                            <input type="number" id="productQuantity" placeholder="الكمية" min="1" value="1">
                        </div>
                        
                        <div class="product-cost-input">
                            <input type="number" id="productCost" placeholder="سعر الشراء" step="0.01" min="0">
                        </div>
                        
                        <div class="product-price-input">
                            <input type="number" id="productSalePrice" placeholder="سعر البيع" step="0.01" min="0">
                        </div>
                        
                        <div class="product-unit-select">
                            <select id="productUnit">
                                <option value="حبة">حبة</option>
                                <option value="باكت">باكت</option>
                                <option value="كرتون">كرتون</option>
                                <option value="رزمة">رزمة</option>
                                <option value="علبة">علبة</option>
                                <option value="صفحة">صفحة</option>
                            </select>
                        </div>
                        
                        <div class="product-add-btn">
                            <button class="btn btn-primary" id="addProductToPurchaseBtn" style="width: 100%;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="max-height: 200px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية</th>
                                    <th>سعر الشراء</th>
                                    <th>سعر البيع</th>
                                    <th>الوحدة</th>
                                    <th>الإجمالي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsTable">
                                <!-- العناصر المضافة تظهر هنا -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span>إجمالي المشتريات:</span>
                            <span id="purchaseTotal">0.00 جنيه</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="savePurchaseBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ الشراء
                    </button>
                    <button class="btn btn-warning" id="updatePurchaseBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث الشراء
                    </button>
                    <button class="btn btn-danger" id="cancelPurchaseBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إضافة/تعديل مورد -->
    <div class="modal" id="supplierModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="supplierModalTitle">إضافة مورد جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="supplierFormContent">
                <div class="form-row">
                    <div class="form-group">
                        <label>اسم المورد *</label>
                        <input type="text" id="supplierName" placeholder="اسم المورد">
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف *</label>
                        <input type="text" id="supplierPhone" placeholder="رقم الهاتف">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="supplierEmail" placeholder="البريد الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label>الموقع</label>
                        <input type="text" id="supplierLocation" placeholder="الموقع">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>رقم السجل التجاري</label>
                        <input type="text" id="supplierCommercialRegister" placeholder="رقم السجل التجاري">
                    </div>
                    <div class="form-group">
                        <label>الرقم الضريبي</label>
                        <input type="text" id="supplierTaxNumber" placeholder="الرقم الضريبي">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>ملاحظات</label>
                        <textarea id="supplierNotes" placeholder="ملاحظات إضافية" rows="3"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="saveSupplierBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ المورد
                    </button>
                    <button class="btn btn-warning" id="updateSupplierBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث المورد
                    </button>
                    <button class="btn btn-danger" id="cancelSupplierBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إضافة/تعديل مستخدم -->
    <div class="modal" id="userModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">إضافة مستخدم جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="userFormContent">
                <div class="form-row">
                    <div class="form-group">
                        <label>اسم المستخدم *</label>
                        <input type="text" id="userUsername" placeholder="اسم المستخدم (للدخول)">
                    </div>
                    <div class="form-group">
                        <label>كلمة المرور *</label>
                        <input type="password" id="userPassword" placeholder="كلمة المرور">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>الاسم الكامل *</label>
                        <input type="text" id="userFullName" placeholder="الاسم الكامل">
                    </div>
                    <div class="form-group">
                        <label>الدور *</label>
                        <select id="userRole">
                            <option value="admin">مدير</option>
                            <option value="supervisor">مشرف</option>
                            <option value="cashier">بائع</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="userEmail" placeholder="البريد الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" id="userPhone" placeholder="رقم الهاتف">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>حالة الحساب</label>
                        <select id="userStatus">
                            <option value="active">نشط</option>
                            <option value="inactive">غير نشط</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="saveUserBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ المستخدم
                    </button>
                    <button class="btn btn-warning" id="updateUserBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث المستخدم
                    </button>
                    <button class="btn btn-danger" id="cancelUserBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إضافة/تعديل منتج -->
    <div class="modal" id="productModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">إضافة منتج جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="productFormContent">
                <div class="form-row">
                    <div class="form-group">
                        <label>اسم المنتج *</label>
                        <input type="text" id="productName" placeholder="اسم المنتج">
                    </div>
                    <div class="form-group">
                        <label>الفئة *</label>
                        <select id="productCategory">
                            <option value="pens">أقلام</option>
                            <option value="notebooks">دفاتر</option>
                            <option value="office">أدوات مكتبية</option>
                            <option value="envelopes">أظرف</option>
                            <option value="papers">أوراق</option>
                            <option value="printing">خدمات التصوير</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>سعر الشراء *</label>
                        <input type="number" id="productCostPrice" placeholder="سعر الشراء" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>سعر البيع *</label>
                        <input type="number" id="productSellingPrice" placeholder="سعر البيع" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>الكمية في المخزون *</label>
                        <input type="number" id="productStock" placeholder="الكمية" min="0">
                    </div>
                    <div class="form-group">
                        <label>الوحدة *</label>
                        <select id="productUnit">
                            <option value="حبة">حبة</option>
                            <option value="باكت">باكت</option>
                            <option value="كرتون">كرتون</option>
                            <option value="رزمة">رزمة</option>
                            <option value="علبة">علبة</option>
                            <option value="صفحة">صفحة</option>
                            <option value="متر">متر</option>
                            <option value="كيلو">كيلو</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>حد إعادة الطلب</label>
                        <input type="number" id="productReorderLevel" placeholder="الحد الأدنى للمخزون" min="0" value="10">
                    </div>
                    <div class="form-group">
                        <label>رمز المنتج (باركود)</label>
                        <input type="text" id="productBarcode" placeholder="رمز المنتج (اختياري)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>ملاحظات</label>
                        <textarea id="productNotes" placeholder="ملاحظات إضافية" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productIsService"> خدمة (بدون مخزون)
                        </label>
                        <div class="setting-description">مثل خدمات التصوير والتغليف</div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productHasDiscount"> يسمح بالخصم
                        </label>
                        <div class="setting-description">السماح بتطبيق خصم على هذا المنتج</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="saveProductBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ المنتج
                    </button>
                    <button class="btn btn-warning" id="updateProductBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث المنتج
                    </button>
                    <button class="btn btn-danger" id="cancelProductBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إضافة/تعديل فئة -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="categoryModalTitle">إضافة فئة جديدة</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="categoryFormContent">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>اسم الفئة *</label>
                    <input type="text" id="categoryName" placeholder="اسم الفئة" style="width: 100%; padding: 10px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>وصف الفئة</label>
                    <textarea id="categoryDescription" placeholder="وصف الفئة" rows="3" style="width: 100%; padding: 10px;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>أيقونة الفئة</label>
                    <select id="categoryIcon" style="width: 100%; padding: 10px;">
                        <option value="fa-pen">أقلام</option>
                        <option value="fa-book">دفاتر</option>
                        <option value="fa-briefcase">أدوات مكتبية</option>
                        <option value="fa-envelope">أظرف</option>
                        <option value="fa-file">أوراق</option>
                        <option value="fa-print">تصوير</option>
                        <option value="fa-box">أخرى</option>
                        <option value="fa-pencil-alt">قرطاسية</option>
                        <option value="fa-ruler">أدوات هندسية</option>
                        <option value="fa-scissors">مقص ومبراة</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="saveCategoryBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ الفئة
                    </button>
                    <button class="btn btn-warning" id="updateCategoryBtn" style="flex: 1; padding: 10px; display: none;">
                        <i class="fas fa-edit"></i> تحديث الفئة
                    </button>
                    <button class="btn btn-danger" id="cancelCategoryBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تعديل السعر -->
    <div class="modal" id="priceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="priceModalTitle">تعديل السعر</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="priceFormContent">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label id="priceItemName">اسم الخدمة</label>
                    <input type="text" id="priceValue" placeholder="السعر الجديد" style="width: 100%; padding: 10px; font-size: 18px; text-align: center;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>ملاحظات التعديل</label>
                    <input type="text" id="priceNotes" placeholder="ملاحظات (اختياري)" style="width: 100%; padding: 10px;">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="savePriceBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ السعر
                    </button>
                    <button class="btn btn-danger" id="cancelPriceBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تعديل المخزون -->
    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="inventoryModalTitle">تعديل المخزون</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="inventoryFormContent">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label id="inventoryProductName">اسم المنتج</label>
                    <div style="font-size: 14px; color: #777; margin-bottom: 10px;" id="inventoryCurrentStock">المخزون الحالي: 0</div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>نوع التعديل *</label>
                    <select id="inventoryAdjustmentType" style="width: 100%; padding: 10px;">
                        <option value="add">إضافة إلى المخزون</option>
                        <option value="remove">خصم من المخزون</option>
                        <option value="set">تعيين قيمة جديدة</option>
                        <option value="correction">تصحيح خطأ</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>الكمية *</label>
                    <input type="number" id="inventoryQuantity" placeholder="الكمية" min="1" style="width: 100%; padding: 10px; text-align: center;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>سبب التعديل *</label>
                    <select id="inventoryReason" style="width: 100%; padding: 10px;">
                        <option value="purchase">شراء جديد</option>
                        <option value="sale">بيع</option>
                        <option value="return">مرتجع</option>
                        <option value="damage">تالف</option>
                        <option value="correction">تصحيح عد</option>
                        <option value="other">أخرى</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>ملاحظات إضافية</label>
                    <textarea id="inventoryNotes" placeholder="ملاحظات إضافية" rows="3" style="width: 100%; padding: 10px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" id="saveInventoryBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-save"></i> حفظ التعديل
                    </button>
                    <button class="btn btn-danger" id="cancelInventoryBtn" style="flex: 1; padding: 10px;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال النسخ الاحتياطي -->
    <div class="modal" id="backupModal">
        <div class="modal-content form-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="backupModalTitle">النسخ الاحتياطي</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="backupFormContent">
                <div class="admin-card">
                    <div class="admin-card-title">إنشاء نسخة احتياطية</div>
                    <div class="setting-item">
                        <label class="setting-label">اسم النسخة الاحتياطية</label>
                        <input type="text" id="backupName" class="form-control" value="نسخة احتياطية" style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">نوع البيانات</label>
                        <select id="backupType" class="form-control" style="width: 100%;">
                            <option value="full">نسخة كاملة (جميع البيانات)</option>
                            <option value="sales">المبيعات فقط</option>
                            <option value="inventory">المخزون فقط</option>
                            <option value="custom">مخصص</option>
                        </select>
                    </div>
                    <div class="setting-item" id="customBackupOptions" style="display: none;">
                        <label class="setting-label">اختر البيانات المراد نسخها</label>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" id="backupProducts" checked> المنتجات والمخزون
                            </label>
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" id="backupSales" checked> المبيعات والفواتير
                            </label>
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" id="backupPurchases" checked> المشتريات والموردين
                            </label>
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" id="backupUsers" checked> المستخدمين والإعدادات
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">كلمة مرور النسخة (اختياري)</label>
                        <input type="password" id="backupPassword" class="form-control" placeholder="كلمة مرور لحماية الملف" style="width: 100%;">
                        <div class="setting-description">لحماية النسخة الاحتياطية من الوصول غير المصرح به</div>
                    </div>
                    
                    <button class="btn btn-primary mt-10" id="startBackupBtn" style="width: 100%; padding: 12px;">
                        <i class="fas fa-download"></i> بدء إنشاء النسخة الاحتياطية
                    </button>
                </div>
                
                <div class="admin-card mt-20">
                    <div class="admin-card-title">استعادة من نسخة احتياطية</div>
                    <div class="setting-item">
                        <label class="setting-label">اختر ملف النسخة الاحتياطية</label>
                        <input type="file" id="restoreFile" class="form-control" accept=".json,.backup" style="width: 100%; padding: 5px;">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">كلمة مرور الملف (إذا كانت محمية)</label>
                        <input type="password" id="restorePassword" class="form-control" placeholder="أدخل كلمة المرور" style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">خيارات الاستعادة</label>
                        <select id="restoreOptions" class="form-control" style="width: 100%;">
                            <option value="merge">دمج مع البيانات الحالية</option>
                            <option value="replace">استبدال البيانات الحالية</option>
                        </select>
                        <div class="setting-description">تحذير: استبدال البيانات الحالية سيمحو جميع البيانات الحالية ويستبدلها ببيانات النسخة الاحتياطية</div>
                    </div>
                    
                    <button class="btn btn-success mt-10" id="startRestoreBtn" style="width: 100%; padding: 12px;">
                        <i class="fas fa-upload"></i> بدء عملية الاستعادة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- توقيع المطور -->
    <div class="signature-card">
        <div class="name">Yasser Elkhateeb</div>
        <div class="title">مطور البرنامج 01146118541</div>
    </div>

    <script>
        // البيانات الافتراضية
        const defaultUsers = [
            { 
                id: 1, 
                username: "yasser", 
                password: "123", 
                role: "admin", 
                name: "ياسر (مدير)",
                email: "yasser@example.com",
                phone: "01012345678",
                status: "active",
                createdDate: "2025-01-01",
                lastLogin: "2025-12-22"
            },
            { 
                id: 2, 
                username: "supervisor1", 
                password: "123", 
                role: "supervisor", 
                name: "أحمد (مشرف)",
                email: "supervisor@example.com",
                phone: "01198765432",
                status: "active",
                createdDate: "2025-01-15",
                lastLogin: "2025-12-21"
            },
            { 
                id: 3, 
                username: "user1", 
                password: "123", 
                role: "cashier", 
                name: "محمد (بائع)",
                email: "cashier@example.com",
                phone: "01234567890",
                status: "active",
                createdDate: "2025-02-01",
                lastLogin: "2025-12-22"
            }
        ];

        // بيانات المنتجات الافتراضية مع إضافة خدمات التصوير
        const defaultProducts = {
            pens: [
                { id: 1, name: "قلم رصاص HB", price: 2.5, cost: 1.5, category: "pens", stock: 100, unit: "حبة", reorderLevel: 10, barcode: "PEN001" },
                { id: 2, name: "قلم حبر أزرق", price: 5, cost: 3, category: "pens", stock: 50, unit: "حبة", reorderLevel: 10, barcode: "PEN002" },
                { id: 3, name: "قلم حبر أسود", price: 5, cost: 3, category: "pens", stock: 60, unit: "حبة", reorderLevel: 10, barcode: "PEN003" },
                { id: 4, name: "أقلام ألوان (12 لون)", price: 25, cost: 15, category: "pens", stock: 30, unit: "علبة", reorderLevel: 5, barcode: "PEN004" },
                { id: 5, name: "قلم جاف أحمر", price: 3, cost: 1.8, category: "pens", stock: 80, unit: "حبة", reorderLevel: 10, barcode: "PEN005" },
                { id: 6, name: "قلم جاف أزرق", price: 3, cost: 1.8, category: "pens", stock: 75, unit: "حبة", reorderLevel: 10, barcode: "PEN006" },
                { id: 7, name: "قلم رصاص 2B", price: 3, cost: 1.8, category: "pens", stock: 90, unit: "حبة", reorderLevel: 10, barcode: "PEN007" },
                { id: 8, name: "قلم سبورة أبيض", price: 4, cost: 2.5, category: "pens", stock: 40, unit: "حبة", reorderLevel: 10, barcode: "PEN008" }
            ],
            notebooks: [
                { id: 9, name: "دفتر 80 ورقة", price: 10, cost: 6, category: "notebooks", stock: 40, unit: "حبة", reorderLevel: 10, barcode: "NB001" },
                { id: 10, name: "دفتر 100 ورقة", price: 12, cost: 7, category: "notebooks", stock: 35, unit: "حبة", reorderLevel: 10, barcode: "NB002" },
                { id: 11, name: "دفتر رسم", price: 15, cost: 9, category: "notebooks", stock: 20, unit: "حبة", reorderLevel: 5, barcode: "NB003" },
                { id: 12, name: "دفتر حساب", price: 8, cost: 5, category: "notebooks", stock: 45, unit: "حبة", reorderLevel: 10, barcode: "NB004" },
                { id: 13, name: "دفتر كشكول", price: 6, cost: 4, category: "notebooks", stock: 60, unit: "حبة", reorderLevel: 15, barcode: "NB005" },
                { id: 14, name: "دفتر مذكرات", price: 20, cost: 12, category: "notebooks", stock: 25, unit: "حبة", reorderLevel: 5, barcode: "NB006" }
            ],
            office: [
                { id: 15, name: "مشابك ورق", price: 5, cost: 3, category: "office", stock: 100, unit: "علبة", reorderLevel: 20, barcode: "OFF001" },
                { id: 16, name: "دباسة صغيرة", price: 25, cost: 15, category: "office", stock: 15, unit: "حبة", reorderLevel: 5, barcode: "OFF002" },
                { id: 17, name: "مقص مكتب", price: 15, cost: 9, category: "office", stock: 10, unit: "حبة", reorderLevel: 3, barcode: "OFF003" },
                { id: 18, name: "مبراة", price: 8, cost: 5, category: "office", stock: 25, unit: "حبة", reorderLevel: 10, barcode: "OFF004" },
                { id: 19, name: "مسطرة 30 سم", price: 5, cost: 3, category: "office", stock: 50, unit: "حبة", reorderLevel: 10, barcode: "OFF005" }
            ],
            envelopes: [
                { id: 20, name: "أظرف بلاستيك صغيرة", price: 10, cost: 6, category: "envelopes", stock: 80, unit: "كرتون", reorderLevel: 10, barcode: "ENV001" },
                { id: 21, name: "أظرف ورقية متوسطة", price: 15, cost: 9, category: "envelopes", stock: 60, unit: "كرتون", reorderLevel: 10, barcode: "ENV002" },
                { id: 22, name: "أظرف بلاستيك كبيرة", price: 12, cost: 7, category: "envelopes", stock: 40, unit: "كرتون", reorderLevel: 10, barcode: "ENV003" }
            ],
            papers: [
                { id: 23, name: "ورق A4 (500 ورقة)", price: 45, cost: 30, category: "papers", stock: 25, unit: "رزمة", reorderLevel: 5, barcode: "PAP001" },
                { id: 24, name: "ورق A3 (100 ورقة)", price: 60, cost: 40, category: "papers", stock: 15, unit: "رزمة", reorderLevel: 3, barcode: "PAP002" },
                { id: 25, name: "ورق ملون A4", price: 30, cost: 20, category: "papers", stock: 20, unit: "رزمة", reorderLevel: 5, barcode: "PAP003" },
                { id: 26, name: "ورق رسم A4", price: 35, cost: 22, category: "papers", stock: 18, unit: "رزمة", reorderLevel: 5, barcode: "PAP004" }
            ],
            printing: [
                { id: 27, name: "تصوير أبيض/أسود (صفحة)", price: 0.5, cost: 0.1, category: "printing", stock: 9999, unit: "صفحة", perPage: true, isService: true },
                { id: 28, name: "تصوير ملون (صفحة)", price: 2, cost: 0.5, category: "printing", stock: 9999, unit: "صفحة", perPage: true, isService: true },
                { id: 29, name: "تصوير طالب (أبيض/أسود)", price: 0.3, cost: 0.1, category: "printing", stock: 9999, unit: "صفحة", perPage: true, isService: true },
                { id: 30, name: "تصوير طالب (ملون)", price: 1.5, cost: 0.5, category: "printing", stock: 9999, unit: "صفحة", perPage: true, isService: true },
                { id: 31, name: "تغليف ورق شفاف", price: 3, cost: 1, category: "printing", stock: 9999, unit: "حبة", perPage: false, isService: true },
                { id: 32, name: "تغليف حراري", price: 5, cost: 2, category: "printing", stock: 9999, unit: "حبة", perPage: false, isService: true }
            ],
            other: [
                { id: 33, name: "صمغ مكتب", price: 8, cost: 5, category: "other", stock: 40, unit: "حبة", reorderLevel: 10, barcode: "OTH001" },
                { id: 34, name: "شريط لاصق", price: 7, cost: 4, category: "other", stock: 30, unit: "حبة", reorderLevel: 10, barcode: "OTH002" },
                { id: 35, name: "براية", price: 3, cost: 1.5, category: "other", stock: 60, unit: "حبة", reorderLevel: 15, barcode: "OTH003" },
                { id: 36, name: "ممحاة", price: 2, cost: 1, category: "other", stock: 100, unit: "حبة", reorderLevel: 20, barcode: "OTH004" },
                { id: 37, name: "دبابيس مكتب", price: 4, cost: 2, category: "other", stock: 70, unit: "علبة", reorderLevel: 15, barcode: "OTH005" }
            ]
        };

        // بيانات الموردين الافتراضية
        const defaultSuppliers = [
            { 
                id: 1, 
                name: "شركة الأقلام الذهبية", 
                phone: "01012345678", 
                email: "info@goldenpens.com", 
                location: "القاهرة", 
                commercialRegister: "123456789",
                taxNumber: "987654321",
                notes: "مورد رئيسي للأقلام والأدوات المكتبية"
            },
            { 
                id: 2, 
                name: "مصنع الأوراق المصرية", 
                phone: "01198765432", 
                email: "sales@egyptianpapers.com", 
                location: "الجيزة", 
                commercialRegister: "987654321",
                taxNumber: "123456789",
                notes: "توفير جميع أنواع الورق"
            },
            { 
                id: 3, 
                name: "مركز مستلزمات المكتب", 
                phone: "01234567890", 
                email: "info@office-supplies.com", 
                location: "المعادي", 
                commercialRegister: "456789123",
                taxNumber: "321654987",
                notes: "جميع الأدوات المكتبية والأظرف"
            }
        ];

        // بيانات المشتريات الافتراضية
        const defaultPurchases = [
            {
                id: 1,
                invoiceNumber: "INV-SUP-001",
                date: "2025-12-20",
                supplierId: 1,
                supplierName: "شركة الأقلام الذهبية",
                items: [
                    { productId: 1, name: "قلم رصاص HB", quantity: 50, cost: 1.5, salePrice: 2.5, unit: "حبة", total: 75 },
                    { productId: 2, name: "قلم حبر أزرق", quantity: 30, cost: 3, salePrice: 5, unit: "حبة", total: 90 }
                ],
                total: 165,
                paymentMethod: "cash",
                paymentStatus: "paid",
                notes: "طلب عاجل"
            },
            {
                id: 2,
                invoiceNumber: "INV-PAPER-2025-015",
                date: "2025-12-15",
                supplierId: 2,
                supplierName: "مصنع الأوراق المصرية",
                items: [
                    { productId: 23, name: "ورق A4 (500 ورقة)", quantity: 10, cost: 30, salePrice: 45, unit: "رزمة", total: 300 },
                    { productId: 25, name: "ورق ملون A4", quantity: 5, cost: 20, salePrice: 30, unit: "رزمة", total: 100 }
                ],
                total: 400,
                paymentMethod: "credit",
                paymentStatus: "pending",
                notes: "سيتم الدفع نهاية الشهر"
            }
        ];

        // بيانات الفئات
        const defaultCategories = [
            { id: 1, name: "أقلام", description: "جميع أنواع الأقلام", icon: "fa-pen" },
            { id: 2, name: "دفاتر", description: "الدفاتر والكشاكيل", icon: "fa-book" },
            { id: 3, name: "أدوات مكتبية", description: "أدوات المكتب المختلفة", icon: "fa-briefcase" },
            { id: 4, name: "أظرف", description: "الأظرف بأنواعها", icon: "fa-envelope" },
            { id: 5, name: "أوراق", description: "الورق بأنواعه", icon: "fa-file" },
            { id: 6, name: "خدمات التصوير", description: "خدمات التصوير والتغليف", icon: "fa-print" },
            { id: 7, name: "أخرى", description: "منتجات أخرى", icon: "fa-box" }
        ];

        // بيانات التعديلات
        const defaultInventoryAdjustments = [
            {
                id: 1,
                date: "2025-12-22",
                productId: 1,
                productName: "قلم رصاص HB",
                adjustmentType: "add",
                previousQuantity: 50,
                newQuantity: 100,
                difference: 50,
                reason: "شراء جديد",
                notes: "إضافة مخزون جديد",
                userId: 1,
                userName: "ياسر (مدير)"
            },
            {
                id: 2,
                date: "2025-12-21",
                productId: 23,
                productName: "ورق A4 (500 ورقة)",
                adjustmentType: "remove",
                previousQuantity: 30,
                newQuantity: 25,
                difference: -5,
                reason: "تالف",
                notes: "ورق تالف بسبب الرطوبة",
                userId: 2,
                userName: "أحمد (مشرف)"
            }
        ];

        // بيانات المبيعات للتقارير
        const defaultSales = [
            {
                id: 1,
                invoiceNumber: "INV-2025-1001",
                date: "2025-12-22",
                paymentMethod: "cash",
                itemsCount: 3,
                subtotal: 150,
                discount: 10,
                total: 140,
                userId: 3,
                userName: "محمد (بائع)"
            },
            {
                id: 2,
                invoiceNumber: "INV-2025-1002",
                date: "2025-12-21",
                paymentMethod: "card",
                itemsCount: 5,
                subtotal: 250,
                discount: 0,
                total: 250,
                userId: 3,
                userName: "محمد (بائع)"
            }
        ];

        // بيانات الشيفتات
        const defaultShifts = [
            {
                id: 1,
                date: "2025-12-22",
                userId: 3,
                userName: "محمد (بائع)",
                openTime: "09:00:00",
                closeTime: "17:00:00",
                cashTotal: 500,
                cardTotal: 300,
                totalSales: 800,
                itemsSold: 25
            },
            {
                id: 2,
                date: "2025-12-21",
                userId: 3,
                userName: "محمد (بائع)",
                openTime: "09:00:00",
                closeTime: "17:00:00",
                cashTotal: 450,
                cardTotal: 250,
                totalSales: 700,
                itemsSold: 20
            }
        ];

        // بيانات الإعدادات
        const defaultSettings = {
            printServices: {
                bwPrice: 0.5,
                colorPrice: 2.0,
                studentDiscount: 40,
                autoStudentDiscount: "yes",
                laminationPrice: 3.0,
                thermalPrice: 5.0
            },
            pricing: {
                defaultProfitMargin: 50,
                autoUpdatePrices: "yes",
                priceRounding: "0.05"
            },
            printing: {
                storeName: "مكتبة صب واي",
                storeAddress: "شارع المكتبات، وسط البلد",
                storePhone: "0100-123-4567",
                receiptFooter: "شكراً لزيارتكم مكتبة صب واي - نرجو زيارتنا مرة أخرى",
                paperSize: "58mm",
                autoPrint: "no",
                receiptCopies: 1
            },
            system: {
                systemName: "نظام إدارة مكتبة صب واي",
                defaultCurrency: "EGP",
                dateFormat: "dd/mm/yyyy",
                defaultLanguage: "ar",
                autoShiftClose: "never",
                lowStockAlert: "yes",
                defaultReorderLevel: 10
            },
            backup: {
                lastBackup: null,
                autoBackup: "no",
                backupFrequency: "daily",
                backupCount: 0
            }
        };

        // حالة التطبيق
        let currentUser = null;
        let cart = [];
        let discount = { type: 'fixed', value: 0 };
        let paymentMethod = 'cash';
        let currentShift = {
            openTime: new Date(),
            cashTotal: 0,
            cardTotal: 0,
            totalSales: 0,
            itemsSold: []
        };
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter') || '1001');
        let purchaseCounter = parseInt(localStorage.getItem('purchaseCounter') || '3');
        let supplierCounter = parseInt(localStorage.getItem('supplierCounter') || defaultSuppliers.length + 1);
        let userCounter = parseInt(localStorage.getItem('userCounter') || defaultUsers.length + 1);
        let productCounter = parseInt(localStorage.getItem('productCounter') || '38');
        let categoryCounter = parseInt(localStorage.getItem('categoryCounter') || defaultCategories.length + 1);
        let adjustmentCounter = parseInt(localStorage.getItem('adjustmentCounter') || defaultInventoryAdjustments.length + 1);
        let saleCounter = parseInt(localStorage.getItem('saleCounter') || defaultSales.length + 1);
        let shiftCounter = parseInt(localStorage.getItem('shiftCounter') || defaultShifts.length + 1);
        
        let currentPurchaseItems = [];
        let currentEditingPurchaseId = null;
        let currentEditingSupplierId = null;
        let currentEditingUserId = null;
        let currentEditingProductId = null;
        let currentEditingCategoryId = null;
        let currentPrintingProduct = null;
        let selectedProduct = null;
        let currentEditingPriceType = null;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات من localStorage إذا كانت موجودة
            loadDataFromStorage();
            
            // إعداد عناصر واجهة المستخدم
            initUI();
            
            // تحميل المنتجات الأولية
            loadProductsByCategory('pens');
            updateCartDisplay();
            
            // تحميل بيانات المشتريات
            loadPurchases();
            loadSuppliers();
            
            // تحميل بيانات الإدارة
            loadUsers();
            loadCategories();
            loadInventoryAdjustments();
            loadSettings();
        });

        // تحميل البيانات من localStorage
        function loadDataFromStorage() {
            const storedUsers = localStorage.getItem('storeUsers');
            const storedProducts = localStorage.getItem('storeProducts');
            const storedCart = localStorage.getItem('storeCart');
            const storedShift = localStorage.getItem('storeShift');
            const storedSuppliers = localStorage.getItem('storeSuppliers');
            const storedPurchases = localStorage.getItem('storePurchases');
            const storedCategories = localStorage.getItem('storeCategories');
            const storedSettings = localStorage.getItem('storeSettings');
            const storedAdjustments = localStorage.getItem('storeAdjustments');
            const storedSales = localStorage.getItem('storeSales');
            const storedShifts = localStorage.getItem('storeShifts');
            
            if (!storedUsers) {
                localStorage.setItem('storeUsers', JSON.stringify(defaultUsers));
            }
            
            if (!storedProducts) {
                localStorage.setItem('storeProducts', JSON.stringify(defaultProducts));
            }
            
            if (!storedSuppliers) {
                localStorage.setItem('storeSuppliers', JSON.stringify(defaultSuppliers));
            }
            
            if (!storedPurchases) {
                localStorage.setItem('storePurchases', JSON.stringify(defaultPurchases));
            }
            
            if (!storedCategories) {
                localStorage.setItem('storeCategories', JSON.stringify(defaultCategories));
            }
            
            if (!storedSettings) {
                localStorage.setItem('storeSettings', JSON.stringify(defaultSettings));
            }
            
            if (!storedAdjustments) {
                localStorage.setItem('storeAdjustments', JSON.stringify(defaultInventoryAdjustments));
            }
            
            if (!storedSales) {
                localStorage.setItem('storeSales', JSON.stringify(defaultSales));
            }
            
            if (!storedShifts) {
                localStorage.setItem('storeShifts', JSON.stringify(defaultShifts));
            }
            
            if (storedCart) {
                cart = JSON.parse(storedCart);
            }
            
            if (storedShift) {
                currentShift = JSON.parse(storedShift);
                currentShift.openTime = new Date(currentShift.openTime);
            }
        }

        // تهيئة واجهة المستخدم
        function initUI() {
            // عناصر شاشة الدخول
            const loginBtn = document.getElementById('loginBtn');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            // عناصر التنقل
            const menuItems = document.querySelectorAll('.menu-item');
            const logoutBtn = document.getElementById('logoutBtn');
            
            // عناصر شاشة البيع
            const categoryBtns = document.querySelectorAll('.category-btn');
            const discountBtns = document.querySelectorAll('.discount-btn');
            const discountInput = document.getElementById('discountInput');
            const applyDiscountBtn = document.getElementById('applyDiscountBtn');
            const paymentBtns = document.querySelectorAll('.payment-btn');
            const completeSaleBtn = document.getElementById('completeSaleBtn');
            const clearCartBtn = document.getElementById('clearCartBtn');
            const closeShiftBtn = document.getElementById('closeShiftBtn');
            
            // عناصر شاشة المشتريات
            const tabs = document.querySelectorAll('.tab');
            const addPurchaseBtn = document.getElementById('addPurchaseBtn');
            const addSupplierBtn = document.getElementById('addSupplierBtn');
            const filterBtn = document.getElementById('filterBtn');
            const resetFilterBtn = document.getElementById('resetFilterBtn');
            const searchSupplierBtn = document.getElementById('searchSupplierBtn');
            
            // عناصر البحث الديناميكي
            const productSearchInput = document.getElementById('productSearchInput');
            const productSearchResults = document.getElementById('productSearchResults');
            
            // عناصر مودال المشتريات
            const purchaseModal = document.getElementById('purchaseModal');
            const addProductToPurchaseBtn = document.getElementById('addProductToPurchaseBtn');
            const savePurchaseBtn = document.getElementById('savePurchaseBtn');
            const updatePurchaseBtn = document.getElementById('updatePurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            
            // عناصر مودال الموردين
            const supplierModal = document.getElementById('supplierModal');
            const saveSupplierBtn = document.getElementById('saveSupplierBtn');
            const updateSupplierBtn = document.getElementById('updateSupplierBtn');
            const cancelSupplierBtn = document.getElementById('cancelSupplierBtn');
            
            // عناصر مودال التصوير
            const printingPagesModal = document.getElementById('printingPagesModal');
            const printingPagesCount = document.getElementById('printingPagesCount');
            const printingTypeSelect = document.getElementById('printingTypeSelect');
            const confirmPrintingBtn = document.getElementById('confirmPrintingBtn');
            const cancelPrintingBtn = document.getElementById('cancelPrintingBtn');
            
            // عناصر المودال الأخرى
            const closeShiftModal = document.getElementById('closeShiftModal');
            const completeSaleModal = document.getElementById('completeSaleModal');
            const purchaseReceiptModal = document.getElementById('purchaseReceiptModal');
            const userModal = document.getElementById('userModal');
            const productModal = document.getElementById('productModal');
            const categoryModal = document.getElementById('categoryModal');
            const priceModal = document.getElementById('priceModal');
            const inventoryModal = document.getElementById('inventoryModal');
            const backupModal = document.getElementById('backupModal');
            
            const closeModalBtns = document.querySelectorAll('.close-modal');
            const cancelCloseShiftBtn = document.getElementById('cancelCloseShiftBtn');
            const printShiftReportBtn = document.getElementById('printShiftReportBtn');
            const saveShiftReportBtn = document.getElementById('saveShiftReportBtn');
            const saveReceiptBtn = document.getElementById('saveReceiptBtn');
            const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');
            const cancelSaleBtn = document.getElementById('cancelSaleBtn');
            const printPurchaseReceiptBtn = document.getElementById('printPurchaseReceiptBtn');
            const closePurchaseReceiptBtn = document.getElementById('closePurchaseReceiptBtn');
            
            // عناصر شاشة التقارير
            const adminTabs = document.querySelectorAll('.admin-tab[data-report]');
            const reportTabs = document.querySelectorAll('.admin-tab[data-report]');
            const generateSalesReportBtn = document.getElementById('generateSalesReportBtn');
            const exportSalesBtn = document.getElementById('exportSalesBtn');
            const generatePurchasesReportBtn = document.getElementById('generatePurchasesReportBtn');
            const generateInventoryReportBtn = document.getElementById('generateInventoryReportBtn');
            const generateShiftsReportBtn = document.getElementById('generateShiftsReportBtn');
            
            // عناصر شاشة المخزون
            const inventoryTabs = document.querySelectorAll('.admin-tab[data-inventory]');
            const addProductBtn = document.getElementById('addProductBtn');
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            const addAdjustmentBtn = document.getElementById('addAdjustmentBtn');
            const searchProductsBtn = document.getElementById('searchProductsBtn');
            const resetProductsFilterBtn = document.getElementById('resetProductsFilterBtn');
            const filterAdjustmentsBtn = document.getElementById('filterAdjustmentsBtn');
            
            // عناصر شاشة الإعدادات
            const settingsTabs = document.querySelectorAll('.admin-tab[data-settings]');
            const addUserBtn = document.getElementById('addUserBtn');
            const savePrintSettingsBtn = document.getElementById('savePrintSettingsBtn');
            const savePricingSettingsBtn = document.getElementById('savePricingSettingsBtn');
            const savePrintingSettingsBtn = document.getElementById('savePrintingSettingsBtn');
            const saveSystemSettingsBtn = document.getElementById('saveSystemSettingsBtn');
            const testPrintBtn = document.getElementById('testPrintBtn');
            const createBackupBtn = document.getElementById('createBackupBtn');
            const restoreBackupBtn = document.getElementById('restoreBackupBtn');
            const autoBackupSettingsBtn = document.getElementById('autoBackupSettingsBtn');
            const resetSystemBtn = document.getElementById('resetSystemBtn');
            
            // أزرار خدمة التصوير السريعة
            const quickPrintBtns = document.querySelectorAll('.quick-print-btn');
            
            // أحداث شاشة الدخول
            loginBtn.addEventListener('click', handleLogin);
            
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    passwordInput.focus();
                }
            });
            
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // أحداث التنقل بين الشاشات
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const screenId = this.getAttribute('data-screen');
                    switchScreen(screenId);
                    
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // تسجيل الخروج
            logoutBtn.addEventListener('click', handleLogout);
            
            // أحداث شاشة البيع (موجودة بالفعل)
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    loadProductsByCategory(category);
                    
                    // تحديث عنوان الفئة
                    const categoryTitles = {
                        pens: 'أقلام',
                        notebooks: 'دفاتر',
                        office: 'أدوات مكتبية',
                        envelopes: 'أظرف',
                        papers: 'أوراق',
                        printing: 'خدمات التصوير',
                        other: 'منتجات أخرى'
                    };
                    document.getElementById('currentCategoryTitle').textContent = categoryTitles[category] || category;
                });
            });
            
            // أحداث الخصم
            discountBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    discountBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    discount.type = this.getAttribute('data-type');
                    applyDiscount();
                });
            });
            
            discountInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyDiscount();
                }
            });
            
            applyDiscountBtn.addEventListener('click', applyDiscount);
            
            // أحداث طريقة الدفع
            paymentBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    paymentBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    paymentMethod = this.getAttribute('data-method');
                });
            });
            
            // أحداث الأزرار الرئيسية
            completeSaleBtn.addEventListener('click', showReceiptModal);
            clearCartBtn.addEventListener('click', clearCart);
            closeShiftBtn.addEventListener('click', showCloseShiftModal);
            
            // أحداث شاشة المشتريات
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    document.getElementById(`${tabId}-content`).style.display = 'block';
                });
            });
            
            addPurchaseBtn.addEventListener('click', () => showPurchaseModal());
            addSupplierBtn.addEventListener('click', () => showSupplierModal());
            filterBtn.addEventListener('click', filterPurchases);
            resetFilterBtn.addEventListener('click', resetPurchasesFilter);
            searchSupplierBtn.addEventListener('click', searchSuppliers);
            
            // أحداث البحث الديناميكي
            productSearchInput.addEventListener('input', searchProducts);
            productSearchInput.addEventListener('focus', function() {
                if (this.value.trim()) {
                    searchProducts();
                }
            });
            
            // إغلاق نتائج البحث عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!productSearchResults.contains(e.target) && e.target !== productSearchInput) {
                    productSearchResults.style.display = 'none';
                }
            });
            
            // أحداث مودال المشتريات
            addProductToPurchaseBtn.addEventListener('click', addProductToPurchase);
            savePurchaseBtn.addEventListener('click', savePurchase);
            updatePurchaseBtn.addEventListener('click', updatePurchase);
            cancelPurchaseBtn.addEventListener('click', () => purchaseModal.style.display = 'none');
            
            // عند اختيار المنتج، تعبئة الحقول تلقائياً
            productSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const firstResult = productSearchResults.querySelector('.search-result-item');
                    if (firstResult) {
                        selectProductFromSearch(parseInt(firstResult.dataset.productId));
                    }
                }
            });
            
            // أحداث مودال الموردين
            saveSupplierBtn.addEventListener('click', saveSupplier);
            updateSupplierBtn.addEventListener('click', updateSupplier);
            cancelSupplierBtn.addEventListener('click', () => supplierModal.style.display = 'none');
            
            // أحداث مودال التصوير
            printingPagesCount.addEventListener('input', updatePrintingPrice);
            printingTypeSelect.addEventListener('change', updatePrintingPrice);
            confirmPrintingBtn.addEventListener('click', confirmPrinting);
            cancelPrintingBtn.addEventListener('click', () => printingPagesModal.style.display = 'none');
            
            // أحداث المودال
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) modal.style.display = 'none';
                });
            });
            
            cancelCloseShiftBtn.addEventListener('click', () => closeShiftModal.style.display = 'none');
            printShiftReportBtn.addEventListener('click', printShiftReport);
            saveShiftReportBtn.addEventListener('click', saveShiftReport);
            saveReceiptBtn.addEventListener('click', saveReceipt);
            saveAndPrintBtn.addEventListener('click', saveAndPrintReceipt);
            cancelSaleBtn.addEventListener('click', () => completeSaleModal.style.display = 'none');
            printPurchaseReceiptBtn.addEventListener('click', printPurchaseReceipt);
            closePurchaseReceiptBtn.addEventListener('click', () => purchaseReceiptModal.style.display = 'none');
            
            // عند النقر خارج المودال
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // تحديث سعر التصوير عند فتح المودال
            updatePrintingPrice();
            
            // أحداث شاشة التقارير
            reportTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const reportType = this.getAttribute('data-report');
                    
                    reportTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات التقارير
                    document.querySelectorAll('.tab-content').forEach(content => {
                        if (content.id.includes('ReportContent')) {
                            content.style.display = 'none';
                        }
                    });
                    
                    // إظهار المحتوى المحدد
                    document.getElementById(`${reportType}ReportContent`).style.display = 'block';
                });
            });
            
            generateSalesReportBtn.addEventListener('click', generateSalesReport);
            exportSalesBtn.addEventListener('click', exportSalesReport);
            generatePurchasesReportBtn.addEventListener('click', generatePurchasesReport);
            generateInventoryReportBtn.addEventListener('click', generateInventoryReport);
            generateShiftsReportBtn.addEventListener('click', generateShiftsReport);
            
            // أحداث شاشة المخزون
            inventoryTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const inventoryType = this.getAttribute('data-inventory');
                    
                    inventoryTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات المخزون
                    document.querySelectorAll('.tab-content').forEach(content => {
                        if (content.id.includes('InventoryContent')) {
                            content.style.display = 'none';
                        }
                    });
                    
                    // إظهار المحتوى المحدد
                    document.getElementById(`${inventoryType}InventoryContent`).style.display = 'block';
                    
                    // تحميل البيانات الخاصة بكل تبويب
                    if (inventoryType === 'products') {
                        loadInventoryProducts();
                    } else if (inventoryType === 'low-stock') {
                        loadLowStockProducts();
                    }
                });
            });
            
            addProductBtn.addEventListener('click', () => showProductModal());
            addCategoryBtn.addEventListener('click', () => showCategoryModal());
            addAdjustmentBtn.addEventListener('click', showInventoryAdjustmentModal);
            searchProductsBtn.addEventListener('click', filterInventoryProducts);
            resetProductsFilterBtn.addEventListener('click', resetInventoryProductsFilter);
            filterAdjustmentsBtn.addEventListener('click', filterAdjustments);
            
            // أحداث شاشة الإعدادات
            settingsTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const settingsType = this.getAttribute('data-settings');
                    
                    settingsTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات الإعدادات
                    document.querySelectorAll('.tab-content').forEach(content => {
                        if (content.id.includes('SettingsContent')) {
                            content.style.display = 'none';
                        }
                    });
                    
                    // إظهار المحتوى المحدد
                    document.getElementById(`${settingsType}SettingsContent`).style.display = 'block';
                });
            });
            
            addUserBtn.addEventListener('click', () => showUserModal());
            savePrintSettingsBtn.addEventListener('click', savePrintSettings);
            savePricingSettingsBtn.addEventListener('click', savePricingSettings);
            savePrintingSettingsBtn.addEventListener('click', savePrintingSettings);
            saveSystemSettingsBtn.addEventListener('click', saveSystemSettings);
            testPrintBtn.addEventListener('click', testPrint);
            createBackupBtn.addEventListener('click', () => showBackupModal('create'));
            restoreBackupBtn.addEventListener('click', () => showBackupModal('restore'));
            autoBackupSettingsBtn.addEventListener('click', () => showBackupModal('auto'));
            resetSystemBtn.addEventListener('click', resetSystem);
            
            // أحداث أزرار خدمة التصوير السريعة
            quickPrintBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const service = this.getAttribute('data-service');
                    addQuickPrintService(service);
                });
            });
            
            // أحداث تغيير نوع النسخ الاحتياطي
            document.getElementById('backupType').addEventListener('change', function() {
                const customOptions = document.getElementById('customBackupOptions');
                if (this.value === 'custom') {
                    customOptions.style.display = 'block';
                } else {
                    customOptions.style.display = 'none';
                }
            });
            
            // أحداث المودالات الجديدة
            document.getElementById('saveUserBtn').addEventListener('click', saveUser);
            document.getElementById('updateUserBtn').addEventListener('click', updateUser);
            document.getElementById('cancelUserBtn').addEventListener('click', () => userModal.style.display = 'none');
            
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
            document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
            document.getElementById('cancelProductBtn').addEventListener('click', () => productModal.style.display = 'none');
            
            document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
            document.getElementById('updateCategoryBtn').addEventListener('click', updateCategory);
            document.getElementById('cancelCategoryBtn').addEventListener('click', () => categoryModal.style.display = 'none');
            
            document.getElementById('savePriceBtn').addEventListener('click', savePrice);
            document.getElementById('cancelPriceBtn').addEventListener('click', () => priceModal.style.display = 'none');
            
            document.getElementById('saveInventoryBtn').addEventListener('click', saveInventoryAdjustment);
            document.getElementById('cancelInventoryBtn').addEventListener('click', () => inventoryModal.style.display = 'none');
            
            document.getElementById('startBackupBtn').addEventListener('click', startBackup);
            document.getElementById('startRestoreBtn').addEventListener('click', startRestore);
        }

        // تحميل المستخدمين
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const tableBody = document.getElementById('usersTable');
            
            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد مستخدمين مسجلين</td></tr>';
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const roleBadgeClass = user.role === 'admin' ? 'role-admin' : 
                                     user.role === 'supervisor' ? 'role-supervisor' : 'role-cashier';
                const roleText = user.role === 'admin' ? 'مدير' : 
                               user.role === 'supervisor' ? 'مشرف' : 'بائع';
                const statusBadge = user.status === 'active' ? 
                    '<span class="btn btn-success btn-sm" style="padding: 3px 8px;">نشط</span>' :
                    '<span class="btn btn-danger btn-sm" style="padding: 3px 8px;">غير نشط</span>';
                
                html += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td><span class="role-badge ${roleBadgeClass}">${roleText}</span></td>
                        <td>${statusBadge}</td>
                        <td>${user.createdDate}</td>
                        <td>${user.lastLogin || 'لم يسجل دخول'}</td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewUser(${user.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // تحميل الفئات
        function loadCategories() {
            const categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
            const grid = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                grid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد فئات مسجلة</p></div>';
                return;
            }
            
            let html = '';
            categories.forEach(category => {
                html += `
                    <div class="category-item">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                <i class="fas ${category.icon}"></i> ${category.name}
                            </div>
                            <div style="font-size: 12px; color: #777;">${category.description || 'بدون وصف'}</div>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-warning btn-sm" onclick="editCategory(${category.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCategory(${category.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // تحميل تعديلات المخزون
        function loadInventoryAdjustments() {
            const adjustments = JSON.parse(localStorage.getItem('storeAdjustments')) || defaultInventoryAdjustments;
            const tableBody = document.getElementById('adjustmentsTable');
            
            if (adjustments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد تعديلات مسجلة</td></tr>';
                return;
            }
            
            let html = '';
            adjustments.forEach(adj => {
                const adjustmentTypeText = adj.adjustmentType === 'add' ? 'إضافة' :
                                          adj.adjustmentType === 'remove' ? 'خصم' :
                                          adj.adjustmentType === 'set' ? 'تعيين' : 'تصحيح';
                const adjustmentTypeClass = adj.adjustmentType === 'add' ? 'text-success' :
                                          adj.adjustmentType === 'remove' ? 'text-danger' : 'text-warning';
                
                html += `
                    <tr>
                        <td>${adj.date}</td>
                        <td>${adj.productName}</td>
                        <td class="${adjustmentTypeClass}">${adjustmentTypeText}</td>
                        <td>${adj.previousQuantity}</td>
                        <td>${adj.newQuantity}</td>
                        <td class="${adj.difference > 0 ? 'text-success' : 'text-danger'}">
                            ${adj.difference > 0 ? '+' : ''}${adj.difference}
                        </td>
                        <td>${adj.reason}${adj.notes ? ' - ' + adj.notes : ''}</td>
                        <td>${adj.userName}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // تحميل إعدادات النظام
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            
            // تحديث واجهة إعدادات خدمات التصوير
            document.getElementById('bwPrice').textContent = settings.printServices.bwPrice.toFixed(2) + ' جنيه';
            document.getElementById('colorPrice').textContent = settings.printServices.colorPrice.toFixed(2) + ' جنيه';
            document.getElementById('laminationPrice').textContent = settings.printServices.laminationPrice.toFixed(2) + ' جنيه';
            document.getElementById('thermalPrice').textContent = settings.printServices.thermalPrice.toFixed(2) + ' جنيه';
            document.getElementById('studentDiscountPercent').value = settings.printServices.studentDiscount;
            document.getElementById('autoStudentDiscount').value = settings.printServices.autoStudentDiscount;
            
            // تحديث واجهة إعدادات الأسعار
            document.getElementById('defaultProfitMargin').value = settings.pricing.defaultProfitMargin;
            document.getElementById('autoUpdatePrices').value = settings.pricing.autoUpdatePrices;
            document.getElementById('priceRounding').value = settings.pricing.priceRounding;
            
            // تحديث واجهة إعدادات الطباعة
            document.getElementById('storeNamePrint').value = settings.printing.storeName;
            document.getElementById('storeAddress').value = settings.printing.storeAddress;
            document.getElementById('storePhone').value = settings.printing.storePhone;
            document.getElementById('receiptFooter').value = settings.printing.receiptFooter;
            document.getElementById('paperSize').value = settings.printing.paperSize;
            document.getElementById('autoPrint').value = settings.printing.autoPrint;
            document.getElementById('receiptCopies').value = settings.printing.receiptCopies;
            
            // تحديث واجهة إعدادات النظام
            document.getElementById('systemName').value = settings.system.systemName;
            document.getElementById('defaultCurrency').value = settings.system.defaultCurrency;
            document.getElementById('dateFormat').value = settings.system.dateFormat;
            document.getElementById('defaultLanguage').value = settings.system.defaultLanguage;
            document.getElementById('autoShiftClose').value = settings.system.autoShiftClose;
            document.getElementById('lowStockAlert').value = settings.system.lowStockAlert;
            document.getElementById('defaultReorderLevel').value = settings.system.defaultReorderLevel;
            
            // تحديث واجهة النسخ الاحتياطي
            document.getElementById('lastBackupDate').textContent = settings.backup.lastBackup || 'لم يتم إنشاء نسخة بعد';
            document.getElementById('autoBackupStatus').textContent = settings.backup.autoBackup === 'yes' ? 'مفعل' : 'غير مفعل';
            
            // تحديث قائمة الملفات الاحتياطية
            updateBackupFilesList();
        }

        // تحديث قائمة ملفات النسخ الاحتياطية
        function updateBackupFilesList() {
            const backupFiles = JSON.parse(localStorage.getItem('backupFiles') || '[]');
            const tableBody = document.getElementById('backupFilesTable');
            
            if (backupFiles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد نسخ احتياطية</td></tr>';
                document.getElementById('backupCount').textContent = '0';
                document.getElementById('backupSize').textContent = '0 كيلوبايت';
                return;
            }
            
            let html = '';
            let totalSize = 0;
            
            backupFiles.forEach((file, index) => {
                totalSize += file.size;
                const sizeKB = (file.size / 1024).toFixed(2);
                
                html += `
                    <tr>
                        <td>${file.name}</td>
                        <td>${file.date}</td>
                        <td>${sizeKB} كيلوبايت</td>
                        <td>${file.type === 'full' ? 'نسخة كاملة' : file.type === 'sales' ? 'مبيعات فقط' : file.type === 'inventory' ? 'مخزون فقط' : 'مخصص'}</td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="downloadBackup(${index})">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBackup(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('backupCount').textContent = backupFiles.length;
            document.getElementById('backupSize').textContent = (totalSize / 1024).toFixed(2) + ' كيلوبايت';
        }

        // تحميل منتجات المخزون
        function loadInventoryProducts() {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            const tableBody = document.getElementById('inventoryProductsTable');
            
            let allProducts = [];
            for (const category in productsData) {
                allProducts = allProducts.concat(productsData[category]);
            }
            
            if (allProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد منتجات مسجلة</td></tr>';
                return;
            }
            
            let html = '';
            allProducts.forEach(product => {
                const categoryNames = {
                    pens: 'أقلام',
                    notebooks: 'دفاتر',
                    office: 'أدوات مكتبية',
                    envelopes: 'أظرف',
                    papers: 'أوراق',
                    printing: 'خدمات التصوير',
                    other: 'أخرى'
                };
                
                const stockClass = product.stock <= (product.reorderLevel || 10) ? 'text-danger' : 
                                 product.stock <= (product.reorderLevel || 10) * 2 ? 'text-warning' : 'text-success';
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${categoryNames[product.category] || product.category}</td>
                        <td class="${stockClass}">${product.stock} ${product.unit}</td>
                        <td>${product.cost.toFixed(2)}</td>
                        <td>${product.price.toFixed(2)}</td>
                        <td>${product.unit}</td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewProduct(${product.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="adjustInventory(${product.id})">
                                <i class="fas fa-edit"></i> تعديل المخزون
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // تحميل المنتجات منخفضة المخزون
        function loadLowStockProducts() {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            const reorderLevel = settings.system.defaultReorderLevel || 10;
            
            const tableBody = document.getElementById('lowStockTable');
            
            let allProducts = [];
            for (const category in productsData) {
                allProducts = allProducts.concat(productsData[category]);
            }
            
            // تصفية المنتجات المنخفضة المخزون (تستثني الخدمات)
            const lowStockProducts = allProducts.filter(product => 
                !product.isService && product.stock <= (product.reorderLevel || reorderLevel)
            );
            
            if (lowStockProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد منتجات منخفضة المخزون</td></tr>';
                return;
            }
            
            let html = '';
            lowStockProducts.forEach(product => {
                const categoryNames = {
                    pens: 'أقلام',
                    notebooks: 'دفاتر',
                    office: 'أدوات مكتبية',
                    envelopes: 'أظرف',
                    papers: 'أوراق',
                    printing: 'خدمات التصوير',
                    other: 'أخرى'
                };
                
                const difference = (product.reorderLevel || reorderLevel) - product.stock;
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${categoryNames[product.category] || product.category}</td>
                        <td class="text-danger">${product.stock}</td>
                        <td>${product.reorderLevel || reorderLevel}</td>
                        <td class="text-danger">${difference} (ناقص)</td>
                        <td>${product.cost.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="adjustInventory(${product.id})">
                                <i class="fas fa-plus"></i> إضافة مخزون
                            </button>
                            <button class="btn btn-info btn-sm" onclick="createPurchaseOrder(${product.id})">
                                <i class="fas fa-shopping-cart"></i> طلب شراء
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // عرض مودال إضافة/تعديل مستخدم
        function showUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            
            if (userId) {
                // وضع التعديل
                currentEditingUserId = userId;
                title.textContent = 'تعديل بيانات المستخدم';
                
                const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
                const user = users.find(u => u.id === userId);
                
                if (user) {
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userPassword').value = ''; // لا نعرض كلمة المرور الحالية
                    document.getElementById('userFullName').value = user.name;
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userStatus').value = user.status || 'active';
                }
                
                document.getElementById('saveUserBtn').style.display = 'none';
                document.getElementById('updateUserBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingUserId = null;
                title.textContent = 'إضافة مستخدم جديد';
                
                document.getElementById('userUsername').value = '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userFullName').value = '';
                document.getElementById('userRole').value = 'cashier';
                document.getElementById('userEmail').value = '';
                document.getElementById('userPhone').value = '';
                document.getElementById('userStatus').value = 'active';
                
                document.getElementById('saveUserBtn').style.display = 'block';
                document.getElementById('updateUserBtn').style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // حفظ المستخدم
        function saveUser() {
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const fullName = document.getElementById('userFullName').value.trim();
            const role = document.getElementById('userRole').value;
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const status = document.getElementById('userStatus').value;
            
            if (!username || !password || !fullName || !role) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // التحقق من عدم تكرار اسم المستخدم
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const existingUser = users.find(u => u.username === username);
            if (existingUser) {
                alert('اسم المستخدم موجود بالفعل، يرجى اختيار اسم آخر');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const newUser = {
                id: userCounter,
                username,
                password,
                role,
                name: fullName,
                email: email || null,
                phone: phone || null,
                status,
                createdDate: today,
                lastLogin: null
            };
            
            users.push(newUser);
            localStorage.setItem('storeUsers', JSON.stringify(users));
            userCounter++;
            localStorage.setItem('userCounter', userCounter.toString());
            
            alert('تم حفظ المستخدم بنجاح');
            document.getElementById('userModal').style.display = 'none';
            loadUsers();
        }

        // تحديث المستخدم
        function updateUser() {
            if (!currentEditingUserId) {
                alert('لا يوجد مستخدم للتحديث');
                return;
            }
            
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const fullName = document.getElementById('userFullName').value.trim();
            const role = document.getElementById('userRole').value;
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const status = document.getElementById('userStatus').value;
            
            if (!username || !fullName || !role) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const userIndex = users.findIndex(u => u.id === currentEditingUserId);
            
            if (userIndex === -1) {
                alert('المستخدم غير موجود');
                return;
            }
            
            // التحقق من عدم تكرار اسم المستخدم (مع استثناء المستخدم الحالي)
            const existingUser = users.find(u => u.username === username && u.id !== currentEditingUserId);
            if (existingUser) {
                alert('اسم المستخدم موجود بالفعل، يرجى اختيار اسم آخر');
                return;
            }
            
            const updatedUser = {
                ...users[userIndex],
                username,
                name: fullName,
                role,
                email: email || null,
                phone: phone || null,
                status
            };
            
            // تحديث كلمة المرور فقط إذا تم إدخال قيمة جديدة
            if (password) {
                updatedUser.password = password;
            }
            
            users[userIndex] = updatedUser;
            localStorage.setItem('storeUsers', JSON.stringify(users));
            
            alert('تم تحديث المستخدم بنجاح');
            document.getElementById('userModal').style.display = 'none';
            loadUsers();
        }

        // عرض مودال إضافة/تعديل منتج
        function showProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            
            if (productId) {
                // وضع التعديل
                currentEditingProductId = productId;
                title.textContent = 'تعديل بيانات المنتج';
                
                const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
                let product = null;
                
                for (const category in productsData) {
                    const foundProduct = productsData[category].find(p => p.id === productId);
                    if (foundProduct) {
                        product = foundProduct;
                        break;
                    }
                }
                
                if (product) {
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productCostPrice').value = product.cost;
                    document.getElementById('productSellingPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productUnit').value = product.unit;
                    document.getElementById('productReorderLevel').value = product.reorderLevel || 10;
                    document.getElementById('productBarcode').value = product.barcode || '';
                    document.getElementById('productNotes').value = product.notes || '';
                    document.getElementById('productIsService').checked = product.isService || false;
                    document.getElementById('productHasDiscount').checked = product.hasDiscount || true;
                }
                
                document.getElementById('saveProductBtn').style.display = 'none';
                document.getElementById('updateProductBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingProductId = null;
                title.textContent = 'إضافة منتج جديد';
                
                document.getElementById('productName').value = '';
                document.getElementById('productCategory').value = 'pens';
                document.getElementById('productCostPrice').value = '';
                document.getElementById('productSellingPrice').value = '';
                document.getElementById('productStock').value = '0';
                document.getElementById('productUnit').value = 'حبة';
                document.getElementById('productReorderLevel').value = '10';
                document.getElementById('productBarcode').value = '';
                document.getElementById('productNotes').value = '';
                document.getElementById('productIsService').checked = false;
                document.getElementById('productHasDiscount').checked = true;
                
                document.getElementById('saveProductBtn').style.display = 'block';
                document.getElementById('updateProductBtn').style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // حفظ المنتج
        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const costPrice = parseFloat(document.getElementById('productCostPrice').value);
            const sellingPrice = parseFloat(document.getElementById('productSellingPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const unit = document.getElementById('productUnit').value;
            const reorderLevel = parseInt(document.getElementById('productReorderLevel').value) || 10;
            const barcode = document.getElementById('productBarcode').value.trim();
            const notes = document.getElementById('productNotes').value.trim();
            const isService = document.getElementById('productIsService').checked;
            const hasDiscount = document.getElementById('productHasDiscount').checked;
            
            if (!name || isNaN(costPrice) || isNaN(sellingPrice) || isNaN(stock) || !unit) {
                alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            // إنشاء المنتج الجديد
            const newProduct = {
                id: productCounter,
                name,
                price: sellingPrice,
                cost: costPrice,
                category,
                stock: isService ? 9999 : stock,
                unit,
                reorderLevel: isService ? 0 : reorderLevel,
                barcode: barcode || null,
                notes: notes || null,
                isService: isService || false,
                hasDiscount: hasDiscount || true,
                perPage: category === 'printing' && unit === 'صفحة'
            };
            
            // إضافة المنتج إلى الفئة المناسبة
            if (!productsData[category]) {
                productsData[category] = [];
            }
            productsData[category].push(newProduct);
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
            productCounter++;
            localStorage.setItem('productCounter', productCounter.toString());
            
            alert('تم حفظ المنتج بنجاح');
            document.getElementById('productModal').style.display = 'none';
            loadInventoryProducts();
        }

        // تحديث المنتج
        function updateProduct() {
            if (!currentEditingProductId) {
                alert('لا يوجد منتج للتحديث');
                return;
            }
            
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const costPrice = parseFloat(document.getElementById('productCostPrice').value);
            const sellingPrice = parseFloat(document.getElementById('productSellingPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const unit = document.getElementById('productUnit').value;
            const reorderLevel = parseInt(document.getElementById('productReorderLevel').value) || 10;
            const barcode = document.getElementById('productBarcode').value.trim();
            const notes = document.getElementById('productNotes').value.trim();
            const isService = document.getElementById('productIsService').checked;
            const hasDiscount = document.getElementById('productHasDiscount').checked;
            
            if (!name || isNaN(costPrice) || isNaN(sellingPrice) || isNaN(stock) || !unit) {
                alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            // البحث عن المنتج القديم وحذفه من الفئة القديمة
            let oldCategory = null;
            let productIndex = -1;
            
            for (const cat in productsData) {
                productIndex = productsData[cat].findIndex(p => p.id === currentEditingProductId);
                if (productIndex !== -1) {
                    oldCategory = cat;
                    break;
                }
            }
            
            if (productIndex === -1) {
                alert('المنتج غير موجود');
                return;
            }
            
            // حفظ بعض البيانات القديمة
            const oldProduct = productsData[oldCategory][productIndex];
            const transactionCount = oldProduct.transactionCount || 0;
            
            // حذف المنتج من الفئة القديمة
            productsData[oldCategory].splice(productIndex, 1);
            
            // إذا أصبحت الفئة القديمة فارغة، يمكن حذفها (اختياري)
            if (productsData[oldCategory].length === 0 && oldCategory !== 'other') {
                delete productsData[oldCategory];
            }
            
            // إنشاء المنتج المحدث
            const updatedProduct = {
                id: currentEditingProductId,
                name,
                price: sellingPrice,
                cost: costPrice,
                category,
                stock: isService ? 9999 : stock,
                unit,
                reorderLevel: isService ? 0 : reorderLevel,
                barcode: barcode || null,
                notes: notes || null,
                isService: isService || false,
                hasDiscount: hasDiscount || true,
                perPage: category === 'printing' && unit === 'صفحة',
                transactionCount: transactionCount
            };
            
            // إضافة المنتج إلى الفئة الجديدة
            if (!productsData[category]) {
                productsData[category] = [];
            }
            productsData[category].push(updatedProduct);
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
            
            alert('تم تحديث المنتج بنجاح');
            document.getElementById('productModal').style.display = 'none';
            loadInventoryProducts();
        }

        // عرض مودال إضافة/تعديل فئة
        function showCategoryModal(categoryId = null) {
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            
            if (categoryId) {
                // وضع التعديل
                currentEditingCategoryId = categoryId;
                title.textContent = 'تعديل بيانات الفئة';
                
                const categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
                const category = categories.find(c => c.id === categoryId);
                
                if (category) {
                    document.getElementById('categoryName').value = category.name;
                    document.getElementById('categoryDescription').value = category.description || '';
                    document.getElementById('categoryIcon').value = category.icon;
                }
                
                document.getElementById('saveCategoryBtn').style.display = 'none';
                document.getElementById('updateCategoryBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingCategoryId = null;
                title.textContent = 'إضافة فئة جديدة';
                
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryDescription').value = '';
                document.getElementById('categoryIcon').value = 'fa-box';
                
                document.getElementById('saveCategoryBtn').style.display = 'block';
                document.getElementById('updateCategoryBtn').style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // حفظ الفئة
        function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const icon = document.getElementById('categoryIcon').value;
            
            if (!name) {
                alert('يرجى إدخال اسم الفئة');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
            const newCategory = {
                id: categoryCounter,
                name,
                description: description || null,
                icon
            };
            
            categories.push(newCategory);
            localStorage.setItem('storeCategories', JSON.stringify(categories));
            categoryCounter++;
            localStorage.setItem('categoryCounter', categoryCounter.toString());
            
            alert('تم حفظ الفئة بنجاح');
            document.getElementById('categoryModal').style.display = 'none';
            loadCategories();
        }

        // تحديث الفئة
        function updateCategory() {
            if (!currentEditingCategoryId) {
                alert('لا يوجد فئة للتحديث');
                return;
            }
            
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const icon = document.getElementById('categoryIcon').value;
            
            if (!name) {
                alert('يرجى إدخال اسم الفئة');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
            const categoryIndex = categories.findIndex(c => c.id === currentEditingCategoryId);
            
            if (categoryIndex === -1) {
                alert('الفئة غير موجودة');
                return;
            }
            
            categories[categoryIndex] = {
                ...categories[categoryIndex],
                name,
                description: description || null,
                icon
            };
            
            localStorage.setItem('storeCategories', JSON.stringify(categories));
            
            alert('تم تحديث الفئة بنجاح');
            document.getElementById('categoryModal').style.display = 'none';
            loadCategories();
        }

        // تعديل السعر
        function editPrice(priceType) {
            currentEditingPriceType = priceType;
            const modal = document.getElementById('priceModal');
            const title = document.getElementById('priceModalTitle');
            const itemName = document.getElementById('priceItemName');
            const priceValue = document.getElementById('priceValue');
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            let currentPrice = 0;
            let itemTitle = '';
            
            switch(priceType) {
                case 'bw':
                    itemTitle = 'تصوير أبيض/أسود (صفحة)';
                    currentPrice = settings.printServices.bwPrice;
                    break;
                case 'color':
                    itemTitle = 'تصوير ملون (صفحة)';
                    currentPrice = settings.printServices.colorPrice;
                    break;
                case 'lamination':
                    itemTitle = 'تغليف ورق شفاف';
                    currentPrice = settings.printServices.laminationPrice;
                    break;
                case 'thermal':
                    itemTitle = 'تغليف حراري';
                    currentPrice = settings.printServices.thermalPrice;
                    break;
            }
            
            title.textContent = `تعديل سعر ${itemTitle}`;
            itemName.textContent = itemTitle;
            priceValue.value = currentPrice;
            priceValue.focus();
            priceValue.select();
            
            modal.style.display = 'flex';
        }

        // حفظ السعر
        function savePrice() {
            const newPrice = parseFloat(document.getElementById('priceValue').value);
            const notes = document.getElementById('priceNotes').value.trim();
            
            if (isNaN(newPrice) || newPrice < 0) {
                alert('يرجى إدخال سعر صحيح');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            
            switch(currentEditingPriceType) {
                case 'bw':
                    settings.printServices.bwPrice = newPrice;
                    break;
                case 'color':
                    settings.printServices.colorPrice = newPrice;
                    break;
                case 'lamination':
                    settings.printServices.laminationPrice = newPrice;
                    break;
                case 'thermal':
                    settings.printServices.thermalPrice = newPrice;
                    break;
            }
            
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            
            // تحديث العرض
            loadSettings();
            
            alert('تم تحديث السعر بنجاح');
            document.getElementById('priceModal').style.display = 'none';
        }

        // عرض مودال تعديل المخزون
        function adjustInventory(productId) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (!product) {
                alert('المنتج غير موجود');
                return;
            }
            
            currentEditingProductId = productId;
            
            const modal = document.getElementById('inventoryModal');
            const title = document.getElementById('inventoryModalTitle');
            const productName = document.getElementById('inventoryProductName');
            const currentStock = document.getElementById('inventoryCurrentStock');
            
            title.textContent = `تعديل مخزون ${product.name}`;
            productName.textContent = product.name;
            currentStock.textContent = `المخزون الحالي: ${product.stock} ${product.unit}`;
            
            // إعادة تعيين الحقول
            document.getElementById('inventoryAdjustmentType').value = 'add';
            document.getElementById('inventoryQuantity').value = '';
            document.getElementById('inventoryReason').value = 'purchase';
            document.getElementById('inventoryNotes').value = '';
            
            modal.style.display = 'flex';
            document.getElementById('inventoryQuantity').focus();
        }

        // حفظ تعديل المخزون
        function saveInventoryAdjustment() {
            const adjustmentType = document.getElementById('inventoryAdjustmentType').value;
            const quantity = parseInt(document.getElementById('inventoryQuantity').value);
            const reason = document.getElementById('inventoryReason').value;
            const notes = document.getElementById('inventoryNotes').value.trim();
            
            if (!currentEditingProductId || isNaN(quantity) || quantity <= 0) {
                alert('يرجى إدخال كمية صحيحة');
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            let productCategory = null;
            
            // البحث عن المنتج
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === currentEditingProductId);
                if (foundProduct) {
                    product = foundProduct;
                    productCategory = category;
                    break;
                }
            }
            
            if (!product) {
                alert('المنتج غير موجود');
                return;
            }
            
            // حساب الكمية الجديدة
            const previousQuantity = product.stock;
            let newQuantity = previousQuantity;
            
            switch(adjustmentType) {
                case 'add':
                    newQuantity = previousQuantity + quantity;
                    break;
                case 'remove':
                    newQuantity = Math.max(0, previousQuantity - quantity);
                    break;
                case 'set':
                    newQuantity = quantity;
                    break;
                case 'correction':
                    newQuantity = quantity;
                    break;
            }
            
            const difference = newQuantity - previousQuantity;
            
            // تحديث مخزون المنتج
            product.stock = newQuantity;
            
            // حفظ البيانات المحدثة
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
            
            // تسجيل التعديل في السجلات
            const adjustments = JSON.parse(localStorage.getItem('storeAdjustments')) || defaultInventoryAdjustments;
            const today = new Date().toISOString().split('T')[0];
            
            const newAdjustment = {
                id: adjustmentCounter,
                date: today,
                productId: currentEditingProductId,
                productName: product.name,
                adjustmentType,
                previousQuantity,
                newQuantity,
                difference,
                reason,
                notes: notes || null,
                userId: currentUser ? currentUser.id : 1,
                userName: currentUser ? currentUser.name : 'نظام'
            };
            
            adjustments.push(newAdjustment);
            localStorage.setItem('storeAdjustments', JSON.stringify(adjustments));
            adjustmentCounter++;
            localStorage.setItem('adjustmentCounter', adjustmentCounter.toString());
            
            alert(`تم تعديل مخزون المنتج بنجاح. المخزون الجديد: ${newQuantity}`);
            document.getElementById('inventoryModal').style.display = 'none';
            
            // تحديث العرض
            loadInventoryAdjustments();
            loadInventoryProducts();
            loadLowStockProducts();
            
            // إذا كنا في شاشة البيع، نحدث عرض المنتجات
            if (document.getElementById('posScreen').classList.contains('active')) {
                loadProductsByCategory(productCategory);
            }
        }

        // حفظ إعدادات خدمات التصوير
        function savePrintSettings() {
            const studentDiscount = parseInt(document.getElementById('studentDiscountPercent').value);
            const autoStudentDiscount = document.getElementById('autoStudentDiscount').value;
            
            if (isNaN(studentDiscount) || studentDiscount < 0 || studentDiscount > 100) {
                alert('يرجى إدخال نسبة خصم صحيحة بين 0 و 100');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            
            settings.printServices.studentDiscount = studentDiscount;
            settings.printServices.autoStudentDiscount = autoStudentDiscount;
            
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            
            alert('تم حفظ إعدادات خدمات التصوير بنجاح');
        }

        // حفظ إعدادات الأسعار
        function savePricingSettings() {
            const defaultProfitMargin = parseInt(document.getElementById('defaultProfitMargin').value);
            const autoUpdatePrices = document.getElementById('autoUpdatePrices').value;
            const priceRounding = document.getElementById('priceRounding').value;
            
            if (isNaN(defaultProfitMargin) || defaultProfitMargin < 0) {
                alert('يرجى إدخال هامش ربح صحيح');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            
            settings.pricing.defaultProfitMargin = defaultProfitMargin;
            settings.pricing.autoUpdatePrices = autoUpdatePrices;
            settings.pricing.priceRounding = priceRounding;
            
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            
            alert('تم حفظ إعدادات الأسعار بنجاح');
        }

        // حفظ إعدادات الطباعة
        function savePrintingSettings() {
            const storeName = document.getElementById('storeNamePrint').value.trim();
            const storeAddress = document.getElementById('storeAddress').value.trim();
            const storePhone = document.getElementById('storePhone').value.trim();
            const receiptFooter = document.getElementById('receiptFooter').value.trim();
            const paperSize = document.getElementById('paperSize').value;
            const autoPrint = document.getElementById('autoPrint').value;
            const receiptCopies = parseInt(document.getElementById('receiptCopies').value);
            
            if (!storeName) {
                alert('يرجى إدخال اسم المتجر');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            
            settings.printing.storeName = storeName;
            settings.printing.storeAddress = storeAddress;
            settings.printing.storePhone = storePhone;
            settings.printing.receiptFooter = receiptFooter;
            settings.printing.paperSize = paperSize;
            settings.printing.autoPrint = autoPrint;
            settings.printing.receiptCopies = isNaN(receiptCopies) ? 1 : Math.max(1, Math.min(3, receiptCopies));
            
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            
            alert('تم حفظ إعدادات الطباعة بنجاح');
        }

        // حفظ إعدادات النظام
        function saveSystemSettings() {
            const systemName = document.getElementById('systemName').value.trim();
            const defaultCurrency = document.getElementById('defaultCurrency').value;
            const dateFormat = document.getElementById('dateFormat').value;
            const defaultLanguage = document.getElementById('defaultLanguage').value;
            const autoShiftClose = document.getElementById('autoShiftClose').value;
            const lowStockAlert = document.getElementById('lowStockAlert').value;
            const defaultReorderLevel = parseInt(document.getElementById('defaultReorderLevel').value);
            
            if (!systemName || isNaN(defaultReorderLevel) || defaultReorderLevel < 1) {
                alert('يرجى إدخال بيانات صحيحة');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            
            settings.system.systemName = systemName;
            settings.system.defaultCurrency = defaultCurrency;
            settings.system.dateFormat = dateFormat;
            settings.system.defaultLanguage = defaultLanguage;
            settings.system.autoShiftClose = autoShiftClose;
            settings.system.lowStockAlert = lowStockAlert;
            settings.system.defaultReorderLevel = defaultReorderLevel;
            
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            
            alert('تم حفظ إعدادات النظام بنجاح');
        }

        // اختبار الطباعة
        function testPrint() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>اختبار الطباعة - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 20px; }
                        .receipt { width: 80mm; margin: 0 auto; }
                        .text-center { text-align: center; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="text-center">
                            <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار المكتبة" class="receipt-logo">
                            <h3>مكتبة صب واي</h3>
                            <p>فاتورة تجريبية</p>
                            <p>تاريخ: ${new Date().toLocaleDateString('ar-EG')}</p>
                            <p>وقت: ${new Date().toLocaleTimeString('ar-EG')}</p>
                        </div>
                        <hr>
                        <div style="margin: 20px 0;">
                            <p>هذه فاتورة تجريبية لاختبار إعدادات الطباعة.</p>
                            <p>إذا كانت الفاتورة تظهر بشكل صحيح، فإن إعدادات الطباعة صحيحة.</p>
                        </div>
                        <hr>
                        <div style="text-align: center; margin-top: 20px;">
                            <p>نظام إدارة مكتبة صب واي</p>
                            <p>جميع الحقوق محفوظة © 2025</p>
                        </div>
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // عرض مودال النسخ الاحتياطي
        function showBackupModal(mode) {
            const modal = document.getElementById('backupModal');
            const title = document.getElementById('backupModalTitle');
            
            if (mode === 'create') {
                title.textContent = 'إنشاء نسخة احتياطية';
                document.getElementById('backupFormContent').style.display = 'block';
            } else if (mode === 'restore') {
                title.textContent = 'استعادة من نسخة احتياطية';
                document.getElementById('backupFormContent').style.display = 'block';
            } else if (mode === 'auto') {
                title.textContent = 'إعدادات النسخ التلقائي';
                // هنا يمكن إضافة واجهة لإعدادات النسخ التلقائي
                alert('ميزة النسخ التلقائي قيد التطوير');
                return;
            }
            
            modal.style.display = 'flex';
        }

        // بدء إنشاء نسخة احتياطية
        function startBackup() {
            const backupName = document.getElementById('backupName').value.trim() || 'نسخة احتياطية';
            const backupType = document.getElementById('backupType').value;
            const backupPassword = document.getElementById('backupPassword').value.trim();
            
            // جمع البيانات المراد نسخها
            let backupData = {};
            
            if (backupType === 'full' || backupType === 'custom') {
                // جمع جميع البيانات
                backupData.users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
                backupData.products = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
                backupData.suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
                backupData.purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
                backupData.categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
                backupData.settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
                backupData.adjustments = JSON.parse(localStorage.getItem('storeAdjustments')) || defaultInventoryAdjustments;
                backupData.sales = JSON.parse(localStorage.getItem('storeSales')) || defaultSales;
                backupData.shifts = JSON.parse(localStorage.getItem('storeShifts')) || defaultShifts;
                
                // إذا كان نوع مخصص، نتحقق من الخيارات المحددة
                if (backupType === 'custom') {
                    if (!document.getElementById('backupProducts').checked) delete backupData.products;
                    if (!document.getElementById('backupSales').checked) {
                        delete backupData.sales;
                        delete backupData.shifts;
                    }
                    if (!document.getElementById('backupPurchases').checked) {
                        delete backupData.purchases;
                        delete backupData.suppliers;
                    }
                    if (!document.getElementById('backupUsers').checked) {
                        delete backupData.users;
                        delete backupData.settings;
                    }
                }
            } else if (backupType === 'sales') {
                backupData.sales = JSON.parse(localStorage.getItem('storeSales')) || defaultSales;
                backupData.shifts = JSON.parse(localStorage.getItem('storeShifts')) || defaultShifts;
            } else if (backupType === 'inventory') {
                backupData.products = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
                backupData.categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
                backupData.adjustments = JSON.parse(localStorage.getItem('storeAdjustments')) || defaultInventoryAdjustments;
            }
            
            // إضافة معلومات النسخة
            backupData.backupInfo = {
                name: backupName,
                date: new Date().toISOString(),
                type: backupType,
                hasPassword: backupPassword.length > 0,
                version: '1.0'
            };
            
            // تحويل البيانات إلى JSON
            let backupJSON = JSON.stringify(backupData, null, 2);
            
            // إذا كان هناك كلمة مرور، نقوم بتشفير البيانات (تبسيطي)
            if (backupPassword) {
                backupJSON = btoa(backupJSON + '|' + backupPassword); // تشفير بسيط
            }
            
            // إنشاء ملف للتحميل
            const blob = new Blob([backupJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${backupName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.backup`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // حفظ معلومات النسخة محلياً
            const backupFiles = JSON.parse(localStorage.getItem('backupFiles') || '[]');
            backupFiles.push({
                name: backupName,
                date: new Date().toISOString().split('T')[0],
                size: backupJSON.length,
                type: backupType,
                filename: a.download
            });
            
            localStorage.setItem('backupFiles', JSON.stringify(backupFiles));
            
            // تحديث إعدادات النظام
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            settings.backup.lastBackup = new Date().toISOString().split('T')[0];
            localStorage.setItem('storeSettings', JSON.stringify(settings));
            
            alert('تم إنشاء النسخة الاحتياطية بنجاح وتم تحميل الملف');
            document.getElementById('backupModal').style.display = 'none';
            
            // تحديث العرض
            loadSettings();
        }

        // بدء عملية الاستعادة
        function startRestore() {
            const fileInput = document.getElementById('restoreFile');
            const restorePassword = document.getElementById('restorePassword').value.trim();
            const restoreOptions = document.getElementById('restoreOptions').value;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('يرجى اختيار ملف النسخة الاحتياطية');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let backupData = e.target.result;
                    
                    // محاولة فك التشفير إذا كانت البيانات مشفرة
                    try {
                        const decodedData = atob(backupData);
                        const parts = decodedData.split('|');
                        
                        if (parts.length === 2) {
                            // البيانات مشفرة
                            if (!restorePassword) {
                                alert('هذا الملف محمي بكلمة مرور، يرجى إدخال كلمة المرور');
                                return;
                            }
                            
                            if (parts[1] !== restorePassword) {
                                alert('كلمة المرور غير صحيحة');
                                return;
                            }
                            
                            backupData = parts[0];
                        }
                    } catch (err) {
                        // البيانات غير مشفرة، تستمر بشكل طبيعي
                    }
                    
                    const parsedData = JSON.parse(backupData);
                    
                    if (!parsedData.backupInfo) {
                        alert('ملف النسخة الاحتياطية غير صالح');
                        return;
                    }
                    
                    if (!confirm(`هل أنت متأكد من استعادة النسخة الاحتياطية "${parsedData.backupInfo.name}"؟`)) {
                        return;
                    }
                    
                    // استعادة البيانات حسب النوع
                    if (restoreOptions === 'replace') {
                        // استبدال كامل للبيانات
                        if (parsedData.users) localStorage.setItem('storeUsers', JSON.stringify(parsedData.users));
                        if (parsedData.products) localStorage.setItem('storeProducts', JSON.stringify(parsedData.products));
                        if (parsedData.suppliers) localStorage.setItem('storeSuppliers', JSON.stringify(parsedData.suppliers));
                        if (parsedData.purchases) localStorage.setItem('storePurchases', JSON.stringify(parsedData.purchases));
                        if (parsedData.categories) localStorage.setItem('storeCategories', JSON.stringify(parsedData.categories));
                        if (parsedData.settings) localStorage.setItem('storeSettings', JSON.stringify(parsedData.settings));
                        if (parsedData.adjustments) localStorage.setItem('storeAdjustments', JSON.stringify(parsedData.adjustments));
                        if (parsedData.sales) localStorage.setItem('storeSales', JSON.stringify(parsedData.sales));
                        if (parsedData.shifts) localStorage.setItem('storeShifts', JSON.stringify(parsedData.shifts));
                    } else {
                        // دمج البيانات
                        alert('ميزة دمج البيانات قيد التطوير. يرجى استخدام خيار استبدال البيانات.');
                        return;
                    }
                    
                    alert('تم استعادة النسخة الاحتياطية بنجاح. سيتم إعادة تحميل الصفحة.');
                    document.getElementById('backupModal').style.display = 'none';
                    
                    // إعادة تحميل الصفحة لتطبيق التغييرات
                    setTimeout(() => location.reload(), 1000);
                    
                } catch (error) {
                    alert('خطأ في قراءة ملف النسخة الاحتياطية: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // إعادة تعيين النظام
        function resetSystem() {
            if (!confirm('تحذير: هذه العملية ستعيد تعيين جميع البيانات إلى الإعدادات الافتراضية. هل أنت متأكد؟')) {
                return;
            }
            
            if (!confirm('هل أنت متأكد تماماً؟ سيتم فقدان جميع البيانات الحالية.')) {
                return;
            }
            
            // إعادة تعيين جميع البيانات
            localStorage.removeItem('storeUsers');
            localStorage.removeItem('storeProducts');
            localStorage.removeItem('storeCart');
            localStorage.removeItem('storeShift');
            localStorage.removeItem('storeSuppliers');
            localStorage.removeItem('storePurchases');
            localStorage.removeItem('storeCategories');
            localStorage.removeItem('storeSettings');
            localStorage.removeItem('storeAdjustments');
            localStorage.removeItem('storeSales');
            localStorage.removeItem('storeShifts');
            localStorage.removeItem('invoiceCounter');
            localStorage.removeItem('purchaseCounter');
            localStorage.removeItem('supplierCounter');
            localStorage.removeItem('userCounter');
            localStorage.removeItem('productCounter');
            localStorage.removeItem('categoryCounter');
            localStorage.removeItem('adjustmentCounter');
            localStorage.removeItem('saleCounter');
            localStorage.removeItem('shiftCounter');
            localStorage.removeItem('backupFiles');
            
            alert('تم إعادة تعيين النظام بنجاح. سيتم إعادة تحميل الصفحة.');
            
            // إعادة تحميل الصفحة
            setTimeout(() => location.reload(), 1000);
        }

        // إضافة خدمة تصوير سريعة
        function addQuickPrintService(service) {
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            let productId = 0;
            let productName = '';
            let price = 0;
            let quantity = 1;
            
            switch(service) {
                case 'bw':
                    productId = 27;
                    productName = 'تصوير أبيض/أسود (صفحة)';
                    price = settings.printServices.bwPrice;
                    break;
                case 'color':
                    productId = 28;
                    productName = 'تصوير ملون (صفحة)';
                    price = settings.printServices.colorPrice;
                    break;
                case 'student-bw':
                    productId = 29;
                    productName = 'تصوير طالب (أبيض/أسود)';
                    price = settings.printServices.bwPrice * (1 - settings.printServices.studentDiscount / 100);
                    break;
                case 'student-color':
                    productId = 30;
                    productName = 'تصوير طالب (ملون)';
                    price = settings.printServices.colorPrice * (1 - settings.printServices.studentDiscount / 100);
                    break;
                case 'lamination':
                    productId = 31;
                    productName = 'تغليف ورق شفاف';
                    price = settings.printServices.laminationPrice;
                    break;
                case 'thermal':
                    productId = 32;
                    productName = 'تغليف حراري';
                    price = settings.printServices.thermalPrice;
                    break;
            }
            
            // إذا كانت خدمة التصوير تحتاج اختيار عدد الصفحات
            if (service === 'bw' || service === 'color' || service === 'student-bw' || service === 'student-color') {
                currentPrintingProduct = {
                    id: productId,
                    name: productName,
                    price: price,
                    perPage: true
                };
                
                document.getElementById('printingPagesCount').value = 1;
                document.getElementById('printingTypeSelect').value = productId;
                updatePrintingPrice();
                document.getElementById('printingPagesModal').style.display = 'flex';
            } else {
                // المنتجات العادية
                const existingItem = cart.find(item => item.id === productId);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({
                        id: productId,
                        name: productName,
                        price: price,
                        quantity: quantity,
                        salePrice: price,
                        perPage: false
                    });
                }
                
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
                
                alert(`تمت إضافة ${productName} إلى السلة`);
            }
        }

        // توليد تقرير المبيعات
        function generateSalesReport() {
            const fromDate = document.getElementById('salesFromDate').value;
            const toDate = document.getElementById('salesToDate').value;
            const paymentMethodFilter = document.getElementById('salesPaymentMethod').value;
            
            const sales = JSON.parse(localStorage.getItem('storeSales')) || defaultSales;
            let filteredSales = [...sales];
            
            if (fromDate) {
                filteredSales = filteredSales.filter(s => s.date >= fromDate);
            }
            
            if (toDate) {
                filteredSales = filteredSales.filter(s => s.date <= toDate);
            }
            
            if (paymentMethodFilter) {
                filteredSales = filteredSales.filter(s => s.paymentMethod === paymentMethodFilter);
            }
            
            // تحديث الجدول
            const tableBody = document.getElementById('salesReportTable');
            
            if (filteredSales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد مبيعات في الفترة المحددة</td></tr>';
                document.getElementById('salesStats').innerHTML = '<p style="font-size: 14px;">لا توجد بيانات للإحصائيات</p>';
                return;
            }
            
            let html = '';
            let totalSales = 0;
            let totalDiscount = 0;
            let totalNet = 0;
            let totalItems = 0;
            
            filteredSales.forEach(sale => {
                html += `
                    <tr>
                        <td>${sale.invoiceNumber}</td>
                        <td>${sale.date}</td>
                        <td>${sale.paymentMethod === 'cash' ? 'نقدي' : 'فيزا'}</td>
                        <td>${sale.itemsCount}</td>
                        <td>${sale.subtotal.toFixed(2)}</td>
                        <td>${sale.discount.toFixed(2)}</td>
                        <td>${sale.total.toFixed(2)}</td>
                    </tr>
                `;
                
                totalSales += sale.subtotal;
                totalDiscount += sale.discount;
                totalNet += sale.total;
                totalItems += sale.itemsCount;
            });
            
            tableBody.innerHTML = html;
            
            // تحديث الإحصائيات
            const statsHTML = `
                <div class="admin-grid">
                    <div class="price-card">
                        <div class="price-card-title">إجمالي المبيعات</div>
                        <div class="price-value">${totalSales.toFixed(2)} جنيه</div>
                    </div>
                    <div class="price-card">
                        <div class="price-card-title">إجمالي الخصومات</div>
                        <div class="price-value">${totalDiscount.toFixed(2)} جنيه</div>
                    </div>
                    <div class="price-card">
                        <div class="price-card-title">صافي المبيعات</div>
                        <div class="price-value">${totalNet.toFixed(2)} جنيه</div>
                    </div>
                    <div class="price-card">
                        <div class="price-card-title">عدد الأصناف المباعة</div>
                        <div class="price-value">${totalItems}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-card-title">عدد الفواتير</div>
                        <div class="price-value">${filteredSales.length}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-card-title">متوسط قيمة الفاتورة</div>
                        <div class="price-value">${(totalNet / filteredSales.length).toFixed(2)} جنيه</div>
                    </div>
                </div>
            `;
            
            document.getElementById('salesStats').innerHTML = statsHTML;
        }

        // تصدير تقرير المبيعات إلى Excel
        function exportSalesReport() {
            alert('ميزة التصدير إلى Excel قيد التطوير');
        }

        // توليد تقرير المشتريات
        function generatePurchasesReport() {
            const fromDate = document.getElementById('purchasesReportFromDate').value;
            const toDate = document.getElementById('purchasesReportToDate').value;
            const supplierFilter = document.getElementById('purchasesReportSupplier').value;
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            let filteredPurchases = [...purchases];
            
            if (fromDate) {
                filteredPurchases = filteredPurchases.filter(p => p.date >= fromDate);
            }
            
            if (toDate) {
                filteredPurchases = filteredPurchases.filter(p => p.date <= toDate);
            }
            
            if (supplierFilter) {
                filteredPurchases = filteredPurchases.filter(p => p.supplierId == supplierFilter);
            }
            
            // تحديث الجدول
            const tableBody = document.getElementById('purchasesReportTable');
            
            if (filteredPurchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد مشتريات في الفترة المحددة</td></tr>';
                return;
            }
            
            let html = '';
            filteredPurchases.forEach(purchase => {
                html += `
                    <tr>
                        <td>${purchase.invoiceNumber || 'بدون رقم'}</td>
                        <td>${purchase.date}</td>
                        <td>${purchase.supplierName}</td>
                        <td>${purchase.items.length}</td>
                        <td>${purchase.total.toFixed(2)}</td>
                        <td>${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // توليد تقرير المخزون
        function generateInventoryReport() {
            const categoryFilter = document.getElementById('inventoryCategoryFilter').value;
            const statusFilter = document.getElementById('inventoryStatusFilter').value;
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            const tableBody = document.getElementById('inventoryReportTable');
            
            let allProducts = [];
            for (const category in productsData) {
                if (!categoryFilter || category === categoryFilter) {
                    allProducts = allProducts.concat(productsData[category]);
                }
            }
            
            // تطبيق فلتر حالة المخزون
            if (statusFilter) {
                if (statusFilter === 'low') {
                    allProducts = allProducts.filter(p => !p.isService && p.stock <= 10);
                } else if (statusFilter === 'out') {
                    allProducts = allProducts.filter(p => !p.isService && p.stock <= 0);
                } else if (statusFilter === 'normal') {
                    allProducts = allProducts.filter(p => !p.isService && p.stock > 10);
                }
            }
            
            if (allProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد منتجات تطابق معايير البحث</td></tr>';
                return;
            }
            
            let html = '';
            allProducts.forEach(product => {
                const categoryNames = {
                    pens: 'أقلام',
                    notebooks: 'دفاتر',
                    office: 'أدوات مكتبية',
                    envelopes: 'أظرف',
                    papers: 'أوراق',
                    printing: 'خدمات التصوير',
                    other: 'أخرى'
                };
                
                const inventoryValue = product.cost * product.stock;
                const lastTransaction = '2025-12-22'; // هذا يحتاج إلى بيانات حقيقية
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${categoryNames[product.category] || product.category}</td>
                        <td>${product.stock} ${product.unit}</td>
                        <td>${product.cost.toFixed(2)}</td>
                        <td>${product.price.toFixed(2)}</td>
                        <td>${inventoryValue.toFixed(2)}</td>
                        <td>${lastTransaction}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // توليد تقرير الشيفتات
        function generateShiftsReport() {
            const fromDate = document.getElementById('shiftsFromDate').value;
            const toDate = document.getElementById('shiftsToDate').value;
            const userFilter = document.getElementById('shiftsUserFilter').value;
            
            const shifts = JSON.parse(localStorage.getItem('storeShifts')) || defaultShifts;
            let filteredShifts = [...shifts];
            
            if (fromDate) {
                filteredShifts = filteredShifts.filter(s => s.date >= fromDate);
            }
            
            if (toDate) {
                filteredShifts = filteredShifts.filter(s => s.date <= toDate);
            }
            
            if (userFilter) {
                filteredShifts = filteredShifts.filter(s => s.userId == userFilter);
            }
            
            // تحديث الجدول
            const tableBody = document.getElementById('shiftsReportTable');
            
            if (filteredShifts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد شيفتات في الفترة المحددة</td></tr>';
                return;
            }
            
            let html = '';
            filteredShifts.forEach(shift => {
                html += `
                    <tr>
                        <td>SHIFT-${shift.id.toString().padStart(4, '0')}</td>
                        <td>${shift.date}</td>
                        <td>${shift.userName}</td>
                        <td>${shift.openTime}</td>
                        <td>${shift.closeTime}</td>
                        <td>${shift.cashTotal.toFixed(2)}</td>
                        <td>${shift.cardTotal.toFixed(2)}</td>
                        <td>${shift.totalSales.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // تصفية منتجات المخزون
        function filterInventoryProducts() {
            const searchTerm = document.getElementById('productSearchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('productCategoryFilter').value;
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            const tableBody = document.getElementById('inventoryProductsTable');
            
            let allProducts = [];
            for (const category in productsData) {
                if (!categoryFilter || category === categoryFilter) {
                    allProducts = allProducts.concat(productsData[category]);
                }
            }
            
            // تطبيق فلتر البحث
            if (searchTerm) {
                allProducts = allProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.barcode && p.barcode.toLowerCase().includes(searchTerm))
                );
            }
            
            if (allProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد منتجات تطابق معايير البحث</td></tr>';
                return;
            }
            
            let html = '';
            allProducts.forEach(product => {
                const categoryNames = {
                    pens: 'أقلام',
                    notebooks: 'دفاتر',
                    office: 'أدوات مكتبية',
                    envelopes: 'أظرف',
                    papers: 'أوراق',
                    printing: 'خدمات التصوير',
                    other: 'أخرى'
                };
                
                const stockClass = product.stock <= (product.reorderLevel || 10) ? 'text-danger' : 
                                 product.stock <= (product.reorderLevel || 10) * 2 ? 'text-warning' : 'text-success';
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${categoryNames[product.category] || product.category}</td>
                        <td class="${stockClass}">${product.stock} ${product.unit}</td>
                        <td>${product.cost.toFixed(2)}</td>
                        <td>${product.price.toFixed(2)}</td>
                        <td>${product.unit}</td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewProduct(${product.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="adjustInventory(${product.id})">
                                <i class="fas fa-edit"></i> تعديل المخزون
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // إعادة تعيين فلتر منتجات المخزون
        function resetInventoryProductsFilter() {
            document.getElementById('productSearchFilter').value = '';
            document.getElementById('productCategoryFilter').value = '';
            loadInventoryProducts();
        }

        // تصفية تعديلات المخزون
        function filterAdjustments() {
            const fromDate = document.getElementById('adjustmentFromDate').value;
            const toDate = document.getElementById('adjustmentToDate').value;
            const typeFilter = document.getElementById('adjustmentTypeFilter').value;
            
            const adjustments = JSON.parse(localStorage.getItem('storeAdjustments')) || defaultInventoryAdjustments;
            const tableBody = document.getElementById('adjustmentsTable');
            
            let filteredAdjustments = [...adjustments];
            
            if (fromDate) {
                filteredAdjustments = filteredAdjustments.filter(a => a.date >= fromDate);
            }
            
            if (toDate) {
                filteredAdjustments = filteredAdjustments.filter(a => a.date <= toDate);
            }
            
            if (typeFilter) {
                filteredAdjustments = filteredAdjustments.filter(a => a.adjustmentType === typeFilter);
            }
            
            if (filteredAdjustments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد تعديلات تطابق معايير البحث</td></tr>';
                return;
            }
            
            let html = '';
            filteredAdjustments.forEach(adj => {
                const adjustmentTypeText = adj.adjustmentType === 'add' ? 'إضافة' :
                                          adj.adjustmentType === 'remove' ? 'خصم' :
                                          adj.adjustmentType === 'set' ? 'تعيين' : 'تصحيح';
                const adjustmentTypeClass = adj.adjustmentType === 'add' ? 'text-success' :
                                          adj.adjustmentType === 'remove' ? 'text-danger' : 'text-warning';
                
                html += `
                    <tr>
                        <td>${adj.date}</td>
                        <td>${adj.productName}</td>
                        <td class="${adjustmentTypeClass}">${adjustmentTypeText}</td>
                        <td>${adj.previousQuantity}</td>
                        <td>${adj.newQuantity}</td>
                        <td class="${adj.difference > 0 ? 'text-success' : 'text-danger'}">
                            ${adj.difference > 0 ? '+' : ''}${adj.difference}
                        </td>
                        <td>${adj.reason}${adj.notes ? ' - ' + adj.notes : ''}</td>
                        <td>${adj.userName}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // الدوال المساعدة الموجودة سابقاً (يجب أن تبقى كما هي)
        // ... [جميع الدوال الأخرى من الكود الأصلي] ...

        // البحث عن المنتجات
        function searchProducts() {
            const searchTerm = document.getElementById('productSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('productSearchResults');
            
            if (!searchTerm) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let allProducts = [];
            
            // جمع جميع المنتجات من جميع الفئات
            for (const category in productsData) {
                allProducts = allProducts.concat(productsData[category]);
            }
            
            // البحث في المنتجات
            const filteredProducts = allProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">لا توجد نتائج</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let resultsHTML = '';
            filteredProducts.forEach(product => {
                resultsHTML += `
                    <div class="search-result-item" data-product-id="${product.id}">
                        ${product.name} (${product.unit}) - ${product.price.toFixed(2)} جنيه
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';
            
            // إضافة أحداث النقر على النتائج
            const resultItems = resultsContainer.querySelectorAll('.search-result-item');
            resultItems.forEach(item => {
                item.addEventListener('click', function() {
                    const productId = parseInt(this.dataset.productId);
                    selectProductFromSearch(productId);
                });
            });
        }

        // اختيار منتج من نتائج البحث
        function selectProductFromSearch(productId) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (product) {
                selectedProduct = product;
                document.getElementById('productSearchInput').value = product.name;
                document.getElementById('productQuantity').value = 1;
                document.getElementById('productCost').value = product.cost.toFixed(2);
                document.getElementById('productSalePrice').value = product.price.toFixed(2);
                document.getElementById('productUnit').value = product.unit;
                
                // عرض معلومات المنتج
                document.getElementById('productInfo').style.display = 'flex';
                document.getElementById('currentStock').textContent = `المخزون: ${product.stock}`;
                document.getElementById('lastCost').textContent = `آخر سعر شراء: ${product.cost.toFixed(2)}`;
                
                // إخفاء نتائج البحث
                document.getElementById('productSearchResults').style.display = 'none';
                
                // تركيز على حقل الكمية
                document.getElementById('productQuantity').focus();
                document.getElementById('productQuantity').select();
            }
        }

        // تحديث سعر التصوير
        function updatePrintingPrice() {
            const pages = parseInt(document.getElementById('printingPagesCount').value) || 1;
            const productId = parseInt(document.getElementById('printingTypeSelect').value);
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (product) {
                const totalPrice = product.price * pages;
                document.getElementById('printingTotalPrice').value = totalPrice.toFixed(2) + ' جنيه';
            }
        }

        // معالجة الدخول
        function handleLogin() {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('يرجى إدخال اسم المستخدم وكلمة المرور');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const user = users.find(u => 
                u.username.toLowerCase() === username && u.password === password
            );
            
            if (user) {
                currentUser = user;
                showMainScreen();
                updateUIForUserRole();
            } else {
                alert('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // عرض الشاشة الرئيسية
        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.name;
        }

        // تحديث الواجهة حسب دور المستخدم
        function updateUIForUserRole() {
            const menuItems = document.querySelectorAll('.menu-item');
            
            if (currentUser.role === 'cashier') {
                // البائع يرى فقط شاشة البيع
                menuItems.forEach(item => {
                    const screen = item.getAttribute('data-screen');
                    if (screen !== 'pos') {
                        item.style.display = 'none';
                    }
                });
                
                // إذا كان في شاشة غير البيع، انتقل إلى شاشة البيع
                const currentScreen = document.querySelector('.screen.active');
                if (currentScreen && currentScreen.id !== 'posScreen') {
                    switchScreen('pos');
                    menuItems.forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-screen') === 'pos') {
                            item.classList.add('active');
                        }
                    });
                }
            } else if (currentUser.role === 'admin') {
                // المدير يرى جميع الشاشات
                menuItems.forEach(item => {
                    item.style.display = 'flex';
                });
            } else if (currentUser.role === 'supervisor') {
                // المشرف يرى كل شيء عدا الإعدادات
                menuItems.forEach(item => {
                    const screen = item.getAttribute('data-screen');
                    if (screen === 'settings') {
                        item.style.display = 'none';
                    } else {
                        item.style.display = 'flex';
                    }
                });
            }
        }

        // تبديل الشاشات
        function switchScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId + 'Screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            if (screenId === 'purchases') {
                loadPurchases();
                loadSuppliers();
            } else if (screenId === 'reports') {
                // تحميل تقارير المبيعات افتراضياً
                generateSalesReport();
            } else if (screenId === 'inventory') {
                loadInventoryProducts();
            } else if (screenId === 'settings') {
                loadUsers();
                loadSettings();
            }
        }

        // تحميل المنتجات حسب الفئة
        function loadProductsByCategory(category) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            const products = productsData[category] || [];
            
            if (products.length === 0) {
                productGrid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد منتجات في هذه الفئة</p></div>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = product.stock <= 0 && !product.perPage ? 'product-card out-of-stock' : 'product-card';
                
                // إضافة معالج حدث للنقر على الكارت كله
                productCard.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (e.target.tagName !== 'BUTTON') {
                        if (product.perPage) {
                            // خدمات التصوير التي تحتاج اختيار عدد الصفحات
                            currentPrintingProduct = product;
                            document.getElementById('printingPagesCount').value = 1;
                            document.getElementById('printingTypeSelect').value = product.id;
                            updatePrintingPrice();
                            document.getElementById('printingPagesModal').style.display = 'flex';
                        } else {
                            // المنتجات العادية
                            addToCart(product.id);
                        }
                    }
                });
                
                let stockInfo = '';
                if (product.perPage || product.isService) {
                    stockInfo = '<div class="product-stock">لا حصر</div>';
                } else {
                    stockInfo = `<div class="product-stock">${product.stock} ${product.unit}</div>`;
                }
                
                let clickInfo = '';
                if (product.perPage) {
                    clickInfo = '<div style="font-size: 11px; color: var(--primary-orange); margin-top: 5px;"><i class="fas fa-print"></i> اضغط لاختيار عدد الصفحات</div>';
                } else if (product.stock <= 0 && !product.isService) {
                    clickInfo = '<div class="out-of-stock-message"><i class="fas fa-times-circle"></i> غير متوفر</div>';
                } else {
                    clickInfo = '<div style="font-size: 11px; color: var(--primary-orange); margin-top: 5px;"><i class="fas fa-cart-plus"></i> اضغط لإضافة</div>';
                }
                
                productCard.innerHTML = `
                    <div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price.toFixed(2)} جنيه</div>
                        ${stockInfo}
                    </div>
                    ${clickInfo}
                `;
                
                productGrid.appendChild(productCard);
            });
        }

        // تأكيد إضافة التصوير
        function confirmPrinting() {
            const pages = parseInt(document.getElementById('printingPagesCount').value) || 1;
            
            if (pages < 1) {
                alert('يرجى إدخال عدد صفحات صحيح');
                return;
            }
            
            if (currentPrintingProduct) {
                // إضافة المنتج مع الكمية المحددة
                const existingItem = cart.find(item => item.id === currentPrintingProduct.id);
                
                if (existingItem) {
                    // زيادة الكمية الموجودة
                    existingItem.quantity += pages;
                } else {
                    // إضافة منتج جديد للسلة
                    cart.push({
                        ...currentPrintingProduct,
                        quantity: pages,
                        salePrice: currentPrintingProduct.price,
                        name: `${currentPrintingProduct.name} (${pages} صفحة)`
                    });
                }
                
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
                
                // إغلاق المودال
                document.getElementById('printingPagesModal').style.display = 'none';
                currentPrintingProduct = null;
            }
        }

        // إضافة منتج للسلة
        function addToCart(productId) {
            if (this.processing) return;
            this.processing = true;
            
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (!product) {
                alert('المنتج غير موجود');
                this.processing = false;
                return;
            }
            
            if (product.stock <= 0 && !product.perPage && !product.isService) {
                alert('هذا المنتج غير متوفر في المخزون');
                this.processing = false;
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId && !item.name.includes('('));
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1,
                    salePrice: product.price
                });
            }
            
            updateCartDisplay();
            localStorage.setItem('storeCart', JSON.stringify(cart));
            
            setTimeout(() => {
                this.processing = false;
            }, 100);
        }

        // تحديث عرض السلة
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const emptyCartMessage = document.getElementById('emptyCartMessage');
            const totalItems = document.getElementById('totalItems');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="text-center p-10" id="emptyCartMessage"><i class="fas fa-shopping-cart fa-lg" style="color: #ddd; margin-bottom: 8px;"></i><p style="font-size: 13px;">السلة فارغة</p><p style="color: #777; font-size: 11px;">قم بإضافة منتجات من القائمة</p></div>';
                totalItems.textContent = '0';
                updateTotals();
                return;
            }
            
            if (emptyCartMessage) emptyCartMessage.remove();
            
            let itemsHTML = '';
            let itemCount = 0;
            
            cart.forEach((item, index) => {
                itemCount += item.quantity;
                const itemTotal = item.salePrice * item.quantity;
                
                itemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${item.salePrice.toFixed(2)} × ${item.quantity} = ${itemTotal.toFixed(2)} جنيه</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="quantity-btn decrease" onclick="changeQuantity(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="item-quantity">${item.quantity}</span>
                            <button class="quantity-btn increase" onclick="changeQuantity(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = itemsHTML;
            totalItems.textContent = itemCount;
            updateTotals();
        }

        // تحديث الإجماليات
        function updateTotals() {
            const subtotalElement = document.getElementById('subtotal');
            const discountAmountElement = document.getElementById('discountAmount');
            const totalAmountElement = document.getElementById('totalAmount');
            
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            
            let discountAmount = 0;
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
            } else {
                discountAmount = discount.value;
            }
            
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            const total = subtotal - discountAmount;
            
            subtotalElement.textContent = subtotal.toFixed(2) + ' جنيه';
            discountAmountElement.textContent = discountAmount.toFixed(2) + ' جنيه';
            totalAmountElement.textContent = total.toFixed(2) + ' جنيه';
        }

        // تطبيق الخصم
        function applyDiscount() {
            const discountInput = document.getElementById('discountInput');
            discount.value = parseFloat(discountInput.value) || 0;
            updateTotals();
        }

        // تغيير كمية المنتج
        function changeQuantity(index, change) {
            if (cart[index]) {
                const newQuantity = cart[index].quantity + change;
                
                if (newQuantity <= 0) {
                    cart.splice(index, 1);
                } else {
                    cart[index].quantity = newQuantity;
                }
                
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
            }
        }

        // إزالة منتج من السلة
        function removeFromCart(index) {
            if (cart[index]) {
                cart.splice(index, 1);
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
            }
        }

        // تفريغ السلة
        function clearCart() {
            if (cart.length === 0) {
                alert('السلة فارغة بالفعل');
                return;
            }
            
            if (confirm('هل أنت متأكد من تفريغ السلة؟ سيتم حذف جميع العناصر.')) {
                cart = [];
                updateCartDisplay();
                localStorage.setItem('storeCart', JSON.stringify(cart));
            }
        }

        // عرض فاتورة البيع
        function showReceiptModal() {
            if (cart.length === 0) {
                alert('السلة فارغة، لا يمكن إتمام البيع');
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            let discountAmount = 0;
            
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
            } else {
                discountAmount = discount.value;
            }
            
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            const total = subtotal - discountAmount;
            
            const invoiceNumber = `INV-${new Date().getFullYear()}-${invoiceCounter.toString().padStart(4, '0')}`;
            
            let receiptHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار المكتبة" class="receipt-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=LOGO'">
                        <div class="receipt-title">مكتبة صب واي</div>
                        <div>رقم الفاتورة: ${invoiceNumber}</div>
                        <div>التاريخ: ${formatDate(new Date())}</div>
                        <div>الوقت: ${formatTime(new Date())}</div>
                        <div>طريقة الدفع: ${paymentMethod === 'cash' ? 'نقدي' : 'فيزا'}</div>
                    </div>
                    
                    <table class="receipt-items">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            cart.forEach(item => {
                const itemTotal = item.salePrice * item.quantity;
                receiptHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.salePrice.toFixed(2)}</td>
                        <td>${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            receiptHTML += `
                        </tbody>
                    </table>
                    
                    <div class="receipt-totals">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>الإجمالي:</span>
                            <span>${subtotal.toFixed(2)} جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>الخصم:</span>
                            <span>${discountAmount.toFixed(2)} جنيه</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; font-weight: bold; border-top: 1px solid #ddd; padding-top: 6px;">
                            <span>المبلغ المستحق:</span>
                            <span>${total.toFixed(2)} جنيه</span>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p>شكراً لزيارتكم مكتبة صب واي</p>
                        <p>رقم الهاتف: 0100-123-4567</p>
                        <p style="font-size: 11px; color: #777;">جميع الحقوق محفوظة © 2025</p>
                    </div>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = receiptHTML;
            document.getElementById('completeSaleModal').style.display = 'flex';
        }

        // حفظ الفاتورة
        function saveReceipt() {
            completeSale(false);
            alert('تم حفظ الفاتورة بنجاح');
        }

        // حفظ وطباعة الفاتورة
        function saveAndPrintReceipt() {
            completeSale(true);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة فاتورة - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 20px; }
                        .receipt { width: 80mm; margin: 0 auto; }
                        .text-center { text-align: center; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 5px; border-bottom: 1px solid #ddd; }
                        .total { font-weight: bold; font-size: 16px; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="text-center">
                            <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار المكتبة" class="receipt-logo">
                            <h3>مكتبة صب واي</h3>
                            <p>فاتورة بيع</p>
                        </div>
                        ${document.getElementById('receiptContent').innerHTML}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // إتمام عملية البيع
        function completeSale(shouldPrint = false) {
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            let discountAmount = 0;
            
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
            } else {
                discountAmount = discount.value;
            }
            
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }
            
            const total = subtotal - discountAmount;
            
            // تحديث إحصائيات الشيفت
            if (paymentMethod === 'cash') {
                currentShift.cashTotal += total;
            } else {
                currentShift.cardTotal += total;
            }
            
            currentShift.totalSales += total;
            currentShift.itemsSold = [...currentShift.itemsSold, ...cart.map(item => ({
                ...item,
                saleDate: new Date()
            }))];
            
            // حفظ عملية البيع في السجلات
            const sales = JSON.parse(localStorage.getItem('storeSales')) || defaultSales;
            const newSale = {
                id: saleCounter,
                invoiceNumber: `INV-${new Date().getFullYear()}-${invoiceCounter.toString().padStart(4, '0')}`,
                date: new Date().toISOString().split('T')[0],
                paymentMethod,
                itemsCount: cart.reduce((sum, item) => sum + item.quantity, 0),
                subtotal,
                discount: discountAmount,
                total,
                userId: currentUser ? currentUser.id : 1,
                userName: currentUser ? currentUser.name : 'نظام'
            };
            
            sales.push(newSale);
            localStorage.setItem('storeSales', JSON.stringify(sales));
            saleCounter++;
            localStorage.setItem('saleCounter', saleCounter.toString());
            
            updateInventoryAfterSale();
            
            localStorage.setItem('storeShift', JSON.stringify(currentShift));
            
            invoiceCounter++;
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            document.getElementById('completeSaleModal').style.display = 'none';
            
            cart = [];
            updateCartDisplay();
            localStorage.setItem('storeCart', JSON.stringify(cart));
            
            discount.value = 0;
            document.getElementById('discountInput').value = '';
            updateTotals();
        }

        // تحديث المخزون بعد البيع
        function updateInventoryAfterSale() {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            cart.forEach(cartItem => {
                for (const category in productsData) {
                    const product = productsData[category].find(p => p.id === cartItem.id);
                    if (product && !product.perPage && !product.isService) {
                        product.stock = Math.max(0, product.stock - cartItem.quantity);
                        // تحديث عدد الحركات
                        if (!product.transactionCount) product.transactionCount = 0;
                        product.transactionCount++;
                        break;
                    }
                }
            });
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
        }

        // عرض مودال إغلاق الشيفت
        function showCloseShiftModal() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') {
                alert('عفواً، هذه الميزة متاحة فقط للمدير والمشرف');
                return;
            }
            
            const now = new Date();
            document.getElementById('shiftDate').textContent = formatDate(now);
            document.getElementById('shiftTime').textContent = formatTime(now);
            document.getElementById('shiftUser').textContent = currentUser.name;
            document.getElementById('shiftOpenTime').textContent = formatTime(currentShift.openTime);
            document.getElementById('shiftCashTotal').textContent = currentShift.cashTotal.toFixed(2) + ' جنيه';
            document.getElementById('shiftCardTotal').textContent = currentShift.cardTotal.toFixed(2) + ' جنيه';
            document.getElementById('shiftTotalSales').textContent = currentShift.totalSales.toFixed(2) + ' جنيه';
            document.getElementById('shiftItemsCount').textContent = currentShift.itemsSold.length;
            
            const shiftItemsBody = document.getElementById('shiftItemsBody');
            shiftItemsBody.innerHTML = '';
            
            const itemSummary = {};
            currentShift.itemsSold.forEach(item => {
                if (!itemSummary[item.id]) {
                    itemSummary[item.id] = {
                        name: item.name,
                        quantity: 0,
                        total: 0
                    };
                }
                itemSummary[item.id].quantity += item.quantity;
                itemSummary[item.id].total += item.salePrice * item.quantity;
            });
            
            for (const id in itemSummary) {
                const item = itemSummary[id];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.total.toFixed(2)}</td>
                `;
                shiftItemsBody.appendChild(row);
            }
            
            document.getElementById('closeShiftModal').style.display = 'flex';
        }

        // طباعة تقرير الشيفت
        function printShiftReport() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة تقرير الشيفت - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; padding: 20px; }
                        .receipt { width: 100%; }
                        .text-center { text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { padding: 8px; border: 1px solid #ddd; }
                        .total { font-weight: bold; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('closeShiftContent').innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // حفظ تقرير الشيفت
        function saveShiftReport() {
            // حفظ الشيفت في السجلات
            const shifts = JSON.parse(localStorage.getItem('storeShifts')) || defaultShifts;
            const now = new Date();
            
            const newShift = {
                id: shiftCounter,
                date: now.toISOString().split('T')[0],
                userId: currentUser.id,
                userName: currentUser.name,
                openTime: formatTime(currentShift.openTime),
                closeTime: formatTime(now),
                cashTotal: currentShift.cashTotal,
                cardTotal: currentShift.cardTotal,
                totalSales: currentShift.totalSales,
                itemsSold: currentShift.itemsSold.length
            };
            
            shifts.push(newShift);
            localStorage.setItem('storeShifts', JSON.stringify(shifts));
            shiftCounter++;
            localStorage.setItem('shiftCounter', shiftCounter.toString());
            
            alert('تم حفظ تقرير الشيفت بنجاح');
            
            // إعادة تعيين الشيفت الحالي
            currentShift = {
                openTime: new Date(),
                cashTotal: 0,
                cardTotal: 0,
                totalSales: 0,
                itemsSold: []
            };
            
            localStorage.setItem('storeShift', JSON.stringify(currentShift));
            
            document.getElementById('closeShiftModal').style.display = 'none';
        }

        // تحميل المشتريات
        function loadPurchases() {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const tableBody = document.getElementById('purchasesTableBody');
            
            if (purchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد مشتريات مسجلة</td></tr>';
                return;
            }
            
            let html = '';
            purchases.forEach(purchase => {
                html += `
                    <tr>
                        <td>${purchase.invoiceNumber || 'بدون رقم'}</td>
                        <td>${purchase.date}</td>
                        <td>${purchase.supplierName}</td>
                        <td>${purchase.items.length}</td>
                        <td>${purchase.total.toFixed(2)} جنيه</td>
                        <td>
                            <span class="btn btn-sm ${purchase.paymentStatus === 'paid' ? 'btn-success' : 'btn-warning'}" style="padding: 3px 8px;">
                                ${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewPurchase(${purchase.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editPurchase(${purchase.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePurchase(${purchase.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            updateSupplierFilter();
        }

        // تحميل الموردين
        function loadSuppliers() {
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const grid = document.getElementById('suppliersGrid');
            
            if (suppliers.length === 0) {
                grid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد موردين مسجلين</p></div>';
                return;
            }
            
            let html = '';
            suppliers.forEach(supplier => {
                const canDelete = !hasSupplierTransactions(supplier.id);
                const deleteBtnClass = canDelete ? 'btn-danger' : 'btn-danger btn-disabled';
                const deleteBtnTitle = canDelete ? '' : 'لا يمكن حذف المورد بسبب وجود حركات';
                
                html += `
                    <div class="supplier-card">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-info">
                            <strong>الهاتف:</strong> ${supplier.phone}
                        </div>
                        ${supplier.email ? `<div class="supplier-info"><strong>البريد الإلكتروني:</strong> ${supplier.email}</div>` : ''}
                        ${supplier.location ? `<div class="supplier-info"><strong>الموقع:</strong> ${supplier.location}</div>` : ''}
                        ${supplier.notes ? `<div class="supplier-info"><strong>ملاحظات:</strong> ${supplier.notes}</div>` : ''}
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn btn-warning btn-sm" onclick="editSupplier(${supplier.id})" style="flex: 1;">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn ${deleteBtnClass} btn-sm" onclick="${canDelete ? `deleteSupplier(${supplier.id})` : 'alert(\'لا يمكن حذف المورد بسبب وجود حركات مرتبطة به\')'}" style="flex: 1;" title="${deleteBtnTitle}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            updateSupplierSelect();
        }

        // التحقق من وجود حركات للمورد
        function hasSupplierTransactions(supplierId) {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            return purchases.some(purchase => purchase.supplierId == supplierId);
        }

        // تحديث قائمة الموردين في الفلتر والنموذج
        function updateSupplierFilter() {
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const filterSelect = document.getElementById('filterSupplier');
            const purchaseSelect = document.getElementById('purchaseSupplier');
            
            let filterOptions = '<option value="">جميع الموردين</option>';
            let purchaseOptions = '<option value="">اختر المورد</option>';
            
            suppliers.forEach(supplier => {
                filterOptions += `<option value="${supplier.id}">${supplier.name}</option>`;
                purchaseOptions += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
            
            filterSelect.innerHTML = filterOptions;
            purchaseSelect.innerHTML = purchaseOptions;
        }

        // تصفية المشتريات
        function filterPurchases() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const supplierId = document.getElementById('filterSupplier').value;
            const paymentStatus = document.getElementById('filterPaymentStatus').value;
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            let filteredPurchases = [...purchases];
            
            if (fromDate) {
                filteredPurchases = filteredPurchases.filter(p => p.date >= fromDate);
            }
            
            if (toDate) {
                filteredPurchases = filteredPurchases.filter(p => p.date <= toDate);
            }
            
            if (supplierId) {
                filteredPurchases = filteredPurchases.filter(p => p.supplierId == supplierId);
            }
            
            if (paymentStatus) {
                filteredPurchases = filteredPurchases.filter(p => p.paymentStatus === paymentStatus);
            }
            
            const tableBody = document.getElementById('purchasesTableBody');
            
            if (filteredPurchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد مشتريات تطابق معايير البحث</td></tr>';
                return;
            }
            
            let html = '';
            filteredPurchases.forEach(purchase => {
                html += `
                    <tr>
                        <td>${purchase.invoiceNumber || 'بدون رقم'}</td>
                        <td>${purchase.date}</td>
                        <td>${purchase.supplierName}</td>
                        <td>${purchase.items.length}</td>
                        <td>${purchase.total.toFixed(2)} جنيه</td>
                        <td>
                            <span class="btn btn-sm ${purchase.paymentStatus === 'paid' ? 'btn-success' : 'btn-warning'}" style="padding: 3px 8px;">
                                ${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-info btn-sm" onclick="viewPurchase(${purchase.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editPurchase(${purchase.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePurchase(${purchase.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // إعادة تعيين تصفية المشتريات
        function resetPurchasesFilter() {
            document.getElementById('filterFromDate').value = '';
            document.getElementById('filterToDate').value = '';
            document.getElementById('filterSupplier').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            
            loadPurchases();
        }

        // البحث عن موردين
        function searchSuppliers() {
            const searchTerm = document.getElementById('searchSupplier').value.toLowerCase();
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const grid = document.getElementById('suppliersGrid');
            
            if (!searchTerm) {
                loadSuppliers();
                return;
            }
            
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) || 
                supplier.phone.includes(searchTerm)
            );
            
            if (filteredSuppliers.length === 0) {
                grid.innerHTML = '<div class="text-center p-10"><p style="font-size: 13px;">لا توجد موردين تطابق معايير البحث</p></div>';
                return;
            }
            
            let html = '';
            filteredSuppliers.forEach(supplier => {
                const canDelete = !hasSupplierTransactions(supplier.id);
                const deleteBtnClass = canDelete ? 'btn-danger' : 'btn-danger btn-disabled';
                const deleteBtnTitle = canDelete ? '' : 'لا يمكن حذف المورد بسبب وجود حركات';
                
                html += `
                    <div class="supplier-card">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-info">
                            <strong>الهاتف:</strong> ${supplier.phone}
                        </div>
                        ${supplier.email ? `<div class="supplier-info"><strong>البريد الإلكتروني:</strong> ${supplier.email}</div>` : ''}
                        ${supplier.location ? `<div class="supplier-info"><strong>الموقع:</strong> ${supplier.location}</div>` : ''}
                        ${supplier.notes ? `<div class="supplier-info"><strong>ملاحظات:</strong> ${supplier.notes}</div>` : ''}
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn btn-warning btn-sm" onclick="editSupplier(${supplier.id})" style="flex: 1;">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn ${deleteBtnClass} btn-sm" onclick="${canDelete ? `deleteSupplier(${supplier.id})` : 'alert(\'لا يمكن حذف المورد بسبب وجود حركات مرتبطة به\')'}" style="flex: 1;" title="${deleteBtnTitle}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // عرض مودال إضافة/تعديل شراء
        function showPurchaseModal(purchaseId = null) {
            currentPurchaseItems = [];
            selectedProduct = null;
            const modal = document.getElementById('purchaseModal');
            const title = document.getElementById('purchaseModalTitle');
            const today = new Date().toISOString().split('T')[0];
            
            // إعادة تعيين حقول البحث
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productInfo').style.display = 'none';
            document.getElementById('productQuantity').value = 1;
            document.getElementById('productCost').value = '';
            document.getElementById('productSalePrice').value = '';
            document.getElementById('productUnit').value = 'حبة';
            
            if (purchaseId) {
                // وضع التعديل
                currentEditingPurchaseId = purchaseId;
                title.textContent = 'تعديل بيانات الشراء';
                
                // تحميل بيانات الشراء الحالية
                const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
                const purchase = purchases.find(p => p.id === purchaseId);
                
                if (purchase) {
                    document.getElementById('purchaseInvoiceNumber').value = purchase.invoiceNumber || '';
                    document.getElementById('purchaseDate').value = purchase.date;
                    document.getElementById('purchaseSupplier').value = purchase.supplierId;
                    document.getElementById('purchasePaymentMethod').value = purchase.paymentMethod;
                    document.getElementById('purchaseNotes').value = purchase.notes || '';
                    
                    currentPurchaseItems = [...purchase.items];
                    updatePurchaseItemsTable();
                }
                
                document.getElementById('savePurchaseBtn').style.display = 'none';
                document.getElementById('updatePurchaseBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingPurchaseId = null;
                title.textContent = 'إضافة شراء جديد';
                
                document.getElementById('purchaseInvoiceNumber').value = '';
                document.getElementById('purchaseDate').value = today;
                document.getElementById('purchaseSupplier').value = '';
                document.getElementById('purchasePaymentMethod').value = 'cash';
                document.getElementById('purchaseNotes').value = '';
                
                document.getElementById('purchaseItemsTable').innerHTML = '';
                document.getElementById('purchaseTotal').textContent = '0.00 جنيه';
                
                document.getElementById('savePurchaseBtn').style.display = 'block';
                document.getElementById('updatePurchaseBtn').style.display = 'none';
            }
            
            updateSupplierSelect();
            modal.style.display = 'flex';
            
            // تركيز على حقل البحث
            setTimeout(() => {
                document.getElementById('productSearchInput').focus();
            }, 100);
        }

        // إضافة منتج إلى قائمة مشتريات
        function addProductToPurchase() {
            const quantity = document.getElementById('productQuantity').value;
            const cost = document.getElementById('productCost').value;
            const salePrice = document.getElementById('productSalePrice').value;
            const unit = document.getElementById('productUnit').value;
            
            if (!selectedProduct) {
                alert('يرجى اختيار منتج أولاً');
                document.getElementById('productSearchInput').focus();
                return;
            }
            
            if (!quantity || !cost || !salePrice) {
                alert('يرجى ملء جميع بيانات المنتج');
                return;
            }
            
            const productId = selectedProduct.id;
            const productName = selectedProduct.name;
            const quantityNum = parseInt(quantity);
            const costNum = parseFloat(cost);
            const salePriceNum = parseFloat(salePrice);
            const total = quantityNum * costNum;
            
            // التحقق من عدم إضافة نفس المنتج بنفس السعر (يسمح بإضافة نفس المنتج بأسعار مختلفة)
            const existingItemIndex = currentPurchaseItems.findIndex(item => 
                item.productId === productId && 
                item.cost === costNum && 
                item.salePrice === salePriceNum &&
                item.unit === unit
            );
            
            if (existingItemIndex !== -1) {
                currentPurchaseItems[existingItemIndex].quantity += quantityNum;
                currentPurchaseItems[existingItemIndex].total += total;
            } else {
                currentPurchaseItems.push({
                    productId,
                    name: productName,
                    quantity: quantityNum,
                    cost: costNum,
                    salePrice: salePriceNum,
                    unit,
                    total
                });
            }
            
            updatePurchaseItemsTable();
            
            // إعادة تعيين الحقول
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productInfo').style.display = 'none';
            document.getElementById('productQuantity').value = 1;
            document.getElementById('productCost').value = '';
            document.getElementById('productSalePrice').value = '';
            document.getElementById('productUnit').value = 'حبة';
            selectedProduct = null;
            
            // تركيز على حقل البحث
            document.getElementById('productSearchInput').focus();
        }

        // تحديث جدول عناصر المشتريات
        function updatePurchaseItemsTable() {
            const table = document.getElementById('purchaseItemsTable');
            const totalElement = document.getElementById('purchaseTotal');
            
            if (currentPurchaseItems.length === 0) {
                table.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد عناصر مضافة</td></tr>';
                totalElement.textContent = '0.00 جنيه';
                return;
            }
            
            let html = '';
            let total = 0;
            
            currentPurchaseItems.forEach((item, index) => {
                total += item.total;
                const canDelete = !hasProductTransactions(item.productId);
                const deleteBtnClass = canDelete ? 'btn-danger' : 'btn-danger btn-disabled';
                const deleteBtnTitle = canDelete ? '' : 'لا يمكن حذف المنتج بسبب وجود حركات';
                
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.cost.toFixed(2)}</td>
                        <td>${item.salePrice.toFixed(2)}</td>
                        <td>${item.unit}</td>
                        <td>${item.total.toFixed(2)}</td>
                        <td>
                            <button class="btn ${deleteBtnClass} btn-sm" onclick="${canDelete ? `removePurchaseItem(${index})` : 'alert(\'لا يمكن حذف المنتج بسبب وجود حركات مرتبطة به\')'}" title="${deleteBtnTitle}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
            totalElement.textContent = total.toFixed(2) + ' جنيه';
        }

        // التحقق من وجود حركات للمنتج
        function hasProductTransactions(productId) {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            // التحقق من وجود المنتج في المشتريات
            for (const purchase of purchases) {
                if (purchase.items.some(item => item.productId === productId)) {
                    return true;
                }
            }
            
            // التحقق من وجود حركات بيع للمنتج
            for (const category in productsData) {
                const product = productsData[category].find(p => p.id === productId);
                if (product && product.transactionCount && product.transactionCount > 0) {
                    return true;
                }
            }
            
            return false;
        }

        // حذف عنصر من قائمة المشتريات
        function removePurchaseItem(index) {
            currentPurchaseItems.splice(index, 1);
            updatePurchaseItemsTable();
        }

        // حفظ الشراء
        function savePurchase() {
            const invoiceNumber = document.getElementById('purchaseInvoiceNumber').value.trim();
            const date = document.getElementById('purchaseDate').value;
            const supplierId = document.getElementById('purchaseSupplier').value;
            const paymentMethod = document.getElementById('purchasePaymentMethod').value;
            const notes = document.getElementById('purchaseNotes').value.trim();
            
            if (!date || !supplierId || currentPurchaseItems.length === 0) {
                alert('يرجى ملء جميع الحقول المطلوبة وإضافة منتجات على الأقل');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplier = suppliers.find(s => s.id == supplierId);
            
            if (!supplier) {
                alert('المورد المحدد غير موجود');
                return;
            }
            
            const purchase = {
                id: purchaseCounter,
                invoiceNumber: invoiceNumber || null,
                date,
                supplierId: parseInt(supplierId),
                supplierName: supplier.name,
                items: [...currentPurchaseItems],
                total: currentPurchaseItems.reduce((sum, item) => sum + item.total, 0),
                paymentMethod,
                paymentStatus: paymentMethod === 'cash' ? 'paid' : 'pending',
                notes: notes || null
            };
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            purchases.push(purchase);
            
            updateInventoryAfterPurchase(purchase);
            
            localStorage.setItem('storePurchases', JSON.stringify(purchases));
            purchaseCounter++;
            localStorage.setItem('purchaseCounter', purchaseCounter.toString());
            
            alert('تم حفظ الشراء بنجاح');
            document.getElementById('purchaseModal').style.display = 'none';
            loadPurchases();
        }

        // تحديث الشراء
        function updatePurchase() {
            if (!currentEditingPurchaseId) {
                alert('لا يوجد شراء للتحديث');
                return;
            }
            
            const invoiceNumber = document.getElementById('purchaseInvoiceNumber').value.trim();
            const date = document.getElementById('purchaseDate').value;
            const supplierId = document.getElementById('purchaseSupplier').value;
            const paymentMethod = document.getElementById('purchasePaymentMethod').value;
            const notes = document.getElementById('purchaseNotes').value.trim();
            
            if (!date || !supplierId || currentPurchaseItems.length === 0) {
                alert('يرجى ملء جميع الحقول المطلوبة وإضافة منتجات على الأقل');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplier = suppliers.find(s => s.id == supplierId);
            
            if (!supplier) {
                alert('المورد المحدد غير موجود');
                return;
            }
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const purchaseIndex = purchases.findIndex(p => p.id === currentEditingPurchaseId);
            
            if (purchaseIndex === -1) {
                alert('الشراء غير موجود');
                return;
            }
            
            // استعادة المخزون القديم أولاً
            restoreInventoryBeforeUpdate(purchases[purchaseIndex]);
            
            // تحديث بيانات الشراء
            purchases[purchaseIndex] = {
                ...purchases[purchaseIndex],
                invoiceNumber: invoiceNumber || null,
                date,
                supplierId: parseInt(supplierId),
                supplierName: supplier.name,
                items: [...currentPurchaseItems],
                total: currentPurchaseItems.reduce((sum, item) => sum + item.total, 0),
                paymentMethod,
                paymentStatus: paymentMethod === 'cash' ? 'paid' : 'pending',
                notes: notes || null
            };
            
            // تحديث المخزون الجديد
            updateInventoryAfterPurchase(purchases[purchaseIndex]);
            
            localStorage.setItem('storePurchases', JSON.stringify(purchases));
            
            alert('تم تحديث الشراء بنجاح');
            document.getElementById('purchaseModal').style.display = 'none';
            loadPurchases();
        }

        // استعادة المخزون قبل التحديث
        function restoreInventoryBeforeUpdate(purchase) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            purchase.items.forEach(item => {
                for (const category in productsData) {
                    const product = productsData[category].find(p => p.id === item.productId);
                    if (product && !product.perPage) {
                        product.stock = Math.max(0, product.stock - item.quantity);
                        break;
                    }
                }
            });
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
        }

        // تحديث المخزون بعد الشراء
        function updateInventoryAfterPurchase(purchase) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            purchase.items.forEach(item => {
                let productFound = false;
                
                for (const category in productsData) {
                    const product = productsData[category].find(p => p.id === item.productId);
                    if (product) {
                        product.stock += item.quantity;
                        if (item.cost > 0) product.cost = item.cost;
                        if (item.salePrice > 0) product.price = item.salePrice;
                        if (item.unit) product.unit = item.unit;
                        // تحديث عدد الحركات
                        if (!product.transactionCount) product.transactionCount = 0;
                        product.transactionCount++;
                        productFound = true;
                        break;
                    }
                }
                
                if (!productFound) {
                    const newProduct = {
                        id: item.productId,
                        name: item.name,
                        price: item.salePrice,
                        cost: item.cost,
                        category: 'other',
                        stock: item.quantity,
                        unit: item.unit,
                        transactionCount: 1
                    };
                    
                    if (!productsData.other) productsData.other = [];
                    productsData.other.push(newProduct);
                }
            });
            
            localStorage.setItem('storeProducts', JSON.stringify(productsData));
        }

        // عرض مودال إضافة/تعديل مورد
        function showSupplierModal(supplierId = null) {
            const modal = document.getElementById('supplierModal');
            const title = document.getElementById('supplierModalTitle');
            
            if (supplierId) {
                // وضع التعديل
                currentEditingSupplierId = supplierId;
                title.textContent = 'تعديل بيانات المورد';
                
                const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
                const supplier = suppliers.find(s => s.id === supplierId);
                
                if (supplier) {
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('supplierPhone').value = supplier.phone;
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierLocation').value = supplier.location || '';
                    document.getElementById('supplierCommercialRegister').value = supplier.commercialRegister || '';
                    document.getElementById('supplierTaxNumber').value = supplier.taxNumber || '';
                    document.getElementById('supplierNotes').value = supplier.notes || '';
                }
                
                document.getElementById('saveSupplierBtn').style.display = 'none';
                document.getElementById('updateSupplierBtn').style.display = 'block';
            } else {
                // وضع الإضافة
                currentEditingSupplierId = null;
                title.textContent = 'إضافة مورد جديد';
                
                document.getElementById('supplierName').value = '';
                document.getElementById('supplierPhone').value = '';
                document.getElementById('supplierEmail').value = '';
                document.getElementById('supplierLocation').value = '';
                document.getElementById('supplierCommercialRegister').value = '';
                document.getElementById('supplierTaxNumber').value = '';
                document.getElementById('supplierNotes').value = '';
                
                document.getElementById('saveSupplierBtn').style.display = 'block';
                document.getElementById('updateSupplierBtn').style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // حفظ المورد
        function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const location = document.getElementById('supplierLocation').value.trim();
            const commercialRegister = document.getElementById('supplierCommercialRegister').value.trim();
            const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();
            
            if (!name || !phone) {
                alert('يرجى إدخال اسم المورد ورقم الهاتف');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const newSupplier = {
                id: supplierCounter,
                name,
                phone,
                email: email || null,
                location: location || null,
                commercialRegister: commercialRegister || null,
                taxNumber: taxNumber || null,
                notes: notes || null
            };
            
            suppliers.push(newSupplier);
            localStorage.setItem('storeSuppliers', JSON.stringify(suppliers));
            supplierCounter++;
            localStorage.setItem('supplierCounter', supplierCounter.toString());
            
            alert('تم حفظ المورد بنجاح');
            document.getElementById('supplierModal').style.display = 'none';
            loadSuppliers();
            updateSupplierSelect();
        }

        // تحديث المورد
        function updateSupplier() {
            if (!currentEditingSupplierId) {
                alert('لا يوجد مورد للتحديث');
                return;
            }
            
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const location = document.getElementById('supplierLocation').value.trim();
            const commercialRegister = document.getElementById('supplierCommercialRegister').value.trim();
            const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();
            
            if (!name || !phone) {
                alert('يرجى إدخال اسم المورد ورقم الهاتف');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplierIndex = suppliers.findIndex(s => s.id === currentEditingSupplierId);
            
            if (supplierIndex === -1) {
                alert('المورد غير موجود');
                return;
            }
            
            suppliers[supplierIndex] = {
                ...suppliers[supplierIndex],
                name,
                phone,
                email: email || null,
                location: location || null,
                commercialRegister: commercialRegister || null,
                taxNumber: taxNumber || null,
                notes: notes || null
            };
            
            localStorage.setItem('storeSuppliers', JSON.stringify(suppliers));
            
            alert('تم تحديث المورد بنجاح');
            document.getElementById('supplierModal').style.display = 'none';
            loadSuppliers();
            updateSupplierSelect();
        }

        // عرض فاتورة الشراء
        function viewPurchase(purchaseId) {
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const purchase = purchases.find(p => p.id === purchaseId);
            
            if (!purchase) {
                alert('الشراء غير موجود');
                return;
            }
            
            const receiptHTML = `
                <div class="receipt">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/d1hz1QM1/Final-Logo.png" alt="شعار المكتبة" class="receipt-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=LOGO'">
                        <div class="receipt-title">مكتبة صب واي</div>
                        <div>فاتورة شراء</div>
                        <div>رقم الفاتورة: ${purchase.invoiceNumber || 'بدون رقم'}</div>
                        <div>التاريخ: ${purchase.date}</div>
                        <div>المورد: ${purchase.supplierName}</div>
                        <div>طريقة الدفع: ${purchase.paymentMethod === 'cash' ? 'نقدي' : 'آجل'}</div>
                        <div>حالة الدفع: ${purchase.paymentStatus === 'paid' ? 'مدفوع' : 'معلق'}</div>
                    </div>
                    
                    <table class="receipt-items">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>سعر الشراء</th>
                                <th>سعر البيع</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${purchase.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity} ${item.unit}</td>
                                    <td>${item.cost.toFixed(2)}</td>
                                    <td>${item.salePrice.toFixed(2)}</td>
                                    <td>${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="receipt-totals">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span>إجمالي المشتريات:</span>
                            <span>${purchase.total.toFixed(2)} جنيه</span>
                        </div>
                        ${purchase.notes ? `
                            <div style="margin-top: 10px; padding: 10px; background-color: var(--light-gray); border-radius: 4px;">
                                <strong>ملاحظات:</strong> ${purchase.notes}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="receipt-footer">
                        <p>فاتورة شراء - نظام إدارة مكتبة صب واي</p>
                        <p style="font-size: 11px; color: #777;">تم الإنشاء: ${formatDate(new Date())} ${formatTime(new Date())}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('purchaseReceiptContent').innerHTML = receiptHTML;
            document.getElementById('purchaseReceiptModal').style.display = 'flex';
        }

        // طباعة فاتورة الشراء
        function printPurchaseReceipt() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة فاتورة شراء - مكتبة صب واي</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 20px; }
                        .receipt { width: 80mm; margin: 0 auto; }
                        .text-center { text-align: center; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 5px; border-bottom: 1px solid #ddd; }
                        .total { font-weight: bold; font-size: 16px; }
                        .receipt-logo { width: 40px; height: 40px; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('purchaseReceiptContent').innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // تعديل شراء
        function editPurchase(purchaseId) {
            showPurchaseModal(purchaseId);
        }

        // حذف شراء
        function deletePurchase(purchaseId) {
            if (!confirm('هل أنت متأكد من حذف هذا الشراء؟')) {
                return;
            }
            
            const purchases = JSON.parse(localStorage.getItem('storePurchases')) || defaultPurchases;
            const purchaseIndex = purchases.findIndex(p => p.id === purchaseId);
            
            if (purchaseIndex === -1) {
                alert('الشراء غير موجود');
                return;
            }
            
            // استعادة المخزون
            restoreInventoryBeforeUpdate(purchases[purchaseIndex]);
            
            purchases.splice(purchaseIndex, 1);
            localStorage.setItem('storePurchases', JSON.stringify(purchases));
            
            alert('تم حذف الشراء بنجاح');
            loadPurchases();
        }

        // تعديل مورد
        function editSupplier(supplierId) {
            showSupplierModal(supplierId);
        }

        // حذف مورد
        function deleteSupplier(supplierId) {
            if (!confirm('هل أنت متأكد من حذف هذا المورد؟')) {
                return;
            }
            
            if (hasSupplierTransactions(supplierId)) {
                alert('لا يمكن حذف المورد بسبب وجود حركات مرتبطة به');
                return;
            }
            
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const supplierIndex = suppliers.findIndex(s => s.id === supplierId);
            
            if (supplierIndex === -1) {
                alert('المورد غير موجود');
                return;
            }
            
            suppliers.splice(supplierIndex, 1);
            localStorage.setItem('storeSuppliers', JSON.stringify(suppliers));
            
            alert('تم حذف المورد بنجاح');
            loadSuppliers();
            updateSupplierSelect();
        }

        // عرض المستخدم
        function viewUser(userId) {
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                alert('المستخدم غير موجود');
                return;
            }
            
            const roleText = user.role === 'admin' ? 'مدير' : 
                           user.role === 'supervisor' ? 'مشرف' : 'بائع';
            const statusText = user.status === 'active' ? 'نشط' : 'غير نشط';
            
            alert(`
                معلومات المستخدم:
                اسم المستخدم: ${user.username}
                الاسم الكامل: ${user.name}
                الدور: ${roleText}
                حالة الحساب: ${statusText}
                البريد الإلكتروني: ${user.email || 'غير محدد'}
                رقم الهاتف: ${user.phone || 'غير محدد'}
                تاريخ الإنشاء: ${user.createdDate}
                آخر دخول: ${user.lastLogin || 'لم يسجل دخول'}
            `);
        }

        // تعديل مستخدم
        function editUser(userId) {
            showUserModal(userId);
        }

        // حذف مستخدم
        function deleteUser(userId) {
            if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                return;
            }
            
            // لا يمكن حذف المستخدم الحالي
            if (currentUser && currentUser.id === userId) {
                alert('لا يمكن حذف حسابك الخاص أثناء تسجيل الدخول');
                return;
            }
            
            // لا يمكن حذف المستخدم إذا كان المدير الوحيد
            const users = JSON.parse(localStorage.getItem('storeUsers')) || defaultUsers;
            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
                alert('المستخدم غير موجود');
                return;
            }
            
            const userToDelete = users[userIndex];
            
            // التحقق من وجود مديرين آخرين إذا كان المستخدم المدير
            if (userToDelete.role === 'admin') {
                const otherAdmins = users.filter(u => u.role === 'admin' && u.id !== userId);
                if (otherAdmins.length === 0) {
                    alert('لا يمكن حذف المدير الوحيد في النظام');
                    return;
                }
            }
            
            users.splice(userIndex, 1);
            localStorage.setItem('storeUsers', JSON.stringify(users));
            
            alert('تم حذف المستخدم بنجاح');
            loadUsers();
        }

        // عرض المنتج
        function viewProduct(productId) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (!product) {
                alert('المنتج غير موجود');
                return;
            }
            
            const categoryNames = {
                pens: 'أقلام',
                notebooks: 'دفاتر',
                office: 'أدوات مكتبية',
                envelopes: 'أظرف',
                papers: 'أوراق',
                printing: 'خدمات التصوير',
                other: 'أخرى'
            };
            
            const productType = product.isService ? 'خدمة' : 'منتج';
            const hasStock = product.isService || product.perPage ? 'لا حصر' : `${product.stock} ${product.unit}`;
            
            alert(`
                معلومات المنتج:
                اسم المنتج: ${product.name}
                النوع: ${productType}
                الفئة: ${categoryNames[product.category] || product.category}
                المخزون: ${hasStock}
                سعر الشراء: ${product.cost.toFixed(2)} جنيه
                سعر البيع: ${product.price.toFixed(2)} جنيه
                الوحدة: ${product.unit}
                حد إعادة الطلب: ${product.reorderLevel || 10}
                رمز المنتج: ${product.barcode || 'غير محدد'}
                عدد الحركات: ${product.transactionCount || 0}
                ملاحظات: ${product.notes || 'لا توجد'}
            `);
        }

        // تعديل المنتج
        function editProduct(productId) {
            showProductModal(productId);
        }

        // تعديل الفئة
        function editCategory(categoryId) {
            showCategoryModal(categoryId);
        }

        // حذف الفئة
        function deleteCategory(categoryId) {
            if (!confirm('هل أنت متأكد من حذف هذه الفئة؟ سيتم نقل منتجاتها إلى فئة "أخرى".')) {
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('storeCategories')) || defaultCategories;
            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            
            if (categoryIndex === -1) {
                alert('الفئة غير موجودة');
                return;
            }
            
            const categoryToDelete = categories[categoryIndex];
            
            // نقل منتجات هذه الفئة إلى فئة "أخرى"
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            
            if (productsData[categoryToDelete.name.toLowerCase()]) {
                // إنشاء فئة "أخرى" إذا لم تكن موجودة
                if (!productsData.other) {
                    productsData.other = [];
                }
                
                // نقل المنتجات
                const productsToMove = productsData[categoryToDelete.name.toLowerCase()];
                productsData.other = productsData.other.concat(productsToMove.map(p => ({
                    ...p,
                    category: 'other'
                })));
                
                // حذف الفئة القديمة
                delete productsData[categoryToDelete.name.toLowerCase()];
                
                localStorage.setItem('storeProducts', JSON.stringify(productsData));
            }
            
            // حذف الفئة من القائمة
            categories.splice(categoryIndex, 1);
            localStorage.setItem('storeCategories', JSON.stringify(categories));
            
            alert('تم حذف الفئة بنجاح وتم نقل منتجاتها إلى فئة "أخرى"');
            loadCategories();
            loadInventoryProducts();
        }

        // معالجة تسجيل الخروج
        function handleLogout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                currentUser = null;
                cart = [];
                
                document.getElementById('mainScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
                
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.style.display = 'flex';
                    item.classList.remove('active');
                });
                
                menuItems[0].classList.add('active');
            }
        }

        // تنسيق التاريخ
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // تنسيق الوقت
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // تحديث قائمة الموردين في select
        function updateSupplierSelect() {
            const suppliers = JSON.parse(localStorage.getItem('storeSuppliers')) || defaultSuppliers;
            const purchaseSelect = document.getElementById('purchaseSupplier');
            
            let options = '<option value="">اختر المورد</option>';
            
            suppliers.forEach(supplier => {
                options += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
            
            purchaseSelect.innerHTML = options;
        }

        // تحميل نسخة احتياطية
        function downloadBackup(index) {
            const backupFiles = JSON.parse(localStorage.getItem('backupFiles') || '[]');
            if (index >= backupFiles.length) {
                alert('ملف النسخة الاحتياطية غير موجود');
                return;
            }
            
            const backupFile = backupFiles[index];
            alert(`تحميل ملف النسخة الاحتياطية: ${backupFile.name}\nسيتم تنزيل الملف: ${backupFile.filename}`);
            // في تطبيق حقيقي، هنا سيكون كود لتحميل الملف الفعلي
        }

        // حذف نسخة احتياطية
        function deleteBackup(index) {
            if (!confirm('هل أنت متأكد من حذف هذه النسخة الاحتياطية؟')) {
                return;
            }
            
            const backupFiles = JSON.parse(localStorage.getItem('backupFiles') || '[]');
            if (index >= backupFiles.length) {
                alert('ملف النسخة الاحتياطية غير موجود');
                return;
            }
            
            backupFiles.splice(index, 1);
            localStorage.setItem('backupFiles', JSON.stringify(backupFiles));
            
            alert('تم حذف النسخة الاحتياطية');
            updateBackupFilesList();
        }

        // إنشاء طلب شراء لمنتج منخفض المخزون
        function createPurchaseOrder(productId) {
            const productsData = JSON.parse(localStorage.getItem('storeProducts')) || defaultProducts;
            let product = null;
            
            for (const category in productsData) {
                const foundProduct = productsData[category].find(p => p.id === productId);
                if (foundProduct) {
                    product = foundProduct;
                    break;
                }
            }
            
            if (!product) {
                alert('المنتج غير موجود');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('storeSettings')) || defaultSettings;
            const reorderLevel = product.reorderLevel || settings.system.defaultReorderLevel || 10;
            const quantityToOrder = reorderLevel * 2 - product.stock;
            
            if (quantityToOrder <= 0) {
                alert('المنتج ليس بحاجة إلى طلب شراء');
                return;
            }
            
            if (confirm(`هل تريد إنشاء طلب شراء للمنتج "${product.name}" بكمية ${quantityToOrder}؟`)) {
                alert(`تم إنشاء طلب شراء للمنتج "${product.name}" بكمية ${quantityToOrder}. سعر الشراء المقترح: ${product.cost.toFixed(2)} جنيه للواحدة.`);
                // هنا يمكن إضافة كود لحفظ طلب الشراء في قاعدة البيانات
            }
        }

        // جعل الدوال متاحة عالمياً
        window.addToCart = addToCart;
        window.changeQuantity = changeQuantity;
        window.removeFromCart = removeFromCart;
        window.viewPurchase = viewPurchase;
        window.editPurchase = editPurchase;
        window.deletePurchase = deletePurchase;
        window.editSupplier = editSupplier;
        window.deleteSupplier = deleteSupplier;
        window.removePurchaseItem = removePurchaseItem;
        window.viewUser = viewUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewProduct = viewProduct;
        window.editProduct = editProduct;
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.adjustInventory = adjustInventory;
        window.createPurchaseOrder = createPurchaseOrder;
        window.editPrice = editPrice;
    </script>
</body>
</html>
